This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
index.css
index.html
index.tsx
metadata.json
package.json
postcss.config.js
README.md
src/App.tsx
src/components/Icons.tsx
src/components/UI.tsx
src/constants.ts
src/context/AuthContext.tsx
src/context/DataContext.tsx
src/index.css
src/index.tsx
src/pages/Admin.tsx
src/pages/Dashboard.tsx
src/pages/Directory.tsx
src/pages/Export.tsx
src/pages/Login.tsx
src/pages/Reports.tsx
src/pages/Schedule.tsx
src/pages/Substitutions.tsx
src/services/db.ts
src/services/firebase.ts
src/tailwind.config.js
src/tsconfig.json
src/tsconfig.node.json
src/types.ts
src/vite-env.d.ts
src/vite.config.ts
tailwind.config.js
tsconfig.json
tsconfig.node.json
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?

.env
.env.local
</file>

<file path="index.html">
<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gymnasium Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Manrope', sans-serif; overscroll-behavior-y: none; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
      .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
      @media print {
        @page { margin: 0.5cm; }
        .no-print { display: none !important; }
        body { background: white; color: black; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react-router-dom": "https://aistudiocdn.com/react-router-dom@^7.9.6",
    "vite": "https://aistudiocdn.com/vite@^7.2.4",
    "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.1.1",
    "use-media": "https://aistudiocdn.com/use-media@^1.5.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "html2canvas": "https://aistudiocdn.com/html2canvas@^1.4.1",
    "jspdf": "https://aistudiocdn.com/jspdf@^3.0.4",
    "jspdf-autotable": "https://aistudiocdn.com/jspdf-autotable@^5.0.2",
    "qrcode.react": "https://aistudiocdn.com/qrcode.react@^4.2.0",
    "firebase/": "https://aistudiocdn.com/firebase@^12.6.0/"
  }
}
</script>
<link rel="stylesheet" href="/src/index.css">
<link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-slate-50 text-slate-900 dark:bg-dark-950 dark:text-slate-100 transition-colors duration-300">
    <div id="root"></div>
    <script type="module" src="/index.tsx"></script>
  </body>
</html>
</file>

<file path="index.tsx">
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './src/App'
import './src/index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)
</file>

<file path="metadata.json">
{
  "name": "Gymnasium Manager Pro18",
  "description": "A comprehensive school management system for scheduling, substitutions, and teacher administration.",
  "requestFramePermissions": []
}
</file>

<file path="postcss.config.js">
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
</file>

<file path="src/components/Icons.tsx">
import React from 'react';

// Using a dictionary for SVGs to keep code clean
const IconMap: Record<string, React.FC<React.SVGProps<SVGSVGElement>>> = {
    Home: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
    Calendar: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
    Repeat: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>,
    BookOpen: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
    Settings: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
    BarChart2: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
    Download: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
    Menu: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
    X: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
    Plus: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
    Trash2: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
    Edit2: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
    Users: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
    GraduationCap: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>,
    Clock: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
    CheckCircle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
    Sun: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>,
    Moon: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
    Search: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
    Filter: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
    RotateCcw: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>,
    RotateCw: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>,
    Printer: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
    Loader: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
    Share2: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>,
    AlertTriangle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
    Copy: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
    Clipboard: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>,
    PieChart: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>,
    List: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
    Gift: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>,
    Save: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
    FileSpreadsheet: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>,
    Activity: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>,
    TrendingUp: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
    Table: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-7z"/><path d="M3 9h18"/><path d="M12 21V9"/></svg>,
    Image: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
    Upload: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
    History: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>,
    UserX: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="18" y1="8" x2="23" y2="13"/><line x1="23" y1="8" x2="18" y2="13"/></svg>,
    ArrowRight: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
    Star: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
    GripVertical: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>,
    DoorOpen: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M13 4h3a2 2 0 0 1 2 2v14"/><path d="M2 20h3"/><path d="M13 20h9"/><path d="M10 20v-6a2 2 0 0 1 2-2h1v1"/><path d="M13 12h1"/><path d="M5 20v-6a2 2 0 0 1 2-2h1v1"/><path d="M8 12h1"/><path d="M4 20v-8a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v8"/></svg>,
    Bell: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
    Briefcase: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
    User: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
    CheckSquare: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>,
    QrCode: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><path d="M17 17h.01"/><path d="M12 17h.01"/><path d="M14 14h.01"/><path d="M17 14h.01"/><path d="M14 12h.01"/><path d="M19 12h.01"/><path d="M12 19h.01"/><path d="M19 19h.01"/></svg>,
    Eraser: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 21h-4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2zm-4-4L6 4m0 0a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h8"/></svg>,
    Columns: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3h8a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-8a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M2 3h8a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/></svg>,
    Rows: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12H3"/><path d="M21 6H3"/><path d="M21 18H3"/></svg>,
    Send: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
    LogOut: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
};

interface IconProps extends React.SVGProps<SVGSVGElement> {
    name: string;
    size?: number;
}

export const Icon: React.FC<IconProps> = ({ name, size = 24, className = "", ...props }) => {
    const Comp = IconMap[name]; 
    if (!Comp) {
        console.warn(`Icon '${name}' not found.`);
        return null;
    }
    return <Comp width={size} height={size} className={className} {...props} />;
};
</file>

<file path="src/components/UI.tsx">
import React, { useEffect, useState, useRef } from 'react';
import { Icon } from './Icons';
import { useStaticData } from '../context/DataContext'; 
import { DayOfWeek, Shift } from '../types';

export const Modal = ({ isOpen, onClose, title, children, maxWidth = 'max-w-lg' }: any) => {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in no-print">
            <div className={`bg-white dark:bg-dark-800 rounded-2xl shadow-2xl w-full ${maxWidth} flex flex-col max-h-[90vh] transition-colors duration-300`}>
                <div className="flex items-center justify-between px-6 py-5 border-b border-slate-100 dark:border-slate-700">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-white tracking-tight">{title}</h2>
                    <button onClick={onClose} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
                        <Icon name="X" size={24} />
                    </button>
                </div>
                <div className="p-6 overflow-y-auto custom-scrollbar">{children}</div>
            </div>
        </div>
    );
};

export const ContextMenu = ({ x, y, onClose, actions }: any) => {
    useEffect(() => {
        const handleClick = () => onClose();
        window.addEventListener('click', handleClick);
        return () => window.removeEventListener('click', handleClick);
    }, [onClose]);

    if (x === null || y === null) return null;

    const style: any = { top: y, left: x };
    if (window.innerWidth - x < 200) style.left = x - 200;

    return (
        <div className="fixed z-[100] bg-white dark:bg-slate-800 shadow-xl rounded-xl border border-slate-100 dark:border-slate-700 py-2 w-56 context-menu no-print" style={style}>
            {actions.map((action: any, i: number) => (
                <button key={i} onClick={(e) => { e.stopPropagation(); action.onClick(); onClose(); }} className={`w-full text-left px-4 py-2.5 text-sm font-bold flex items-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors ${action.color || 'text-slate-700 dark:text-slate-200'}`}>
                    {action.icon && <Icon name={action.icon} size={16} />}
                    {action.label}
                </button>
            ))}
        </div>
    );
};

export const StatusWidget = () => {
    const { bellSchedule } = useStaticData();
    const [status, setStatus] = useState("Загрузка...");
    const [details, setDetails] = useState("");
    const [progress, setProgress] = useState(0);
    const [color, setColor] = useState("bg-slate-500");
    const [currentDayName, setCurrentDayName] = useState("");

    useEffect(() => {
        const updateStatus = () => {
            const now = new Date();
            const dayIndex = now.getDay();
            const dayMap = [null, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday, DayOfWeek.Friday, null];
            const todayName = dayMap[dayIndex];
            setCurrentDayName(todayName || "Выходной");

            if (!todayName) {
                setStatus("Сегодня выходной");
                setDetails("Уроков нет");
                setColor("bg-slate-400");
                setProgress(0);
                return;
            }

            const minutesNow = now.getHours() * 60 + now.getMinutes();
            let dailyBells = bellSchedule.filter(b => b.day === todayName);
            if (dailyBells.length === 0) dailyBells = bellSchedule.filter(b => b.day === 'default');

            let activeLesson = null;
            const timeToMin = (t: string) => {
                const [h, m] = t.split(':').map(Number);
                return h * 60 + m;
            };

            for (const bell of dailyBells) {
                const start = timeToMin(bell.start);
                const end = timeToMin(bell.end);
                if (minutesNow >= start && minutesNow < end) {
                    activeLesson = { ...bell, duration: end - start, passed: minutesNow - start };
                    break;
                }
            }

            if (activeLesson) {
                setStatus(`${activeLesson.period} урок`);
                setDetails(`${activeLesson.shift === Shift.First ? '1 смена' : '2 смена'} • ост. ${activeLesson.duration - activeLesson.passed} мин`);
                setProgress((activeLesson.passed / activeLesson.duration) * 100);
                setColor("bg-indigo-600");
            } else {
                let minDiff = Infinity;
                let next = null;
                for (const bell of dailyBells) {
                    const start = timeToMin(bell.start);
                    if (start > minutesNow && (start - minutesNow) < minDiff) {
                        minDiff = start - minutesNow;
                        next = bell;
                    }
                }

                if (next && minDiff < 30) {
                    setStatus("Перемена");
                    setDetails(`через ${minDiff} мин ${next.period} урок`);
                    setColor("bg-amber-500");
                    setProgress(100 - (minDiff / 20 * 100));
                } else {
                    setStatus("Уроков нет");
                    setDetails("Свободное время");
                    setColor("bg-slate-400");
                    setProgress(0);
                }
            }
        };
        updateStatus();
        const interval = setInterval(updateStatus, 60000);
        return () => clearInterval(interval);
    }, [bellSchedule]); 

    return (
        <div className="mx-4 mt-auto mb-4 p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 flex flex-col gap-3 relative overflow-hidden group">
            <div className={`absolute top-0 left-0 w-1 h-full ${color}`}></div>
            <div className="flex justify-between items-start z-10">
                <div>
                    <div className="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-0.5">{currentDayName}</div>
                    <div className="text-lg font-black text-slate-800 dark:text-white leading-none mb-1">{status}</div>
                    <div className="text-xs font-medium text-slate-500 dark:text-slate-400">{details}</div>
                </div>
                <div className={`w-8 h-8 rounded-full ${color} bg-opacity-10 dark:bg-opacity-20 flex items-center justify-center text-${color.replace('bg-', '')}`}>
                    <Icon name="Clock" size={16} className={color.replace('bg-', 'text-')} />
                </div>
            </div>
            {progress > 0 && (
                <div className="w-full h-1.5 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden mt-1">
                    <div className={`h-full ${color} transition-all duration-1000`} style={{ width: `${progress}%` }}></div>
                </div>
            )}
        </div>
    );
};

export const SearchableSelect = ({ options, value, onChange, placeholder, groupBy }: any) => {
    const [isOpen, setIsOpen] = useState(false);
    const [search, setSearch] = useState("");
    const ref = useRef<HTMLDivElement>(null);

    useEffect(() => {
        const handleClickOutside = (event: MouseEvent) => { if (ref.current && !ref.current.contains(event.target as Node)) setIsOpen(false); };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    const flatOptions = groupBy ? options.flatMap((g: any) => g.options) : options;
    const selectedLabel = flatOptions.find((o: any) => o.value === value)?.label || placeholder;
    
    // eslint-disable-next-line
    const filteredOptions = groupBy 
        ? options.map((g: any) => ({ ...g, options: g.options.filter((o: any) => o.label.toLowerCase().includes(search.toLowerCase())) })).filter((g: any) => g.options.length > 0)
        : options.filter((o: any) => o.label.toLowerCase().includes(search.toLowerCase()));

    return (
        <div className="relative w-full" ref={ref}>
            <div onClick={() => setIsOpen(!isOpen)} className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white cursor-pointer flex justify-between items-center">
                <span className={!value ? "text-slate-400" : ""}>{selectedLabel}</span>
                <Icon name="Filter" size={14} className="text-slate-400" />
            </div>
            {isOpen && (
                <div className="absolute z-50 w-full mt-1 bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-600 rounded-xl shadow-xl max-h-60 overflow-auto">
                    <div className="p-2 sticky top-0 bg-white dark:bg-slate-800">
                        <input autoFocus value={search} onChange={e => setSearch(e.target.value)} placeholder="Поиск..." className="w-full bg-slate-100 dark:bg-slate-700 rounded-lg p-2 text-sm outline-none dark:text-white" />
                    </div>
                    {groupBy ? filteredOptions.map((g: any, i: number) => (
                        <div key={i}>
                            <div className="px-3 py-1 text-xs font-bold text-slate-400 bg-slate-50 dark:bg-slate-700/50">{g.label}</div>
                            {g.options.map((opt: any) => (
                                <div key={opt.value} onClick={() => { onChange(opt.value); setIsOpen(false); setSearch(""); }} className={`px-3 py-2 text-sm cursor-pointer hover:bg-indigo-50 dark:hover:bg-indigo-900/30 dark:text-slate-200 ${value === opt.value ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600' : ''}`}>
                                    {opt.label}
                                </div>
                            ))}
                        </div>
                    )) : filteredOptions.map((opt: any) => (
                        <div key={opt.value} onClick={() => { onChange(opt.value); setIsOpen(false); setSearch(""); }} className={`px-3 py-2 text-sm cursor-pointer hover:bg-indigo-50 dark:hover:bg-indigo-900/30 dark:text-slate-200 ${value === opt.value ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600' : ''}`}>
                            {opt.label}
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

export const StaggerContainer = ({ children, className = "" }: any) => {
    const childrenArray = React.Children.toArray(children);
    return (
        <div className={className}>
            {childrenArray.map((child, i) => (
                <div key={i} style={{ animation: `fadeIn 0.3s ease-out forwards ${i * 0.05}s`, opacity: 0 }}>
                    {child}
                </div>
            ))}
        </div>
    );
};

export const BarChart = ({ items, max, barClassName = "bg-indigo-500" }: any) => (
    <div className="space-y-3">
        {items.map((item: any, idx: number) => (
            <div key={idx} className="flex items-center gap-3 text-sm">
                <div className="w-32 truncate font-medium text-slate-700 dark:text-slate-300" title={item.label}>{item.label}</div>
                <div className="flex-1 h-4 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
                    <div className={`h-full rounded-full ${barClassName} transition-all duration-500`} style={{ width: `${(item.value / max) * 100}%` }}></div>
                </div>
                <div className="w-12 text-right font-bold text-slate-800 dark:text-slate-200">{item.value}</div>
            </div>
        ))}
    </div>
);
</file>

<file path="src/context/AuthContext.tsx">
import React, { createContext, useContext, useState, useEffect } from 'react';
import firebase from 'firebase/compat/app';
import 'firebase/compat/auth';
import { auth } from '../services/firebase';

export type UserRole = 'admin' | 'teacher' | 'guest' | null;

interface AuthContextType {
    user: firebase.User | null;
    role: UserRole;
    loading: boolean;
    logout: () => Promise<void>;
    setGuestRole: () => void;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

// ВАЖНО: Эти email должны совпадать с теми, которые вы создали в Firebase Console
const ADMIN_EMAIL = 'admin@gymnasium22.com';
const TEACHER_EMAIL = 'teacher@gymnasium22.com';


export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const [user, setUser] = useState<firebase.User | null>(null);
    const [role, setRole] = useState<UserRole>(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!auth) {
            console.warn("Firebase Auth is not initialized. Authentication is disabled.");
            setLoading(false);
            return;
        }

        const unsubscribe = auth.onAuthStateChanged((currentUser) => {
            setUser(currentUser);
            if (currentUser) {
                // Улучшенная логика ролей
                if (currentUser.email === ADMIN_EMAIL) {
                    setRole('admin');
                } else if (currentUser.email === TEACHER_EMAIL) {
                    setRole('teacher');
                } else {
                    // Если залогинился неизвестный пользователь, не даем ему роль и выкидываем
                    setRole(null);
                    auth?.signOut();
                }
            } else {
                setRole(null);
            }
            setLoading(false);
        });
        return () => unsubscribe();
    }, []);

    const logout = async () => {
        if (auth) {
            await auth.signOut();
        }
        setRole(null);
    };

    const setGuestRole = () => {
        setRole('guest');
        setLoading(false);
    };

    return (
        <AuthContext.Provider value={{ user, role, loading, logout, setGuestRole }}>
            {children}
        </AuthContext.Provider>
    );
};

export const useAuth = () => {
    const context = useContext(AuthContext);
    if (!context) throw new Error("useAuth must be used within AuthProvider");
    return context;
};
</file>

<file path="src/index.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

.custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
.dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
</file>

<file path="src/index.tsx">
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)
</file>

<file path="src/pages/Dashboard.tsx">
import { useMemo, useState, useEffect } from 'react';
import { useStaticData, useScheduleData } from '../context/DataContext'; 
import { Icon } from '../components/Icons';
import { DayOfWeek, DAYS, ScheduleItem } from '../types'; 
import { useNavigate } from 'react-router-dom'; 
import { Modal } from '../components/UI';

export const DashboardPage = () => {
    const { subjects, teachers, classes, rooms, bellSchedule, settings } = useStaticData();
    const { schedule, substitutions } = useScheduleData();
    const navigate = useNavigate(); 

    const [notes, setNotes] = useState(localStorage.getItem('gym_notes') || '');
    const [currentDate] = useState(new Date());
    const [searchQuery, setSearchQuery] = useState("");
    const [searchResult, setSearchResult] = useState<any>(null);
    const [showAbsentList, setShowAbsentList] = useState(false);
    const [saveStatus, setSaveStatus] = useState('');
    
    const [isFeedbackModalOpen, setIsFeedbackModalOpen] = useState(false);
    const [feedbackMessage, setFeedbackMessage] = useState('');
    const [isSendingFeedback, setIsSendingFeedback] = useState(false);

    useEffect(() => { 
        localStorage.setItem('gym_notes', notes); 
        if(notes) {
            setSaveStatus('Сохранено');
            const t = setTimeout(() => setSaveStatus(''), 2000);
            return () => clearTimeout(t);
        }
    }, [notes]);

    const getLocalDateString = (date: Date) => {
        const d = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
        return d.toISOString().split('T')[0];
    };

    const todayStr = useMemo(() => getLocalDateString(currentDate), [currentDate]);
    const todayDayOfWeek = useMemo(() => {
        const idx = currentDate.getDay();
        if (idx === 0 || idx === 6) return null; 
        return DAYS[idx - 1];
    }, [currentDate]);

    const upcomingBirthdays = useMemo(() => {
        const today = new Date();
        today.setHours(0,0,0,0);
        return teachers
          .filter(t => t.birthDate)
          .map(t => {
            const bDate = new Date(t.birthDate!);
            let next = new Date(today.getFullYear(), bDate.getMonth(), bDate.getDate());
            if (next < today) next.setFullYear(today.getFullYear() + 1);
            const diff = Math.ceil((next.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
            return { ...t, diff, age: today.getFullYear() - bDate.getFullYear() };
          })
          .filter(t => t.diff <= 30)
          .sort((a, b) => a.diff - b.diff);
    }, [teachers]);

    const occupancyStats = useMemo(() => {
        const totalTeachers = teachers.length;
        
        // 1. Teachers absent for the WHOLE DAY
        const fullDayAbsenteesMap = new Map();
        teachers.filter(t => t.unavailableDates.includes(todayStr)).forEach(t => {
            const rawReason = t.absenceReasons?.[todayStr];
            // Rule: Show reason only if "Без записи", else "Отсутствует"
            const displayReason = (rawReason === 'Без записи') ? 'Без записи' : 'Отсутствует';
            
            fullDayAbsenteesMap.set(t.id, {
                id: t.id,
                name: t.name,
                displayReason: displayReason
            });
        });

        // 2. Teachers with SUBSTITUTIONS (Partial absence)
        // Find substitutions for today
        // FIX: Added condition `s.replacementTeacherId !== s.originalTeacherId` to ignore mere room changes where teacher is same
        const todaySubs = substitutions.filter(s => 
            s.date === todayStr && 
            s.replacementTeacherId !== 'conducted' && 
            s.replacementTeacherId !== s.originalTeacherId
        ); 
        
        const partialAbsenceMap = new Map();

        todaySubs.forEach(sub => {
            // If already marked as full day absent, skip
            if (fullDayAbsenteesMap.has(sub.originalTeacherId)) return;

            const originalTeacher = teachers.find(t => t.id === sub.originalTeacherId);
            if (!originalTeacher) return;

            const item = schedule.find(s => s.id === sub.scheduleItemId);
            if (!item) return;

            if (!partialAbsenceMap.has(sub.originalTeacherId)) {
                partialAbsenceMap.set(sub.originalTeacherId, {
                    teacher: originalTeacher,
                    lessons: []
                });
            }

            const entry = partialAbsenceMap.get(sub.originalTeacherId);
            entry.lessons.push({
                period: item.period,
                reason: sub.lessonAbsenceReason
            });
        });

        const combinedList: any[] = Array.from(fullDayAbsenteesMap.values());

        // Process partial absentees
        partialAbsenceMap.forEach((data, teacherId) => {
            const lessons = data.lessons.sort((a: any, b: any) => a.period - b.period);
            const periods = lessons.map((l: any) => l.period).join(', ');
            
            // Determine reason text. 
            // If ANY of the substituted lessons has "Без записи", we show "Без записи"? 
            // Or strictly "Отсутствует" unless specifically "Без записи".
            // Let's check if there is at least one "Без записи".
            const hasBezZapisi = lessons.some((l: any) => l.reason === 'Без записи');
            const reasonText = hasBezZapisi ? 'Без записи' : 'Отсутствует';

            combinedList.push({
                id: teacherId,
                name: data.teacher.name,
                displayReason: `${periods} урок: ${reasonText}`
            });
        });

        // Sort alphabetically
        combinedList.sort((a, b) => a.name.localeCompare(b.name));

        const absentCount = combinedList.length;
        const presentCount = totalTeachers - absentCount;
        const presentPercent = totalTeachers > 0 ? Math.round((presentCount / totalTeachers) * 100) : 0;
        
        return { presentPercent, absentCount, totalTeachers, absentTeachersList: combinedList };
    }, [teachers, todayStr, substitutions, schedule]);

    const problemZones = useMemo(() => {
        const nextDay = new Date(currentDate);
        nextDay.setDate(currentDate.getDate() + 1);
        while (nextDay.getDay() === 0 || nextDay.getDay() === 6) nextDay.setDate(nextDay.getDate() + 1);
        const dayMap = [null, 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', null];
        const nextDayName = dayMap[nextDay.getDay()];
        if (!nextDayName) return [];
        const problems: any[] = [];
        classes.forEach(cls => {
            const lessons = schedule.filter(s => s.classId === cls.id && s.day === nextDayName);
            if (lessons.length === 0) problems.push({ class: cls.name, issue: `Нет уроков на ${nextDayName}` });
            else if (lessons.length < 4) problems.push({ class: cls.name, issue: `Мало уроков (${lessons.length})` });
            lessons.forEach(l => {
                const tc = schedule.some(s => s.id !== l.id && s.day === nextDayName && s.period === l.period && s.shift === l.shift && s.teacherId === l.teacherId);
                if(tc) problems.push({ class: cls.name, issue: `Конфликт учителя (${l.period} ур)` });
                if (l.roomId) {
                    const room = rooms.find(r => r.id === l.roomId);
                    if (room && room.capacity < cls.studentsCount) problems.push({ class: cls.name, issue: `Тесно: ${room.name} (${l.period} ур)` });
                }
            });
        });
        return problems.filter((v,i,a)=>a.findIndex(t=>(t.class === v.class && t.issue === v.issue))===i).slice(0, 10);
    }, [schedule, classes, teachers, rooms, currentDate]);

    const unresolvedSubstitutions = useMemo(() => {
        if (!todayDayOfWeek) return 0;

        let count = 0;
        const todaysSchedule = schedule.filter(s => s.day === todayDayOfWeek);

        for (const lesson of todaysSchedule) {
            const originalTeacher = teachers.find(t => t.id === lesson.teacherId);
            
            if (originalTeacher && originalTeacher.unavailableDates.includes(todayStr)) {
                const substitution = substitutions.find(sub => 
                    sub.scheduleItemId === lesson.id && sub.date === todayStr
                );

                if (!substitution || substitution.replacementTeacherId === 'cancelled' || substitution.replacementTeacherId === 'conducted') {
                    count++;
                }
            }
        }
        return count;
    }, [schedule, teachers, substitutions, todayStr, todayDayOfWeek]);

    const handleSearch = () => {
        if (!searchQuery) { setSearchResult(null); return; }
        const now = new Date();
        const dayMap = [null, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday, DayOfWeek.Friday, null];
        const dayName = dayMap[now.getDay()]; 
        if (!dayName) { setSearchResult({ status: 'Выходной', detail: 'Сегодня уроков нет', color: 'text-slate-500' }); return; }
        const timeToMin = (t: string) => { const [h, m] = t.split(':').map(Number); return h * 60 + m; };
        const minutesNow = now.getHours() * 60 + now.getMinutes();
        let dailyBells = bellSchedule.filter(b => b.day === dayName);
        if (dailyBells.length === 0) dailyBells = bellSchedule.filter(b => b.day === 'default');

        const bell = dailyBells.find(b => {
             const start = timeToMin(b.start);
             const end = timeToMin(b.end);
             return minutesNow >= start && minutesNow <= end;
        });
        const q = searchQuery.toLowerCase();
        const teacher = teachers.find(t => t.name.toLowerCase().includes(q));
        const cls = classes.find(c => c.name.toLowerCase().includes(q));
        if (!teacher && !cls) { setSearchResult({ status: 'Не найдено', detail: 'Проверьте запрос', color: 'text-red-500' }); return; }
        
        if (teacher) {
            if (teacher.unavailableDates.includes(todayStr)) {
                const rawReason = teacher.absenceReasons?.[todayStr];
                const displayReason = (rawReason === 'Без записи') ? 'Без записи' : 'Отсутствует';
                setSearchResult({ status: 'Отсутствует', detail: displayReason, color: 'text-red-500', icon: 'UserX', items: [] });
                return;
            }

            if (!bell) {
                setSearchResult({ status: 'Перемена / Нет урока', detail: 'Свободное время', color: 'text-amber-500', icon: 'Clock', items: [] });
                return;
            }

            // Fix: Added check for s.shift === bell.shift to ensure we only show lessons for the CURRENT shift time
            const ownLessons = schedule.filter(s => s.teacherId === teacher.id && s.day === dayName && s.period === bell.period && s.shift === bell.shift);
            
            const substituteLessons = substitutions
                .filter(sub => sub.date === todayStr && sub.replacementTeacherId === teacher.id)
                .map(sub => schedule.find(s => s.id === sub.scheduleItemId))
                .filter((lesson): lesson is ScheduleItem => !!lesson && lesson.day === dayName && lesson.period === bell.period && lesson.shift === bell.shift); // Fix: Added shift check
            
            let activeItems: any[] = [];

            ownLessons.forEach(ownLesson => {
                const ownLessonSub = substitutions.find(s => s.date === todayStr && s.scheduleItemId === ownLesson.id);
                if (!ownLessonSub || ownLessonSub.replacementTeacherId === teacher.id) {
                    const room = rooms.find(r => r.id === (ownLessonSub?.replacementRoomId || ownLesson.roomId))?.name || (ownLessonSub?.replacementRoomId || ownLesson.roomId) || "без каб.";
                    const subject = subjects.find(s => s.id === ownLesson.subjectId)?.name;
                    const className = classes.find(c => c.id === ownLesson.classId)?.name;
                    activeItems.push({ 
                        room, 
                        subject, 
                        entityName: className, 
                        direction: ownLesson.direction,
                        isSubstitution: !!(ownLessonSub && ownLessonSub.replacementTeacherId === teacher.id),
                        originalTeacherName: null
                    });
                }
            });
            
            substituteLessons.forEach(lesson => {
                const subRecord = substitutions.find(sub => sub.date === todayStr && sub.scheduleItemId === lesson.id && sub.replacementTeacherId === teacher.id);
                if (!subRecord) return;

                const room = rooms.find(r => r.id === (subRecord.replacementRoomId || lesson.roomId))?.name || (subRecord.replacementRoomId || lesson.roomId) || "без каб.";
                const subject = subjects.find(s => s.id === lesson.subjectId)?.name;
                const className = classes.find(c => c.id === lesson.classId)?.name;
                const originalTeacher = teachers.find(t => t.id === subRecord.originalTeacherId);

                activeItems.push({
                    room,
                    subject,
                    entityName: className,
                    direction: lesson.direction,
                    isSubstitution: true,
                    originalTeacherName: originalTeacher?.name
                });
            });
            
            if (activeItems.length > 0) {
                setSearchResult({ status: `Урок ${bell.period}`, detail: '', color: 'text-emerald-600', icon: 'MapPin', items: activeItems });
            } else {
                setSearchResult({ status: 'Окно', detail: `Сейчас (Урок ${bell.period}) свободен`, color: 'text-blue-500', icon: 'User', items: [] });
            }
        } else if (cls) {
            if (!bell) { setSearchResult({ status: 'Перемена', detail: 'Класс свободен', color: 'text-amber-500', icon: 'Clock', items: [] }); return; }

            // Fix: Added check for s.shift === bell.shift
            const lessons = schedule.filter(s => s.classId === cls.id && s.day === dayName && s.period === bell.period && s.shift === bell.shift);
            
            if (lessons.length > 0) {
                const items = lessons.map(lesson => {
                    const substitution = substitutions.find(sub => sub.scheduleItemId === lesson.id && sub.date === todayStr);

                    if (substitution && substitution.replacementTeacherId === 'cancelled') {
                        return { cancelled: true, subject: subjects.find(s => s.id === lesson.subjectId)?.name };
                    }

                    const isSubbed = !!(substitution && substitution.replacementTeacherId !== 'conducted' && substitution.replacementTeacherId !== 'cancelled');
                    const teacherId = isSubbed ? substitution.replacementTeacherId : lesson.teacherId;
                    const roomId = substitution?.replacementRoomId || lesson.roomId;
                    
                    const teacherName = teachers.find(t => t.id === teacherId)?.name;
                    const room = rooms.find(r => r.id === roomId)?.name || roomId || "без каб.";
                    const subject = subjects.find(s => s.id === lesson.subjectId)?.name;
                    
                    const originalTeacherName = isSubbed ? teachers.find(t => t.id === substitution.originalTeacherId)?.name : null;

                    return { room, subject, entityName: teacherName, direction: lesson.direction, isSubstitution: isSubbed, originalTeacherName };
                });

                const activeItems = items.filter(item => !item.cancelled);
                const cancelledItems = items.filter(item => !!item.cancelled);
                
                if (activeItems.length > 0) {
                    setSearchResult({ status: `Урок ${bell.period}`, detail: '', color: 'text-emerald-600', icon: 'MapPin', items: activeItems });
                } else if (cancelledItems.length > 0) {
                    setSearchResult({ status: `Урок отменен`, detail: cancelledItems.map(i => i.subject).join(', '), color: 'text-red-500', icon: 'X', items: [] });
                } else {
                    setSearchResult({ status: 'Нет урока', detail: 'Класс свободен', color: 'text-blue-500', icon: 'BookOpen', items: [] });
                }
            } else {
                setSearchResult({ status: 'Нет урока', detail: 'Класс свободен', color: 'text-blue-500', icon: 'BookOpen', items: [] });
            }
        }
    };
    
    const handleSendFeedback = async () => {
        if (!feedbackMessage.trim()) {
            alert('Пожалуйста, введите ваше сообщение.');
            return;
        }
        if (!settings?.telegramToken || !settings?.feedbackChatId) {
            alert('Функция обратной связи не настроена администратором.');
            return;
        }

        setIsSendingFeedback(true);
        const text = `📬 *Новое сообщение обратной связи:*\n\n${feedbackMessage}`;

        try {
            const response = await fetch(`https://api.telegram.org/bot${settings.telegramToken}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: settings.feedbackChatId,
                    text: text,
                    parse_mode: 'Markdown',
                }),
            });

            const result = await response.json();
            if (result.ok) {
                alert('Спасибо! Ваше сообщение отправлено.');
                setIsFeedbackModalOpen(false);
                setFeedbackMessage('');
            } else {
                throw new Error(result.description);
            }
        } catch (error) {
            console.error("Ошибка отправки в Telegram:", error);
            alert(`Не удалось отправить сообщение. Ошибка: ${error}`);
        } finally {
            setIsSendingFeedback(false);
        }
    };

    return (
        <div className="max-w-7xl mx-auto space-y-6 pb-20">
            <header className="mb-6 flex justify-between items-start">
                 <div>
                    <h1 className="text-2xl font-black text-slate-800 dark:text-white">Рабочий стол администратора</h1>
                    <p className="text-slate-500 dark:text-slate-400 text-sm font-medium">{currentDate.toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                 </div>
                 <button onClick={() => setIsFeedbackModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded-xl font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition text-sm">
                    <Icon name="Send" size={16} /> Обратная связь
                </button>
            </header>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                {/* Widget 1: Who Where */}
                <div className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col h-full relative overflow-hidden">
                    <div className="flex items-center gap-3 mb-4"><div className="bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 p-2 rounded-lg"><Icon name="Search" size={20}/></div><h3 className="font-bold text-lg dark:text-white">Кто где?</h3></div>
                    <div className="flex gap-2 mb-4">
                        <input placeholder="Учитель или класс..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSearch()} className="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm outline-none dark:text-white" />
                        <button onClick={handleSearch} className="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-xl transition-colors"><Icon name="Search" size={20}/></button>
                    </div>
                    {searchResult && (
                        <div className="mt-auto p-3 bg-slate-50 dark:bg-slate-700/30 rounded-xl border border-slate-100 dark:border-slate-700 animate-fade-in">
                            <div className={`text-xs font-bold uppercase mb-2 flex items-center gap-2 ${searchResult.color}`}><Icon name={searchResult.icon || 'Info'} size={14}/> {searchResult.status}</div>
                            {searchResult.items && searchResult.items.length > 0 ? (
                                <div className="space-y-2">
                                    {searchResult.items.map((item: any, idx: number) => (
                                        <div key={idx} className="bg-white dark:bg-dark-800 p-2 rounded-lg border border-slate-100 dark:border-slate-600 text-xs shadow-sm">
                                            {item.direction && <div className="text-[10px] font-bold text-indigo-500 mb-0.5">{item.direction}</div>}
                                            <div className="font-bold text-slate-700 dark:text-slate-200">{item.subject}</div>
                                            {item.isSubstitution && (
                                                <div className="text-[10px] font-bold text-orange-500">
                                                    {item.originalTeacherName ? `Замена (вместо ${item.originalTeacherName})` : 'Замена кабинета'}
                                                </div>
                                            )}
                                            <div className="flex justify-between items-center mt-1 text-slate-500 dark:text-slate-400">
                                                <span>{item.entityName}</span>
                                                <span className="bg-slate-100 dark:bg-slate-700 px-1.5 rounded font-mono">{item.room}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : ( <div className="font-bold text-slate-800 dark:text-white text-sm leading-snug">{searchResult.detail}</div> )}
                        </div>
                    )}
                </div>

                {/* Widget 2: Unresolved Substitutions */}
                <div className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col h-full">
                    <div className="flex items-center gap-3 mb-4"><div className="bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 p-2 rounded-lg"><Icon name="AlertTriangle" size={20}/></div><h3 className="font-bold text-lg dark:text-white">Неразрешенные Замены</h3></div>
                    <div className="flex-1 flex flex-col items-center justify-center text-center">
                        {unresolvedSubstitutions > 0 ? (
                            <>
                                <div className="text-5xl font-black text-red-500 mb-2">{unresolvedSubstitutions}</div>
                                <div className="text-sm text-slate-500 dark:text-slate-400 mb-4">уроков требуют замены сегодня</div>
                                <button onClick={() => navigate('/substitutions')} className="px-6 py-2 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition shadow-lg shadow-red-200 dark:shadow-none flex items-center gap-2">
                                    <Icon name="ArrowRight" size={16}/> Перейти к заменам
                                </button>
                            </>
                        ) : (
                            <>
                                <Icon name="CheckCircle" size={48} className="mb-4 text-emerald-400"/>
                                <p className="text-sm text-slate-400">Сегодня нет уроков, требующих замены</p>
                            </>
                        )}
                    </div>
                </div>

                {/* Widget 3: Occupancy */}
                <div className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col h-full">
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-3"><div className="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 p-2 rounded-lg"><Icon name="PieChart" size={20}/></div><h3 className="font-bold text-lg dark:text-white">Наполняемость</h3></div>
                        <button onClick={() => setShowAbsentList(!showAbsentList)} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg transition-colors" title={showAbsentList ? "Показать график" : "Список отсутствующих"}>
                            <Icon name={showAbsentList ? "PieChart" : "List"} size={20}/>
                        </button>
                    </div>
                    {showAbsentList ? (
                        <div className="flex-1 overflow-y-auto custom-scrollbar animate-fade-in">
                            {occupancyStats.absentTeachersList.length > 0 ? (
                                <div className="space-y-2">
                                    {occupancyStats.absentTeachersList.map(t => (
                                        <div key={t.id} className="flex justify-between items-center text-sm border-b border-slate-50 dark:border-slate-700 pb-1 mb-1 last:border-0">
                                            <span className="font-medium text-slate-700 dark:text-slate-300 truncate pr-2">{t.name}</span>
                                            <span className="text-xs text-red-500 font-bold whitespace-nowrap">{t.displayReason}</span>
                                        </div>
                                    ))}
                                </div>
                            ) : ( <div className="h-full flex flex-col items-center justify-center text-center text-slate-400"><Icon name="CheckCircle" size={32} className="text-emerald-400 mb-2"/><p className="text-sm">Все учителя на месте</p></div> )}
                        </div>
                    ) : (
                        <div className="flex items-center justify-between flex-1 animate-fade-in">
                            <div className="relative w-24 h-24">
                                 <svg viewBox="0 0 36 36" className="w-full h-full transform -rotate-90">
                                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#f1f5f9" strokeWidth="4" className="dark:stroke-slate-700" />
                                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#10b981" strokeWidth="4" strokeDasharray={`${occupancyStats.presentPercent}, 100`} />
                                 </svg>
                                 <div className="absolute inset-0 flex flex-col items-center justify-center"><span className="text-xs text-slate-400 font-bold">Присут.</span><span className="font-black text-slate-700 dark:text-white">{occupancyStats.presentPercent}%</span></div>
                            </div>
                            <div className="text-right"><div className="text-3xl font-black text-red-500">{occupancyStats.absentCount}</div><div className="text-xs text-slate-400 font-bold uppercase leading-tight">Учителей<br/>отсутствует</div></div>
                        </div>
                    )}
                </div>

                {/* Widget 3: Birthdays */}
                <div className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col h-full">
                    <div className="flex items-center gap-3 mb-4"><div className="bg-rose-100 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 p-2 rounded-lg"><Icon name="Gift" size={20}/></div><h3 className="font-bold text-lg dark:text-white">Дни рождения</h3></div>
                    <div className="flex-1 overflow-y-auto max-h-40 custom-scrollbar space-y-3">{upcomingBirthdays.length ? upcomingBirthdays.map(t => <div key={t.id} className="flex justify-between text-sm text-slate-700 dark:text-slate-300"><span>{t.name}</span><span className="font-bold text-slate-400">{t.diff === 0 ? 'Сегодня!' : `${t.diff} дн.`}</span></div>) : <div className="text-slate-400 text-sm text-center">Нет ближайших</div>}</div>
                </div>

                {/* Widget 4: Conflicts */}
                <div className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col h-full">
                    <div className="flex items-center gap-3 mb-4"><div className="bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 p-2 rounded-lg"><Icon name="AlertTriangle" size={20}/></div><h3 className="font-bold text-lg dark:text-white">Конфликты</h3></div>
                    <div className="flex-1 overflow-y-auto max-h-40 custom-scrollbar space-y-2">{problemZones.length ? problemZones.map((p,i) => <div key={i} className="flex justify-between text-sm text-slate-700 dark:text-slate-300"><span>{p.class}</span><span className="text-amber-600 text-xs font-bold">{p.issue}</span></div>) : <div className="text-slate-400 text-sm text-center">Расписание в порядке</div>}</div>
                </div>

                {/* Notes */}
                <div className="md:col-span-2 lg:col-span-4 bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col relative group">
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-3"><div className="bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 p-2 rounded-lg"><Icon name="CheckSquare" size={20}/></div><h3 className="font-bold text-lg dark:text-white">Быстрые заметки</h3></div>
                        <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onClick={() => { navigator.clipboard.writeText(notes); alert('Скопировано'); }} className="text-xs bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded font-bold text-slate-500 hover:text-indigo-600">Копировать</button>
                            <button onClick={() => { if(confirm('Очистить заметки?')) setNotes(''); }} className="text-xs bg-red-50 dark:bg-red-900/30 px-2 py-1 rounded font-bold text-red-500 hover:text-red-700">Очистить</button>
                        </div>
                    </div>
                    <div className="relative flex-1">
                        <textarea 
                            className="w-full h-48 p-6 rounded-xl bg-yellow-50 dark:bg-slate-700 border border-yellow-200 dark:border-slate-600 outline-none font-medium text-slate-700 dark:text-slate-200 resize-none focus:ring-4 ring-yellow-100 dark:ring-slate-600/50 transition-shadow leading-relaxed shadow-inner" 
                            placeholder="Список задач на сегодня..." 
                            value={notes} 
                            onChange={e => setNotes(e.target.value)}
                            style={{ backgroundImage: 'linear-gradient(transparent, transparent 27px, #e5e7eb 28px)', backgroundSize: '100% 28px', lineHeight: '28px' }}
                        />
                        {saveStatus && <div className="absolute bottom-4 right-4 text-[10px] font-bold uppercase tracking-widest text-slate-400 animate-fade-in flex items-center gap-1"><Icon name="Save" size={12}/> {saveStatus}</div>}
                    </div>
                </div>
            </div>
            <Modal isOpen={isFeedbackModalOpen} onClose={() => setIsFeedbackModalOpen(false)} title="Обратная связь и предложения">
                <div className="space-y-4">
                    <p className="text-sm text-slate-500 dark:text-slate-400">
                        Есть идеи по улучшению приложения или нашли ошибку? Напишите нам! Ваше сообщение будет отправлено напрямую администратору.
                    </p>
                    <textarea
                        value={feedbackMessage}
                        onChange={(e) => setFeedbackMessage(e.target.value)}
                        rows={6}
                        className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500 resize-y"
                        placeholder="Ваше сообщение..."
                    />
                    <div className="flex justify-end">
                        <button
                            onClick={handleSendFeedback}
                            disabled={isSendingFeedback}
                            className="px-6 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 text-sm font-bold shadow-lg shadow-indigo-200 dark:shadow-none flex items-center gap-2 disabled:opacity-50"
                        >
                            {isSendingFeedback ? <Icon name="Loader" size={16} className="animate-spin" /> : <Icon name="Send" size={16} />}
                            {isSendingFeedback ? 'Отправка...' : 'Отправить'}
                        </button>
                    </div>
                </div>
            </Modal>
        </div>
    );
};
</file>

<file path="src/pages/Directory.tsx">
import { useState } from 'react';
import { useStaticData } from '../context/DataContext'; 
import { Icon } from '../components/Icons';
import { Modal, StaggerContainer } from '../components/UI';
import { Shift, ROOM_TYPES, SHIFT_PERIODS, Teacher, Subject, ClassEntity, Room } from '../types';

export const DirectoryPage = () => {
    const { subjects, teachers, classes, rooms, bellSchedule, saveStaticData } = useStaticData();

    const [activeTab, setActiveTab] = useState('teachers');
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingId, setEditingId] = useState<string | null>(null);
    
    // Forms
    const [teacherForm, setTeacherForm] = useState<Partial<Teacher>>({});
    const [subjectForm, setSubjectForm] = useState<Partial<Subject>>({});
    const [classForm, setClassForm] = useState<Partial<ClassEntity>>({});
    const [roomForm, setRoomForm] = useState<Partial<Room>>({});
    const [activeBellDay, setActiveBellDay] = useState('default');
    
    const [draggedIdx, setDraggedIdx] = useState<number|null>(null);

    const openModal = (id?: string) => {
        setEditingId(id || null);
        if (activeTab === 'teachers') setTeacherForm(id ? teachers.find(x => x.id === id) ?? {} : { subjectIds: [], unavailableDates: [], shifts: [Shift.First, Shift.Second], telegramChatId: '' });
        else if (activeTab === 'subjects') setSubjectForm(id ? subjects.find(x => x.id === id) ?? {} : { color: '#e0e7ff', difficulty: 5, requiredRoomType: 'Обычный' });
        else if (activeTab === 'classes') setClassForm(id ? classes.find(x => x.id === id) ?? {} : { shift: Shift.First, studentsCount: 25 });
        else if (activeTab === 'rooms') setRoomForm(id ? rooms.find(x => x.id === id) ?? {} : { capacity: 30, type: 'Обычный' });
        setIsModalOpen(true);
    };

    const handleSave = async () => {
        const genId = () => Math.random().toString(36).substr(2, 9);
        
        const configMap = {
            teachers: { list: teachers, form: teacherForm, key: 'teachers' as const },
            subjects: { list: subjects, form: subjectForm, key: 'subjects' as const },
            classes: { list: classes, form: classForm, key: 'classes' as const },
            rooms: { list: rooms, form: roomForm, key: 'rooms' as const },
        };

        if (activeTab === 'bells' || !(activeTab in configMap)) {
            return;
        }

        const activeConfig = configMap[activeTab as keyof typeof configMap];
        const { list, form, key } = activeConfig;
        
        if (!form.name) return;

        let newList: any[] = [...list];
        if (editingId) {
            newList = newList.map(item => (item.id === editingId ? { ...item, ...form } : item));
        } else {
            newList.push({ ...form, id: genId() });
        }
        
        await saveStaticData({ [key]: newList });
        setIsModalOpen(false);
    };

    const handleDelete = async (id: string) => { 
        if (!window.confirm("Удалить запись?")) return; 
        
        switch(activeTab) {
            case 'teachers': await saveStaticData({ teachers: teachers.filter(t => t.id !== id) }); break;
            case 'subjects': await saveStaticData({ subjects: subjects.filter(s => s.id !== id) }); break;
            case 'classes': await saveStaticData({ classes: classes.filter(c => c.id !== id) }); break;
            case 'rooms': await saveStaticData({ rooms: rooms.filter(r => r.id !== id) }); break;
        }
    };
    
    // Drag & Drop
    const onDragStart = (e: any, index: number) => { setDraggedIdx(index); e.dataTransfer.effectAllowed = "move"; };
    const onDragOver = (e: any) => { e.preventDefault(); };
    // Fix: Refactored onDrop to use a switch statement for type safety.
    // This allows TypeScript to correctly infer the types for each list (teachers, subjects, etc.)
    // and the item being moved, resolving the previous type mismatch error.
    const onDrop = async (e: any, index: number) => { 
        if (draggedIdx === null || draggedIdx === index) return; 
        
        switch (activeTab) {
            case 'teachers': {
                const newList = [...teachers];
                const [movedItem] = newList.splice(draggedIdx, 1);
                newList.splice(index, 0, movedItem);
                await saveStaticData({ teachers: newList });
                break;
            }
            case 'subjects': {
                const newList = [...subjects];
                const [movedItem] = newList.splice(draggedIdx, 1);
                newList.splice(index, 0, movedItem);
                await saveStaticData({ subjects: newList });
                break;
            }
            case 'classes': {
                const newList = [...classes];
                const [movedItem] = newList.splice(draggedIdx, 1);
                newList.splice(index, 0, movedItem);
                await saveStaticData({ classes: newList });
                break;
            }
            case 'rooms': {
                const newList = [...rooms];
                const [movedItem] = newList.splice(draggedIdx, 1);
                newList.splice(index, 0, movedItem);
                await saveStaticData({ rooms: newList });
                break;
            }
        }
        
        setDraggedIdx(null); 
    };

    // Bells logic
    const getActiveBells = (shift: string, period: number) => {
        const dayKey = activeBellDay;
        let bell = bellSchedule.find(b => b.shift === shift && b.period === period && b.day === dayKey);
        if (!bell && dayKey !== 'default') {
             const defaultBell = bellSchedule.find(b => b.shift === shift && b.period === period && b.day === 'default');
             return defaultBell ? { ...defaultBell, start: '', end: '', isInherited: true } : { start: '', end: '', isInherited: false };
        }
        return bell || { start: '', end: '' };
    };

    const handleBellChange = async (shift: string, period: number, field: string, value: string) => {
        let bells = [...bellSchedule];
        const dayKey = activeBellDay;
        const idx = bells.findIndex(b => b.shift === shift && b.period === period && b.day === dayKey);
        
        if (idx >= 0) {
            bells[idx] = { ...bells[idx], [field]: value };
        } else {
            bells.push({ shift, period, [field]: value, start: '00:00', end: '00:00', day: dayKey } as any);
        }
        await saveStaticData({ bellSchedule: bells });
    };

    const toggleShift = (shift: string) => {
        const currentShifts = teacherForm.shifts || [];
        if (currentShifts.includes(shift)) {
            setTeacherForm({ ...teacherForm, shifts: currentShifts.filter((s: string) => s !== shift) });
        } else {
            setTeacherForm({ ...teacherForm, shifts: [...currentShifts, shift] });
        }
    };

    return (
        <div className="max-w-7xl mx-auto w-full h-full flex flex-col">
            <div className="flex flex-wrap items-center justify-between gap-4 mb-8 shrink-0">
                <div className="flex p-1 bg-white dark:bg-dark-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-x-auto">
                    {[
                        { id: 'teachers', icon: 'Users', label: 'Учителя' },
                        { id: 'subjects', icon: 'BookOpen', label: 'Предметы' },
                        { id: 'classes', icon: 'GraduationCap', label: 'Классы' },
                        { id: 'rooms', icon: 'DoorOpen', label: 'Кабинеты' },
                        { id: 'bells', icon: 'Bell', label: 'Звонки' },
                    ].map(tab => (
                        <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-5 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${activeTab === tab.id ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>
                            <Icon name={tab.icon} size={18} /> {tab.label}
                        </button>
                    ))}
                </div>
                {activeTab !== 'bells' && <button onClick={() => openModal()} className="flex items-center gap-2 bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 dark:shadow-none font-semibold"><Icon name="Plus" size={20} /> Добавить</button>}
            </div>

            <div className="flex-1 overflow-y-auto pb-20 custom-scrollbar pr-2">
                {activeTab === 'teachers' && (<StaggerContainer className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{teachers.map((t, i) => (<div key={t.id} draggable onDragStart={(e)=>onDragStart(e,i)} onDragOver={onDragOver} onDrop={(e)=>onDrop(e,i)} className="bg-white dark:bg-dark-800 p-5 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-md transition-all group flex flex-col cursor-grab active:cursor-grabbing"><div className="flex justify-between items-start mb-2"><div className="flex items-center gap-3"><Icon name="GripVertical" className="text-slate-300 dark:text-slate-600" size={16}/><div className="font-bold text-slate-800 dark:text-slate-100 text-lg">{t.name}</div></div><div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => openModal(t.id)} className="p-2 text-slate-600 dark:text-slate-300 hover:text-indigo-600 bg-slate-50 dark:bg-slate-700 rounded-full"><Icon name="Edit2" size={16}/></button><button onClick={() => handleDelete(t.id)} className="p-2 text-slate-600 dark:text-slate-300 hover:text-red-600 bg-slate-50 dark:bg-slate-700 rounded-full"><Icon name="Trash2" size={16}/></button></div></div><div className="text-xs text-slate-500 mb-2">{t.birthDate ? `ДР: ${new Date(t.birthDate).toLocaleDateString('ru-RU')}` : ''}</div><div className="flex gap-2 mb-3">{t.shifts?.includes(Shift.First) && <span className="text-[10px] bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded font-bold">1 см</span>}{t.shifts?.includes(Shift.Second) && <span className="text-[10px] bg-purple-50 text-purple-700 px-2 py-0.5 rounded font-bold">2 см</span>}</div><div className="flex flex-wrap gap-1 mt-auto pl-7">{t.subjectIds.map(sid => { const s = subjects.find(sub => sub.id === sid); return s ? <span key={sid} className="text-xs px-2 py-1 rounded-md font-medium" style={{backgroundColor: s.color, color: '#334155'}}>{s.name}</span> : null })}</div></div>))}</StaggerContainer>)}
                {activeTab === 'subjects' && (<StaggerContainer className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">{subjects.map((s, i) => (<div key={s.id} draggable onDragStart={(e)=>onDragStart(e,i)} onDragOver={onDragOver} onDrop={(e)=>onDrop(e,i)} className="bg-white dark:bg-dark-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm flex items-center justify-between group cursor-grab active:cursor-grabbing border-l-4" style={{borderLeftColor: s.color}}><div className="flex items-center gap-3"><Icon name="GripVertical" className="text-slate-300 dark:text-slate-600" size={16}/><div><div className="font-bold text-slate-700 dark:text-slate-200">{s.name}</div><div className="text-xs text-slate-400">Сложность: {s.difficulty} • {s.requiredRoomType}</div></div></div><div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => openModal(s.id)} className="p-1.5 text-slate-600 dark:text-slate-300 hover:text-indigo-600"><Icon name="Edit2" size={16}/></button><button onClick={() => handleDelete(s.id)} className="p-1.5 text-slate-600 dark:text-slate-300 hover:text-red-600"><Icon name="Trash2" size={16}/></button></div></div>))}</StaggerContainer>)}
                {activeTab === 'classes' && (<StaggerContainer className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">{classes.map((c, i) => (<div key={c.id} draggable onDragStart={(e)=>onDragStart(e,i)} onDragOver={onDragOver} onDrop={(e)=>onDrop(e,i)} className="bg-white dark:bg-dark-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm text-center group hover:shadow-md transition-all relative cursor-grab active:cursor-grabbing"><div className="absolute left-2 top-2 text-slate-300 dark:text-slate-600"><Icon name="GripVertical" size={14}/></div><div className="text-2xl font-black text-slate-800 dark:text-slate-100 mb-1">{c.name}</div><div className="text-xs text-slate-500 mb-1">{c.studentsCount || 0} учеников</div><div className={`text-xs font-bold px-2 py-0.5 rounded-full inline-block ${c.shift === Shift.First ? 'bg-blue-50 text-blue-600' : 'bg-orange-50 text-orange-600'}`}>{c.shift === Shift.First ? 'I' : 'II'} смена</div><div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => openModal(c.id)} className="p-1 text-slate-600 dark:text-slate-300 hover:text-indigo-600"><Icon name="Edit2" size={14}/></button><button onClick={() => handleDelete(c.id)} className="p-1 text-slate-600 dark:text-slate-300 hover:text-red-600"><Icon name="Trash2" size={14}/></button></div></div>))}</StaggerContainer>)}
                {activeTab === 'rooms' && (<StaggerContainer className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">{rooms.map((r, i) => (<div key={r.id} draggable onDragStart={(e)=>onDragStart(e,i)} onDragOver={onDragOver} onDrop={(e)=>onDrop(e,i)} className="bg-white dark:bg-dark-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm flex items-center justify-between group cursor-grab active:cursor-grabbing"><div className="flex items-center gap-3"><Icon name="GripVertical" className="text-slate-300 dark:text-slate-600" size={16}/><div className="bg-indigo-50 dark:bg-indigo-900/30 p-2 rounded-lg text-indigo-600"><Icon name="DoorOpen" size={20}/></div><div><div className="font-bold text-slate-700 dark:text-slate-200">{r.name}</div><div className="text-xs text-slate-400">Вмест: {r.capacity} • {r.type}</div></div></div><div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => openModal(r.id)} className="p-1.5 text-slate-600 dark:text-slate-300 hover:text-indigo-600"><Icon name="Edit2" size={16}/></button><button onClick={() => handleDelete(r.id)} className="p-1.5 text-slate-600 dark:text-slate-300 hover:text-red-600"><Icon name="Trash2" size={16}/></button></div></div>))}</StaggerContainer>)}
                
                {activeTab === 'bells' && (
                    <div className="flex flex-col gap-6">
                        <div className="flex justify-center">
                            <div className="bg-slate-100 dark:bg-slate-700 p-1 rounded-xl flex gap-1">
                                {['default', 'Ср', 'Чт'].map(d => (
                                    <button key={d} onClick={() => setActiveBellDay(d)} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${activeBellDay === d ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>{d === 'default' ? 'Стандартное' : d === 'Ср' ? 'Среда' : 'Четверг'}</button>
                                ))}
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            {[Shift.First, Shift.Second].map(shift => (
                                <div key={shift} className="bg-white dark:bg-dark-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                                    <div className={`p-4 font-bold text-lg text-white ${shift === Shift.First ? 'bg-indigo-600' : 'bg-purple-600'}`}>{shift}</div>
                                    <div className="p-6 space-y-3">
                                        {SHIFT_PERIODS[shift].map(period => {
                                            const bell: any = getActiveBells(shift, period);
                                            return (
                                                <div key={period} className={`flex items-center gap-4 p-2 rounded-xl transition-colors ${bell.isInherited ? 'bg-slate-50/50 dark:bg-slate-800/50 opacity-60' : 'bg-slate-50 dark:bg-slate-700/50'}`}>
                                                    <div className="w-10 h-10 rounded-lg bg-white dark:bg-slate-600 flex items-center justify-center font-black text-slate-500 dark:text-slate-300 shadow-sm">{period}</div>
                                                    <div className="flex-1 flex items-center gap-2">
                                                        <input type="time" className="flex-1 border-none bg-transparent font-bold text-slate-800 dark:text-white text-center focus:ring-0" value={bell.start} onChange={e => handleBellChange(shift, period, 'start', e.target.value)} />
                                                        <span className="text-slate-300">—</span>
                                                        <input type="time" className="flex-1 border-none bg-transparent font-bold text-slate-800 dark:text-white text-center focus:ring-0" value={bell.end} onChange={e => handleBellChange(shift, period, 'end', e.target.value)} />
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>

            <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="Редактирование">
                <div className="space-y-4">
                    {activeTab === 'teachers' && (<>
                        <input className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" placeholder="ФИО Учителя" value={teacherForm.name || ''} onChange={e => setTeacherForm({...teacherForm, name: e.target.value})} />
                        <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Дата рождения</label><input type="date" className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" value={teacherForm.birthDate || ''} onChange={e => setTeacherForm({...teacherForm, birthDate: e.target.value})} /></div>
                        
                        <div>
                            <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Telegram Chat ID</label>
                            <input type="text" className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" value={teacherForm.telegramChatId || ''} onChange={e => setTeacherForm({...teacherForm, telegramChatId: e.target.value})} placeholder="12345678" />
                        </div>

                        <div className="space-y-2">
                            <div className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">Смены</div>
                            <div className="flex gap-4">
                                <label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" className="rounded text-indigo-600 focus:ring-indigo-500" checked={teacherForm.shifts?.includes(Shift.First)} onChange={() => toggleShift(Shift.First)} /><span className="text-sm font-medium dark:text-slate-300">1 смена</span></label>
                                <label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" className="rounded text-purple-600 focus:ring-purple-500" checked={teacherForm.shifts?.includes(Shift.Second)} onChange={() => toggleShift(Shift.Second)} /><span className="text-sm font-medium dark:text-slate-300">2 смена</span></label>
                            </div>
                        </div>
                        <div className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mt-2">Предметы</div>
                        <div className="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto custom-scrollbar border border-slate-100 dark:border-slate-700 p-2 rounded-xl">{subjects.map(s => (<label key={s.id} className="flex items-center gap-2 p-1 rounded hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer"><input type="checkbox" className="rounded text-indigo-600 focus:ring-indigo-500" checked={teacherForm.subjectIds?.includes(s.id)} onChange={e => { const current = teacherForm.subjectIds || []; setTeacherForm({...teacherForm, subjectIds: e.target.checked ? [...current, s.id] : current.filter((x: string) => x !== s.id)}); }} /><span className="text-sm dark:text-slate-300">{s.name}</span></label>))}</div>
                    </>)}
                    
                    {activeTab === 'subjects' && (<>
                        <input className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" placeholder="Название предмета" value={subjectForm.name || ''} onChange={e => setSubjectForm({...subjectForm, name: e.target.value})} />
                        <div className="flex items-center gap-4"><span className="text-sm font-bold text-slate-600 dark:text-slate-300">Цвет:</span><input type="color" className="w-20 h-10 cursor-pointer bg-transparent" value={subjectForm.color || '#ffffff'} onChange={e => setSubjectForm({...subjectForm, color: e.target.value})} /></div>
                        <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Сложность (СанПиН 1-12)</label><input type="number" min="1" max="12" className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" value={subjectForm.difficulty || 5} onChange={e => setSubjectForm({...subjectForm, difficulty: parseInt(e.target.value)})} /></div>
                        <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Требуемый тип кабинета</label><select className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" value={subjectForm.requiredRoomType} onChange={e => setSubjectForm({...subjectForm, requiredRoomType: e.target.value})}>{ROOM_TYPES.map(type => <option key={type} value={type}>{type}</option>)}</select></div>
                    </>)}

                    {activeTab === 'classes' && (<>
                        <input className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" placeholder="Название класса (5А)" value={classForm.name || ''} onChange={e => setClassForm({...classForm, name: e.target.value})} />
                        <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Количество учеников</label><input type="number" className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" value={classForm.studentsCount || 25} onChange={e => setClassForm({...classForm, studentsCount: parseInt(e.target.value)})} /></div>
                        <div className="grid grid-cols-2 gap-3"><button onClick={() => setClassForm({...classForm, shift: Shift.First})} className={`p-3 rounded-xl border text-sm font-bold transition-all ${classForm.shift === Shift.First ? 'border-indigo-600 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400' : 'border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400'}`}>1 смена</button><button onClick={() => setClassForm({...classForm, shift: Shift.Second})} className={`p-3 rounded-xl border text-sm font-bold transition-all ${classForm.shift === Shift.Second ? 'border-indigo-600 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400' : 'border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400'}`}>2 смена</button></div>
                    </>)}

                    {activeTab === 'rooms' && (<>
                        <input className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" placeholder="Номер/Название (напр. 101)" value={roomForm.name || ''} onChange={e => setRoomForm({...roomForm, name: e.target.value})} />
                        <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Вместимость (мест)</label><input type="number" className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" value={roomForm.capacity || 30} onChange={e => setRoomForm({...roomForm, capacity: parseInt(e.target.value)})} /></div>
                        <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Тип кабинета</label><select className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" value={roomForm.type} onChange={e => setRoomForm({...roomForm, type: e.target.value})}>{ROOM_TYPES.map(type => <option key={type} value={type}>{type}</option>)}</select></div>
                    </>)}

                    <div className="flex justify-end pt-4"><button onClick={handleSave} className="px-6 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 text-sm font-bold shadow-lg shadow-indigo-200 dark:shadow-none">Сохранить</button></div>
                </div>
            </Modal>
        </div>
    );
};
</file>

<file path="src/pages/Login.tsx">
import { useState, useEffect } from 'react';
import { auth } from '../services/firebase';
import { useAuth } from '../context/AuthContext';
import { Icon } from '../components/Icons';
import { useNavigate } from 'react-router-dom';
// FIX: Removed Firebase v9 modular import, switched to compat/v8 syntax.
// import { signInWithEmailAndPassword } from 'firebase/auth';

export const LoginPage = () => {
    const { setGuestRole, role, loading: authLoading } = useAuth();
    const navigate = useNavigate();
    const [mode, setMode] = useState<'select' | 'teacher' | 'admin'>('select');
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        // Если аутентификация не в процессе загрузки и роль установлена (т.е. вход успешен),
        // перенаправляем пользователя.
        if (!authLoading && role) {
            if (role === 'admin' || role === 'teacher') {
                navigate('/dashboard');
            }
            // Для 'guest' навигация происходит в handleParentLogin
        }
    }, [role, authLoading, navigate]);

    const handleLogin = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        if (!auth) {
            setError("Firebase недоступен. Проверьте настройки.");
            setLoading(false);
            return;
        }

        try {
            let loginEmail = email;
            
            if (mode === 'teacher') {
                loginEmail = 'teacher@gymnasium22.com';
            }

            await auth.signInWithEmailAndPassword(loginEmail, password);
            // Навигация произойдет автоматически через useEffect после смены 'role'
            
        } catch (err: any) {
            console.error("Firebase Auth Error:", err);
            const errorCode = err.code;
            
            let friendlyMessage = 'Произошла неизвестная ошибка входа.';
            switch (errorCode) {
                case 'auth/invalid-credential':
                case 'auth/wrong-password':
                case 'auth/user-not-found':
                    friendlyMessage = 'Неверный логин или пароль. Проверьте данные и попробуйте снова.';
                    break;
                case 'auth/invalid-email':
                    friendlyMessage = 'Некорректный формат email адреса.';
                    break;
                case 'auth/too-many-requests':
                    friendlyMessage = 'Слишком много попыток входа. Попробуйте позже.';
                    break;
                default:
                    friendlyMessage = 'Ошибка входа. Проверьте подключение к интернету или настройки Firebase.';
            }
            setError(friendlyMessage);
        } finally {
            setLoading(false);
        }
    };

    const handleParentLogin = () => {
        setGuestRole();
        navigate('/schedule');
    };

    return (
        <div className="min-h-screen bg-slate-50 dark:bg-slate-900 flex items-center justify-center p-4">
            <div className="bg-white dark:bg-slate-800 rounded-3xl shadow-xl max-w-md w-full p-8 transition-all">
                <div className="text-center mb-8">
                    <div className="inline-flex p-4 bg-indigo-100 dark:bg-indigo-900/30 rounded-2xl text-indigo-600 dark:text-indigo-400 mb-4">
                        <Icon name="GraduationCap" size={48} />
                    </div>
                    <h1 className="text-2xl font-black text-slate-800 dark:text-white">Gymnasium Manager</h1>
                    <p className="text-slate-500 dark:text-slate-400">Выберите режим входа</p>
                </div>

                {mode === 'select' && (
                    <div className="space-y-3">
                        <button onClick={handleParentLogin} className="w-full p-4 rounded-xl border-2 border-slate-100 dark:border-slate-700 hover:border-emerald-500 dark:hover:border-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 group transition-all text-left flex items-center gap-4">
                            <div className="bg-emerald-100 dark:bg-emerald-900/50 p-3 rounded-lg text-emerald-600 dark:text-emerald-400 group-hover:scale-110 transition-transform"><Icon name="Users" size={24}/></div>
                            <div>
                                <div className="font-bold text-slate-800 dark:text-white group-hover:text-emerald-700 dark:group-hover:text-emerald-400">Родитель / Ученик</div>
                                <div className="text-xs text-slate-500 dark:text-slate-400">Только просмотр расписания</div>
                            </div>
                        </button>

                        <button onClick={() => setMode('teacher')} className="w-full p-4 rounded-xl border-2 border-slate-100 dark:border-slate-700 hover:border-indigo-500 dark:hover:border-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 group transition-all text-left flex items-center gap-4">
                            <div className="bg-indigo-100 dark:bg-indigo-900/50 p-3 rounded-lg text-indigo-600 dark:text-indigo-400 group-hover:scale-110 transition-transform"><Icon name="BookOpen" size={24}/></div>
                            <div>
                                <div className="font-bold text-slate-800 dark:text-white group-hover:text-indigo-700 dark:group-hover:text-indigo-400">Учитель</div>
                                <div className="text-xs text-slate-500 dark:text-slate-400">Вход по общему паролю</div>
                            </div>
                        </button>

                        <button onClick={() => setMode('admin')} className="w-full p-4 rounded-xl border-2 border-slate-100 dark:border-slate-700 hover:border-purple-500 dark:hover:border-purple-500 hover:bg-purple-50 dark:hover:bg-purple-900/20 group transition-all text-left flex items-center gap-4">
                            <div className="bg-purple-100 dark:bg-purple-900/50 p-3 rounded-lg text-purple-600 dark:text-purple-400 group-hover:scale-110 transition-transform"><Icon name="Settings" size={24}/></div>
                            <div>
                                <div className="font-bold text-slate-800 dark:text-white group-hover:text-purple-700 dark:group-hover:text-purple-400">Администратор</div>
                                <div className="text-xs text-slate-500 dark:text-slate-400">Полный доступ (логин/пароль)</div>
                            </div>
                        </button>
                    </div>
                )}

                {mode !== 'select' && (
                    <form onSubmit={handleLogin} className="space-y-4 animate-fade-in">
                        <div className="flex items-center gap-2 mb-4">
                            <button type="button" onClick={() => { setMode('select'); setError(''); }} className="p-2 -ml-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><Icon name="ArrowRight" className="rotate-180" size={20}/></button>
                            <h2 className="font-bold text-lg dark:text-white">{mode === 'teacher' ? 'Вход для учителей' : 'Вход для администратора'}</h2>
                        </div>
                        
                        {mode === 'admin' && (
                            <div>
                                <label className="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Email</label>
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full p-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 dark:text-white outline-none focus:ring-2 ring-indigo-500" autoFocus required />
                            </div>
                        )}

                        <div>
                            <label className="block text-xs font-bold uppercase text-slate-500 dark:text-slate-400 mb-1">Пароль</label>
                            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 dark:text-white outline-none focus:ring-2 ring-indigo-500" required />
                        </div>

                        {error && <div className="text-red-500 text-sm font-bold text-center bg-red-50 dark:bg-red-900/20 p-2 rounded-lg">{error}</div>}

                        <button type="submit" disabled={loading || authLoading} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 dark:shadow-none flex items-center justify-center gap-2 disabled:opacity-50">
                            {(loading || authLoading) && <Icon name="Loader" className="animate-spin" size={20}/>}
                            Войти
                        </button>
                    </form>
                )}
            </div>
        </div>
    );
};
</file>

<file path="src/services/db.ts">
import { AppData } from '../types';
import { INITIAL_DATA } from '../constants';
import { firestoreDB, auth } from './firebase';

// Названия коллекций в Firebase ДОЛЖНЫ совпадать с firestore.rules
const MAIN_COLLECTION = 'schoolData'; // Было 'schools'
const MAIN_DOC_ID = 'main'; // Было 'root'
const PUBLIC_COLLECTION = 'publicSchedules'; // Было 'public_schedules'

export const dbService = {
    // Метод open больше не нужен для Firestore, но оставим заглушку если где-то используется напрямую (хотя не должно)
    open: async () => { console.log('Firestore connected'); return {} as any; },
    
    save: async (data: AppData) => {
        if (!firestoreDB) {
            console.error("Database not initialized (missing API key)");
            return;
        }
        
        // Проверка прав перед записью, чтобы избежать лишних запросов, которые все равно будут отклонены
        // Правила: allow write: if request.auth != null && request.auth.token.email == "admin@gymnasium22.com";
        const user = auth?.currentUser;
        if (!user || user.email !== "admin@gymnasium22.com") {
            console.warn("Отменено сохранение: У текущего пользователя нет прав на запись (нужен admin@gymnasium22.com).");
            return;
        }

        try {
            // Firestore не любит undefined, JSON.parse(JSON.stringify(data)) - быстрый способ очистить их
            const cleanData = JSON.parse(JSON.stringify(data));
            await firestoreDB.collection(MAIN_COLLECTION).doc(MAIN_DOC_ID).set(cleanData);
        } catch (error: any) {
            console.error("Ошибка сохранения в Firebase:", error);
            if (error.code === 'permission-denied') {
                alert("Ошибка доступа: Недостаточно прав для сохранения данных в облаке.");
            }
            throw error;
        }
    },

    load: async (): Promise<AppData> => {
        if (!firestoreDB) {
            console.warn("Database not initialized. Returning initial data.");
            return INITIAL_DATA;
        }

        try {
            const doc = await firestoreDB.collection(MAIN_COLLECTION).doc(MAIN_DOC_ID).get();
            
            if (doc.exists) {
                const loadedData = doc.data() as Partial<AppData>;
                // Объединяем загруженные данные с начальными, чтобы избежать ошибок отсутствующих полей при обновлении структуры
                const mergedData = { ...INITIAL_DATA, ...loadedData };
                
                // Дополнительная проверка вложенных объектов настроек
                if (loadedData.settings) { 
                    mergedData.settings = { ...INITIAL_DATA.settings, ...loadedData.settings };
                }
                return mergedData;
            } else {
                // Если документа нет в облаке, возвращаем начальные данные
                return INITIAL_DATA;
            }
        } catch (error: any) {
            console.error("Ошибка загрузки из Firebase:", error);
            if (error.code === 'permission-denied') {
                console.error("Нет прав на чтение. Проверьте правила (allow read: if true).");
            }
            // В случае ошибки (например, нет прав или интернета) возвращаем начальные данные, чтобы приложение не падало
            return INITIAL_DATA;
        }
    },

    subscribe: (
        onNext: (data: AppData) => void,
        onError: (error: any) => void
    ) => {
        if (!firestoreDB) {
            console.warn("Database not initialized. Cannot subscribe.");
            return () => {};
        }

        // Подписываемся на изменения документа
        return firestoreDB.collection(MAIN_COLLECTION).doc(MAIN_DOC_ID).onSnapshot(
            (doc) => {
                if (doc.exists) {
                    const loadedData = doc.data() as Partial<AppData>;
                    const mergedData = { ...INITIAL_DATA, ...loadedData };
                    if (loadedData.settings) {
                        mergedData.settings = { ...INITIAL_DATA.settings, ...loadedData.settings };
                    }
                    onNext(mergedData);
                } else {
                    // Документа нет, возвращаем начальные данные
                    onNext(INITIAL_DATA);
                }
            },
            (error) => {
                console.error("Firestore subscription error:", error);
                if (error.code === 'permission-denied') {
                    console.error("Нет прав на чтение (subscribe).");
                }
                onError(error);
            }
        );
    },

    exportJson: (data: AppData) => {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `gymnasium_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    },

    setPublicData: async (id: string, data: AppData) => {
        if (!firestoreDB) throw new Error("Database not initialized");
        
        const user = auth?.currentUser;
        if (!user || user.email !== "admin@gymnasium22.com") {
             throw new Error("Только администратор может публиковать расписание.");
        }

        try {
            const publicDataSubset = {
                subjects: data.subjects,
                teachers: data.teachers.map(t => ({ 
                    id: t.id,
                    name: t.name,
                    subjectIds: t.subjectIds,
                    shifts: t.shifts,
                    unavailableDates: [], 
                    telegramChatId: '', 
                    birthDate: undefined, 
                    absenceReasons: undefined 
                })),
                classes: data.classes,
                rooms: data.rooms,
                schedule: data.schedule,
                substitutions: data.substitutions,
                bellSchedule: data.bellSchedule,
                settings: { 
                    telegramToken: '', 
                    publicScheduleId: data.settings.publicScheduleId
                }
            };
            const cleanData = JSON.parse(JSON.stringify(publicDataSubset));
            await firestoreDB.collection(PUBLIC_COLLECTION).doc(id).set(cleanData);
        } catch (error) {
            console.error("Ошибка публикации расписания:", error);
            throw error;
        }
    },

    getPublicData: async (id: string): Promise<AppData | null> => {
        if (!firestoreDB) return null;
        try {
            const doc = await firestoreDB.collection(PUBLIC_COLLECTION).doc(id).get();
            if (doc.exists) {
                return doc.data() as AppData;
            }
            return null;
        } catch (error) {
            console.error("Ошибка получения публичного расписания:", error);
            return null;
        }
    },

    deletePublicData: async (id: string) => {
        if (!firestoreDB) throw new Error("Database not initialized");
        
        const user = auth?.currentUser;
        if (!user || user.email !== "admin@gymnasium22.com") {
             throw new Error("Только администратор может удалять публичное расписание.");
        }

        try {
            await firestoreDB.collection(PUBLIC_COLLECTION).doc(id).delete();
        } catch (error) {
            console.error("Ошибка удаления публичного расписания:", error);
            throw error;
        }
    }
};
</file>

<file path="src/services/firebase.ts">
import firebase from "firebase/compat/app";
import "firebase/compat/firestore";
import "firebase/compat/auth";

// Environment variables from .env file
const apiKey = import.meta.env.VITE_FIREBASE_API_KEY;
const authDomain = import.meta.env.VITE_FIREBASE_AUTH_DOMAIN;
const projectId = import.meta.env.VITE_FIREBASE_PROJECT_ID;
const storageBucket = import.meta.env.VITE_FIREBASE_STORAGE_BUCKET;
const messagingSenderId = import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID;
const appId = import.meta.env.VITE_FIREBASE_APP_ID;

const firebaseConfig = {
  apiKey,
  authDomain,
  projectId,
  storageBucket,
  messagingSenderId,
  appId
};

let app: firebase.app.App | undefined;
let firestoreDB: firebase.firestore.Firestore | undefined;
let auth: firebase.auth.Auth | undefined;

// Check if config is loaded
if (!firebaseConfig.apiKey) {
  console.error("CRITICAL ERROR: Firebase API Key is missing. Ensure your .env file exists and VITE_ variables are set.");
} else {
  try {
    // Prevent multiple initializations
    if (!firebase.apps.length) {
      app = firebase.initializeApp(firebaseConfig);
    } else {
      app = firebase.app();
    }
    
    firestoreDB = firebase.firestore();
    auth = firebase.auth();
    console.log("Firebase initialized successfully");
  } catch (error) {
    console.error("Firebase initialization failed:", error);
  }
}

export { firestoreDB, auth };
</file>

<file path="src/tailwind.config.js">
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  darkMode: 'class',
  theme: {
    extend: {
      fontFamily: { sans: ['Manrope', 'sans-serif'] },
      colors: {
        primary: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' },
        dark: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' }
      },
      animation: {
        'fade-in': 'fadeIn 0.3s ease-out forwards',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0', transform: 'translateY(5px)' },
          '100%': { opacity: '1', transform: 'translateY(0)' },
        }
      }
    },
  },
  plugins: [],
}
</file>

<file path="src/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noFallthroughCasesInSwitch": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    },
    "types": ["vite/client"]
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
</file>

<file path="src/tsconfig.node.json">
{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}
</file>

<file path="src/vite-env.d.ts">
// Fix: Manually define types for Vite environment variables (`import.meta.env`).
// The default `/// <reference types="vite/client" />` was causing a "Cannot find type definition" error.
// This workaround provides the necessary types directly, resolving errors when accessing `import.meta.env`.
interface ImportMetaEnv {
  readonly VITE_FIREBASE_API_KEY: string;
  readonly VITE_FIREBASE_AUTH_DOMAIN: string;
  readonly VITE_FIREBASE_PROJECT_ID: string;
  readonly VITE_FIREBASE_STORAGE_BUCKET: string;
  readonly VITE_FIREBASE_MESSAGING_SENDER_ID: string;
  readonly VITE_FIREBASE_APP_ID: string;
}

interface ImportMeta {
  readonly env: ImportMetaEnv;
}
</file>

<file path="src/vite.config.ts">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  base: '/zamenyVStest/', 
})
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  darkMode: 'class',
  theme: {
    extend: {
      fontFamily: { sans: ['Manrope', 'sans-serif'] },
      colors: {
        primary: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' },
        dark: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' }
      },
      animation: {
        'fade-in': 'fadeIn 0.3s ease-out forwards',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0', transform: 'translateY(5px)' },
          '100%': { opacity: '1', transform: 'translateY(0)' },
        }
      }
    },
  },
  plugins: [],
}
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noFallthroughCasesInSwitch": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    },
    "types": ["vite/client"]
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
</file>

<file path="tsconfig.node.json">
{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}
</file>

<file path="package.json">
{
  "name": "zameny-vs-test",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "homepage": "https://Gymnasium22.github.io/zamenygymn/",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "predeploy": "npm run build",
    "deploy": "gh-pages -d dist -r https://github.com/Gymnasium22/zamenygymn.git"
  },
  "dependencies": {
    "firebase": "^10.12.2",
    "html2canvas": "^1.4.1",
    "qrcode.react": "^3.1.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.22.0",
    "use-media": "^1.4.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.64",
    "@types/react-dom": "^18.2.21",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.18",
    "gh-pages": "^6.1.1",
    "postcss": "^8.4.35",
    "tailwindcss": "^3.4.1",
    "typescript": "^5.4.2",
    "vite": "^5.1.5"
  }
}
</file>

<file path="README.md">
<div align="center">
<img width="1200" height="475" alt="GHBanner" src="https://github.com/user-attachments/assets/0aa67016-6eaf-458a-adb2-6e31a0763ed6" />
</div>

# Run and deploy your AI Studio app

This contains everything you need to run your app locally.

View your app in AI Studio: https://ai.studio/apps/drive/1_NTRn2lk3G2opVT8WP-MLeib0bmYKFx0

## Run Locally

**Prerequisites:**  Node.js


1. Install dependencies:
   `npm install`
2. Set the `GEMINI_API_KEY` in [.env.local](.env.local) to your Gemini API key
3. Run the app:
   `npm run dev`
</file>

<file path="src/constants.ts">
import { AppData, Shift } from './types';

export const DEFAULT_BELLS = [
    { shift: Shift.First, period: 1, start: "08:00", end: "08:45", day: "default" },
    { shift: Shift.First, period: 2, start: "08:55", end: "09:40", day: "default" },
    { shift: Shift.First, period: 3, start: "09:50", end: "10:35", day: "default" },
    { shift: Shift.First, period: 4, start: "10:55", end: "11:40", day: "default" },
    { shift: Shift.First, period: 5, start: "11:50", end: "12:35", day: "default" },
    { shift: Shift.First, period: 6, start: "12:40", end: "13:25", day: "default" },
    { shift: Shift.First, period: 7, start: "13:30", end: "14:15", day: "default" },
    { shift: Shift.Second, period: 0, start: "13:30", end: "14:15", day: "default" },
    { shift: Shift.Second, period: 1, start: "14:20", end: "15:05", day: "default" },
    { shift: Shift.Second, period: 2, start: "15:15", end: "16:00", day: "default" },
    { shift: Shift.Second, period: 3, start: "16:10", end: "16:55", day: "default" },
    { shift: Shift.Second, period: 4, start: "17:05", end: "17:50", day: "default" },
    { shift: Shift.Second, period: 5, start: "18:00", end: "18:45", day: "default" },
    { shift: Shift.Second, period: 6, start: "18:50", end: "19:35", day: "default" }
];

export const INITIAL_DATA: AppData = {
    subjects: [
        { id: 's1', name: 'Математика', color: '#e0e7ff', difficulty: 11, requiredRoomType: 'Обычный' },
        { id: 's2', name: 'Русский язык', color: '#dcfce7', difficulty: 10, requiredRoomType: 'Обычный' },
    ],
    teachers: [],
    classes: [
        { id: 'c1', name: '5А', shift: Shift.First, studentsCount: 25 },
        { id: 'c2', name: '6Б', shift: Shift.Second, studentsCount: 28 },
    ],
    rooms: [
        { id: 'r1', name: '101', capacity: 30, type: 'Обычный' },
    ],
    schedule: [], // 1 полугодие
    schedule2ndHalf: [], // 2 полугодие
    substitutions: [],
    bellSchedule: DEFAULT_BELLS,
    settings: {
        telegramToken: '',
        publicScheduleId: null,
        feedbackChatId: ''
    }
};
</file>

<file path="src/context/DataContext.tsx">
import React, { createContext, useContext, useState, useEffect, useCallback, useMemo } from 'react';
import { AppData, Shift, StaticAppData, ScheduleAndSubstitutionData, ScheduleItem } from '../types';
import { INITIAL_DATA, DEFAULT_BELLS } from '../constants';
import { dbService } from '../services/db';
import { useAuth } from './AuthContext';

interface FullDataContextType {
    data: AppData;
    isLoading: boolean;
    saveData: (newData: Partial<AppData>, addToHistory?: boolean) => Promise<void>;
    resetData: () => Promise<void>;
    undo: () => void;
    redo: () => void;
    canUndo: boolean;
    canRedo: boolean;
}

const FullDataContext = createContext<FullDataContextType | undefined>(undefined);

export const DataProvider: React.FC<{ children: React.ReactNode; initialData?: AppData }> = ({ children, initialData }) => {
    const [data, setInternalData] = useState<AppData>(INITIAL_DATA);
    const [isLoading, setIsLoading] = useState(true);
    const [history, setHistory] = useState<AppData[]>([]);
    const [historyPointer, setHistoryPointer] = useState(-1);
    
    // Получаем user и role для проверки прав
    const { user, role, loading: authLoading } = useAuth();

    useEffect(() => {
        // Если переданы начальные данные (например, для публичного просмотра), используем их
        if (initialData) {
            setInternalData(initialData);
            setHistory([initialData]);
            setHistoryPointer(0);
            setIsLoading(false);
            return;
        }

        // Ждем инициализации аутентификации
        if (authLoading) return;

        // Разрешаем загрузку, если есть пользователь ИЛИ если это гость (родитель)
        // ВАЖНО: Правила Firestore должны разрешать чтение (allow read: if true) для работы гостей
        const canLoadData = user || role === 'guest';

        if (!canLoadData) {
            // Если не авторизован и не гость - используем локальные дефолтные данные
            setInternalData(INITIAL_DATA);
            setIsLoading(false);
            return;
        }

        setIsLoading(true);

        // Используем подписку вместо одноразовой загрузки (load)
        const unsubscribe = dbService.subscribe(
            (loaded) => {
                const fixedData = { ...INITIAL_DATA, ...loaded };
                
                // Нормализация данных для предотвращения ошибок undefined
                if (!fixedData.teachers) fixedData.teachers = [];
                fixedData.teachers = fixedData.teachers.map(t => ({ shifts: [Shift.First, Shift.Second], telegramChatId: '', ...t }));

                if (!fixedData.schedule) fixedData.schedule = [];
                if (!fixedData.schedule2ndHalf) fixedData.schedule2ndHalf = []; // Инициализация 2 полугодия
                if (!fixedData.substitutions) fixedData.substitutions = [];
                if (!fixedData.bellSchedule) fixedData.bellSchedule = DEFAULT_BELLS;
                
                if (!fixedData.settings) fixedData.settings = INITIAL_DATA.settings;
                else fixedData.settings = { ...INITIAL_DATA.settings, ...fixedData.settings };
                
                setInternalData(fixedData);
                
                // Инициализируем историю только при первой загрузке, чтобы не сбивать undo/redo при внешних обновлениях
                // (хотя в реальном времени undo/redo сложнее, здесь простая реализация)
                setHistory(prev => {
                    if (prev.length === 0) return [fixedData];
                    return prev; 
                });
                setHistoryPointer(prev => {
                    if (prev === -1) return 0;
                    return prev;
                });
                
                setIsLoading(false);
            },
            (error) => {
                console.error("Failed to subscribe to data:", error); 
                // В случае ошибки (например, нет прав) загружаем дефолтные, чтобы приложение работало
                setInternalData(INITIAL_DATA);
                setIsLoading(false); 
            }
        );

        // Очистка подписки при размонтировании или смене пользователя
        return () => {
            if (unsubscribe) unsubscribe();
        };

    }, [initialData, user, role, authLoading]); 

    const saveData = useCallback(async (newData: Partial<AppData>, addToHistory = true) => {
        // Запрещаем сохранение, если пользователь не авторизован (гости не могут сохранять)
        const isGuest = !user && role === 'guest';
        
        const mergedData = { ...data, ...newData };
        setInternalData(mergedData);
        
        // Сохраняем в облако только если это не публичный просмотр и пользователь авторизован
        if (!initialData && user && !isGuest) {
            try {
                await dbService.save(mergedData);
            } catch (e) {
                console.error("Save failed silently in background", e);
            }
        } else if (isGuest) {
            console.warn("Гости не могут сохранять изменения в базу данных.");
        }

        if (addToHistory) {
            const newHistory = history.slice(0, historyPointer + 1);
            newHistory.push(mergedData);
            if (newHistory.length > 50) newHistory.shift(); 
            setHistory(newHistory);
            setHistoryPointer(newHistory.length - 1);
        }
    }, [data, history, historyPointer, user, role, initialData]);

    const undo = useCallback(async () => {
        if (historyPointer > 0) {
            const prevData = history[historyPointer - 1];
            setHistoryPointer(historyPointer - 1);
            setInternalData(prevData);
            if (!initialData && user) await dbService.save(prevData);
        }
    }, [history, historyPointer, user, initialData]);

    const redo = useCallback(async () => {
        if (historyPointer < history.length - 1) {
            const nextData = history[historyPointer + 1];
            setHistoryPointer(historyPointer + 1);
            setInternalData(nextData);
            if (!initialData && user) await dbService.save(nextData);
        }
    }, [history, historyPointer, user, initialData]);

    const resetData = useCallback(async () => { await saveData(INITIAL_DATA); }, [saveData]);

    const contextValue = useMemo(() => ({
        data, isLoading, saveData, resetData,
        undo, redo, canUndo: historyPointer > 0, canRedo: historyPointer < history.length - 1
    }), [data, isLoading, saveData, resetData, undo, redo, historyPointer]);

    return (
        <FullDataContext.Provider value={contextValue}>
            {children}
        </FullDataContext.Provider>
    );
};

const useFullData = () => {
    const context = useContext(FullDataContext);
    if (!context) throw new Error("useFullData must be used within DataProvider");
    return context;
};

interface StaticDataContextType extends StaticAppData {
    saveStaticData: (newData: Partial<StaticAppData>, addToHistory?: boolean) => Promise<void>;
}

interface ScheduleContextType extends ScheduleAndSubstitutionData {
    saveScheduleData: (newData: Partial<ScheduleAndSubstitutionData>, addToHistory?: boolean) => Promise<void>;
}

const StaticDataContext = createContext<StaticDataContextType | undefined>(undefined);
const ScheduleDataContext = createContext<ScheduleContextType | undefined>(undefined);

export const StaticDataProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const { data, saveData } = useFullData();

    const staticData: StaticAppData = useMemo(() => ({
        subjects: data.subjects,
        teachers: data.teachers,
        classes: data.classes,
        rooms: data.rooms,
        bellSchedule: data.bellSchedule,
        settings: data.settings,
    }), [data.subjects, data.teachers, data.classes, data.rooms, data.bellSchedule, data.settings]);

    const saveStaticData = useCallback(async (newData: Partial<StaticAppData>, addToHistory?: boolean) => {
        await saveData(newData, addToHistory);
    }, [saveData]);

    const contextValue = useMemo(() => ({
        ...staticData,
        saveStaticData,
    }), [staticData, saveStaticData]);

    return (
        <StaticDataContext.Provider value={contextValue}>
            {children}
        </StaticDataContext.Provider>
    );
};

export const ScheduleDataProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const { data, saveData } = useFullData();

    // Логика определения текущего семестра
    // 1 полугодие: Сентябрь (8) - Декабрь (11)
    // 2 полугодие: Январь (0) - Май (4)
    // Лето (5,6,7): Можно настроить по умолчанию на 1 или 2. Пусть будет 1.
    const currentMonth = new Date().getMonth();
    const isSecondSemester = currentMonth >= 0 && currentMonth <= 4;

    // Выбираем активное расписание для отображения в "Рабочем столе", "Заменах" и т.д.
    const activeSchedule = isSecondSemester ? (data.schedule2ndHalf || []) : data.schedule;

    const saveSemesterSchedule = useCallback(async (semester: 1 | 2, newData: ScheduleItem[]) => {
        if (semester === 1) {
            await saveData({ schedule: newData });
        } else {
            await saveData({ schedule2ndHalf: newData });
        }
    }, [saveData]);

    const saveScheduleData = useCallback(async (newData: Partial<ScheduleAndSubstitutionData>, addToHistory?: boolean) => {
        // Этот метод используется для обратной совместимости, если кто-то вызывает saveScheduleData({schedule: ...})
        // Он сохранит в "текущий" (1 полугодие в структуре данных, так как 'schedule' мапится туда)
        // Но лучше использовать saveSemesterSchedule
        await saveData(newData as any, addToHistory);
    }, [saveData]);

    const scheduleData: ScheduleAndSubstitutionData = useMemo(() => ({
        schedule: activeSchedule, // Автоматическое "активное" расписание
        schedule1: data.schedule,
        schedule2: data.schedule2ndHalf || [],
        substitutions: data.substitutions,
        saveSemesterSchedule,
        saveScheduleData
    }), [activeSchedule, data.schedule, data.schedule2ndHalf, data.substitutions, saveSemesterSchedule, saveScheduleData]);

    const contextValue = useMemo(() => ({
        ...scheduleData,
        saveScheduleData,
    }), [scheduleData, saveScheduleData]);

    return (
        <ScheduleDataContext.Provider value={contextValue}>
            {children}
        </ScheduleDataContext.Provider>
    );
};


export const useStaticData = () => {
    const context = useContext(StaticDataContext);
    if (!context) throw new Error("useStaticData must be used within StaticDataProvider");
    const fullContext = useFullData(); 
    return { ...context, isLoading: fullContext.isLoading, undo: fullContext.undo, redo: fullContext.redo, canUndo: fullContext.canUndo, canRedo: fullContext.canRedo, resetData: fullContext.resetData };
};

export const useScheduleData = () => {
    const context = useContext(ScheduleDataContext);
    if (!context) throw new Error("useScheduleData must be used within ScheduleDataProvider");
    const fullContext = useFullData(); 
    return { ...context, isLoading: fullContext.isLoading, undo: fullContext.undo, redo: fullContext.redo, canUndo: fullContext.canUndo, canRedo: fullContext.canRedo, resetData: fullContext.resetData };
};

export const useData = () => {
    const context = useContext(FullDataContext);
    if (!context) throw new Error("useData must be used within DataProvider");
    return context;
};
</file>

<file path="src/pages/Admin.tsx">
import { useState, useMemo, useEffect } from 'react';
import { useStaticData, useScheduleData } from '../context/DataContext'; 
import { Icon } from '../components/Icons';
import { Shift, SHIFT_PERIODS, DAYS } from '../types';

export const AdminPage = () => {
    const { subjects, teachers, classes, rooms, settings, saveStaticData } = useStaticData(); 
    // Получаем оба расписания, чтобы выбирать нужное в зависимости от даты
    const { schedule1, schedule2 } = useScheduleData();

    const [activeTab, setActiveTab] = useState('teachers');
    const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
    
    const [teacherShift, setTeacherShift] = useState(Shift.First);
    const [afterPeriod, setAfterPeriod] = useState(1);
    const [roomShift, setRoomShift] = useState(Shift.First);
    const [roomPeriod, setRoomPeriod] = useState(1);

    const [telegramToken, setTelegramToken] = useState('');
    const [feedbackChatId, setFeedbackChatId] = useState('');

    // Определяем актуальное расписание на основе выбранной даты
    const activeSchedule = useMemo(() => {
        const month = new Date(selectedDate).getMonth();
        // Январь(0) - Май(4) = 2 полугодие. Остальное = 1 полугодие
        const isSecondSemester = month >= 0 && month <= 4;
        return isSecondSemester ? schedule2 : schedule1;
    }, [selectedDate, schedule1, schedule2]);

    useEffect(() => {
        if (settings) {
            setTelegramToken(settings.telegramToken || '');
            setFeedbackChatId(settings.feedbackChatId || '');
        }
    }, [settings]);

    useEffect(() => {
        setAfterPeriod(teacherShift === Shift.First ? 1 : 0);
    }, [teacherShift]);

    useEffect(() => {
        setRoomPeriod(roomShift === Shift.First ? 1 : 0);
    }, [roomShift]);

    const selectedDayOfWeek = useMemo(() => {
        const idx = new Date(selectedDate).getDay();
        if (idx === 0 || idx === 6) return null;
        return DAYS[idx - 1];
    }, [selectedDate]);

    const periodsForShift = SHIFT_PERIODS[teacherShift];

    const freeTeachers = useMemo(() => {
        if (!selectedDayOfWeek) return [];
        return teachers.filter(teacher => {
            if (teacher.shifts && !teacher.shifts.includes(teacherShift)) return false;
            if (teacher.unavailableDates.includes(selectedDate)) return false;
            // Используем activeSchedule вместо schedule
            const hasLateLessons = activeSchedule.some(s => 
                s.teacherId === teacher.id && 
                s.day === selectedDayOfWeek && 
                s.period > afterPeriod && 
                s.shift === teacherShift
            );
            return !hasLateLessons;
        }).sort((a, b) => a.name.localeCompare(b.name));
    }, [teachers, selectedDate, selectedDayOfWeek, afterPeriod, teacherShift, activeSchedule]);

    const freeRooms = useMemo(() => {
        if (!selectedDayOfWeek) return [];
        const occupiedRoomIds = new Set();
        // Используем activeSchedule вместо schedule
        activeSchedule.forEach(s => {
            if (s.day === selectedDayOfWeek && s.period === roomPeriod && s.shift === roomShift && s.roomId) {
                occupiedRoomIds.add(s.roomId);
            }
        });
        const availableDictRooms = rooms.filter(r => !occupiedRoomIds.has(r.id)).map(r => r.name);
        return availableDictRooms;
    }, [activeSchedule, rooms, selectedDayOfWeek, roomPeriod, roomShift]);

    const saveSettings = async () => {
        await saveStaticData({ settings: { ...settings, telegramToken, feedbackChatId } });
        alert("Настройки сохранены!");
    };

    return (
        <div className="max-w-7xl mx-auto w-full pb-20">
            <div className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 mb-8">
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-6">
                    <h1 className="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-3">
                        <Icon name="Settings" className="text-indigo-600 dark:text-indigo-400" />
                        Администрация и Поиск
                    </h1>
                     <div className="flex gap-2 bg-slate-100 dark:bg-slate-700 p-1 rounded-xl">
                        <button onClick={() => setActiveTab('teachers')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'teachers' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700'}`}>Учителя</button>
                        <button onClick={() => setActiveTab('rooms')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'rooms' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700'}`}>Кабинеты</button>
                        <button onClick={() => setActiveTab('settings')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'settings' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700'}`}>Настройки</button>
                    </div>
                </div>

                {activeTab !== 'settings' && (
                     <div className="mb-6">
                         <label className="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-2 tracking-wider">Дата</label>
                         <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="border border-slate-200 dark:border-slate-600 p-3 rounded-xl font-bold outline-none focus:border-indigo-500 bg-transparent dark:text-white w-full md:w-auto min-w-[200px]" />
                     </div>
                )}
                
                {activeTab === 'teachers' && (
                    <div className="flex flex-wrap gap-8 items-end">
                        <div>
                            <label className="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-2 tracking-wider">Смена</label>
                            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-xl">
                                <button onClick={() => setTeacherShift(Shift.First)} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${teacherShift === Shift.First ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>1 смена</button>
                                <button onClick={() => setTeacherShift(Shift.Second)} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${teacherShift === Shift.Second ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>2 смена</button>
                            </div>
                        </div>
                        <div>
                            <label className="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-2 tracking-wider">Свободен после урока №</label>
                            <div className="flex items-center gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-xl">
                                {periodsForShift.map(num => (
                                    <button key={num} onClick={() => setAfterPeriod(num)} className={`w-10 h-10 flex items-center justify-center rounded-lg font-bold text-sm transition-all ${afterPeriod === num ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700'}`}>{num}</button>
                                ))}
                            </div>
                        </div>
                    </div>
                )}

                {activeTab === 'rooms' && (
                    <div className="flex flex-wrap gap-8 items-end">
                         <div>
                            <label className="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-2 tracking-wider">Смена</label>
                            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-xl">
                                <button onClick={() => setRoomShift(Shift.First)} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${roomShift === Shift.First ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>1 смена</button>
                                <button onClick={() => setRoomShift(Shift.Second)} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${roomShift === Shift.Second ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>2 смена</button>
                            </div>
                         </div>
                         <div>
                            <label className="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-2 tracking-wider">Урок №</label>
                            <div className="flex items-center gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-xl">
                                {SHIFT_PERIODS[roomShift].map(num => (
                                    <button key={num} onClick={() => setRoomPeriod(num)} className={`w-10 h-10 flex items-center justify-center rounded-lg font-bold text-sm transition-all ${roomPeriod === num ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700'}`}>{num}</button>
                                ))}
                            </div>
                        </div>
                    </div>
                )}
                
                {activeTab === 'settings' && (
                    <div className="space-y-6 max-w-xl mt-6">
                        <div className="bg-slate-50 dark:bg-slate-700/30 p-6 rounded-2xl border border-slate-100 dark:border-slate-700">
                            <h3 className="font-bold text-lg mb-4 text-slate-800 dark:text-white">Интеграция с Telegram</h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Bot Token</label>
                                    <input 
                                        type="password" 
                                        value={telegramToken} 
                                        onChange={e => setTelegramToken(e.target.value)} 
                                        placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11"
                                        className="w-full border border-slate-200 dark:border-slate-600 p-3 rounded-xl text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" 
                                    />
                                    <p className="text-[10px] text-slate-400 mt-1">Токен от @BotFather</p>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Chat ID для обратной связи</label>
                                    <input 
                                        type="text" 
                                        value={feedbackChatId} 
                                        onChange={e => setFeedbackChatId(e.target.value)} 
                                        placeholder="-100123456789"
                                        className="w-full border border-slate-200 dark:border-slate-600 p-3 rounded-xl text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" 
                                    />
                                    <p className="text-[10px] text-slate-400 mt-1">ID чата или администратора, куда будут приходить сообщения из формы обратной связи</p>
                                </div>
                            </div>
                        </div>
                        <button onClick={saveSettings} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 dark:shadow-none flex items-center gap-2">
                            <Icon name="Save" size={20} /> Сохранить настройки
                        </button>
                    </div>
                )}
            </div>

            {activeTab === 'teachers' && (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    {freeTeachers.map(t => (
                        <div key={t.id} className="bg-white dark:bg-dark-800 p-5 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm flex items-center gap-4 hover:shadow-md transition-all">
                            <div className="w-12 h-12 rounded-full bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 flex items-center justify-center shrink-0">
                                <Icon name="CheckCircle" size={22} />
                            </div>
                            <div className="min-w-0">
                                <div className="font-bold text-slate-800 dark:text-slate-200 text-lg leading-tight truncate">{t.name}</div>
                                <div className="flex flex-wrap gap-1 mt-1.5">
                                    {t.subjectIds.slice(0, 2).map(sid => {
                                        const s = subjects.find(sub => sub.id === sid);
                                        return s ? <span key={sid} className="text-[10px] px-2 py-0.5 rounded bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 font-medium">{s.name}</span> : null
                                    })}
                                </div>
                            </div>
                        </div>
                    ))}
                    {freeTeachers.length === 0 && <div className="col-span-full py-12 text-center text-slate-400">Не найдено учителей, свободных после {afterPeriod} урока в {teacherShift}</div>}
                </div>
            )}

             {activeTab === 'rooms' && (
                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    {freeRooms.map(roomName => (
                        <div key={roomName} className="bg-white dark:bg-dark-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm text-center flex flex-col items-center justify-center hover:border-indigo-500 transition-all hover:shadow-md group">
                            <div className="w-10 h-10 rounded-full bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 flex items-center justify-center mb-2 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                                <Icon name="DoorOpen" size={20}/>
                            </div>
                            <div className="text-xl font-black text-slate-800 dark:text-white">{roomName}</div>
                            <div className="text-[10px] text-slate-400 dark:text-slate-500 font-bold uppercase tracking-wider mt-1">Свободен</div>
                        </div>
                    ))}
                    {freeRooms.length === 0 && (
                        <div className="col-span-full py-12 text-center text-slate-400">
                            <Icon name="AlertTriangle" size={48} className="mx-auto mb-4 text-slate-300 dark:text-slate-600"/>
                            <p>Нет свободных кабинетов в это время (или расписание не заполнено).</p>
                        </div>
                    )}
                </div>
            )}
        </div>
    );
};
</file>

<file path="src/pages/Reports.tsx">
import { useState, useMemo } from 'react';
import { useStaticData, useScheduleData } from '../context/DataContext';
import { Icon } from '../components/Icons';
import { BarChart } from '../components/UI';
import { DAYS } from '../types';

export const ReportsPage = () => {
    const { subjects, teachers, classes } = useStaticData();
    // Получаем оба расписания
    const { schedule1, schedule2, substitutions } = useScheduleData();
    
    const [reportTab, setReportTab] = useState('load');
    const [selectedClassId, setSelectedClassId] = useState(classes[0]?.id || '');
    
    // Состояние для выбора полугодия (по умолчанию текущее)
    const [selectedSemester, setSelectedSemester] = useState<1 | 2>(() => {
        const month = new Date().getMonth();
        return (month >= 0 && month <= 4) ? 2 : 1;
    });

    // Выбираем расписание на основе селектора
    const activeSchedule = useMemo(() => {
        return selectedSemester === 2 ? schedule2 : schedule1;
    }, [selectedSemester, schedule1, schedule2]);
    
    const tariffData = useMemo(() => { 
        const weeks = 4; 
        return teachers.map(t => { 
            // Используем activeSchedule вместо schedule
            const weeklyLessons = activeSchedule.filter(s => s.teacherId === t.id); 
            const weeklyHours = weeklyLessons.length; 
            const monthlyPlan = weeklyHours * weeks; 
            const subsTaken = substitutions.filter(s => s.replacementTeacherId === t.id).length; 
            const subsMissed = substitutions.filter(s => s.originalTeacherId === t.id).length; 
            const actualHours = monthlyPlan + subsTaken - subsMissed; 
            const subjectBreakdown: Record<string, number> = {}; 
            weeklyLessons.forEach(s => { 
                const subj = subjects.find(sub => sub.id === s.subjectId); 
                if(subj) subjectBreakdown[subj.name] = (subjectBreakdown[subj.name] || 0) + 1; 
            }); 
            return { id: t.id, name: t.name, weeklyHours, subsTaken, subsMissed, actualHours, subjectBreakdown }; 
        }).sort((a,b) => b.actualHours - a.actualHours); 
    }, [teachers, activeSchedule, substitutions, subjects]);

    const sanPinData = useMemo(() => { 
        if(!selectedClassId) return []; 
        return DAYS.map(day => { 
            // Используем activeSchedule вместо schedule
            const lessons = activeSchedule.filter(s => s.classId === selectedClassId && s.day === day); 
            const score = lessons.reduce((acc, curr) => { 
                const subj = subjects.find(s => s.id === curr.subjectId); 
                return acc + (subj?.difficulty || 5); 
            }, 0); 
            return { label: day, value: score }; 
        }); 
    }, [activeSchedule, subjects, selectedClassId]);

    const ratings = useMemo(() => { 
        const heroes = teachers.map(t => ({ 
            name: t.name, 
            count: substitutions.filter(s => s.replacementTeacherId === t.id).length 
        })).sort((a,b) => b.count - a.count).slice(0, 5); 
        
        const absentees = teachers.map(t => ({ 
            name: t.name, 
            count: t.unavailableDates.length 
        })).sort((a,b) => b.count - a.count).slice(0, 5); 
        
        return { heroes, absentees }; 
    }, [teachers, substitutions]);

    const downloadReport = () => { 
        let csv = ""; 
        if (reportTab === 'load') { 
            csv = "Teacher,Planned Weekly,Subs Taken,Absences (Lessons),Est. Monthly Actual,Details\n" + tariffData.map(r => `"${r.name}",${r.weeklyHours},${r.subsTaken},${r.subsMissed},${r.actualHours},"${Object.entries(r.subjectBreakdown).map(([k,v]) => k+': '+v).join(', ')}"`).join('\n'); 
        } else if (reportTab === 'sanpin') { 
            csv = "Day,Score\n" + sanPinData.map(r => `${r.label},${r.value}`).join('\n'); 
        } 
        const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a"); 
        link.href = URL.createObjectURL(blob);
        link.download = `report_${reportTab}_${selectedSemester}sem.csv`; 
        document.body.appendChild(link); 
        link.click(); 
        document.body.removeChild(link); 
    };

    return (
        <div className="max-w-6xl mx-auto w-full pb-20">
            <div className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 mb-6">
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <h1 className="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-3">
                        <Icon name="BarChart2" className="text-indigo-600 dark:text-indigo-400" /> Аналитика
                    </h1>
                    
                    <div className="flex gap-4 items-center">
                        <div className="flex items-center gap-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl p-1.5 pl-3">
                            <span className="text-xs font-bold text-slate-500 dark:text-slate-400">Полугодие:</span>
                            <select
                                value={selectedSemester}
                                onChange={(e) => setSelectedSemester(Number(e.target.value) as 1 | 2)}
                                className="bg-transparent text-sm font-bold text-slate-700 dark:text-slate-200 outline-none cursor-pointer"
                            >
                                <option value={1}>1-е (Сен-Дек)</option>
                                <option value={2}>2-е (Янв-Май)</option>
                            </select>
                        </div>

                        <button onClick={downloadReport} className="px-4 py-2 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors hover:bg-emerald-100 dark:hover:bg-emerald-900/50">
                            <Icon name="FileSpreadsheet" size={16}/> Скачать CSV
                        </button>
                    </div>
                </div>
                <div className="flex gap-2 bg-slate-100 dark:bg-slate-700 p-1 rounded-xl w-fit overflow-x-auto max-w-full">
                    <button onClick={() => setReportTab('load')} className={`px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition-all ${reportTab === 'load' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>Тарификация (Нагрузка)</button>
                    <button onClick={() => setReportTab('sanpin')} className={`px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition-all ${reportTab === 'sanpin' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>СанПиН (Сложность)</button>
                    <button onClick={() => setReportTab('rating')} className={`px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition-all ${reportTab === 'rating' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>Рейтинг замен</button>
                </div>
            </div>
            {reportTab === 'load' && (
                <div className="bg-white dark:bg-dark-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                    <table className="w-full text-left border-collapse">
                        <thead className="bg-slate-50 dark:bg-slate-700 border-b border-slate-200 dark:border-slate-600">
                            <tr>
                                <th className="p-4 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase">Учитель</th>
                                <th className="p-4 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase text-right">План (Нед)</th>
                                <th className="p-4 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase text-right text-emerald-600">+ Замены</th>
                                <th className="p-4 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase text-right text-red-500">- Пропуски</th>
                                <th className="p-4 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase text-right">Итого (Мес)</th>
                                <th className="p-4 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase w-1/3">Детализация</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                            {tariffData.map(row => (
                                <tr key={row.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                    <td className="p-4 font-bold text-slate-800 dark:text-slate-200">{row.name}</td>
                                    <td className="p-4 text-right font-mono">{row.weeklyHours}</td>
                                    <td className="p-4 text-right font-mono text-emerald-600 font-bold">+{row.subsTaken}</td>
                                    <td className="p-4 text-right font-mono text-red-500 font-bold">-{row.subsMissed}</td>
                                    <td className="p-4 text-right font-mono font-black text-lg">{row.actualHours}</td>
                                    <td className="p-4 text-xs text-slate-500 dark:text-slate-400">
                                        <div className="flex flex-wrap gap-1">
                                            {Object.entries(row.subjectBreakdown).map(([s,c]) => (
                                                <span key={s} className="bg-slate-100 dark:bg-slate-600 px-1.5 py-0.5 rounded">{s}: {c}</span>
                                            ))}
                                        </div>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
            {reportTab === 'sanpin' && (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="lg:col-span-2 bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-lg dark:text-white">График сложности</h3>
                            <select value={selectedClassId} onChange={e => setSelectedClassId(e.target.value)} className="border dark:border-slate-600 p-2 rounded-lg bg-transparent dark:text-white outline-none">
                                {classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                            </select>
                        </div>
                        <BarChart items={sanPinData} max={60} barClassName="bg-indigo-500"/>
                        <div className="mt-4 text-xs text-slate-500 dark:text-slate-400">* Баллы рассчитываются на основе шкалы трудности предметов (Математика=11, и т.д.). Рекомендуемый пик нагрузки: Среда/Четверг.</div>
                    </div>
                    <div className="bg-indigo-50 dark:bg-indigo-900/20 p-6 rounded-2xl border border-indigo-100 dark:border-indigo-900">
                        <h3 className="font-bold text-indigo-900 dark:text-indigo-300 mb-4">Нормы СанПиН</h3>
                        <ul className="space-y-3 text-sm text-indigo-800 dark:text-indigo-400">
                            <li className="flex gap-2"><div className="w-1.5 h-1.5 mt-1.5 bg-indigo-500 rounded-full"></div>Равномерное распределение нагрузки</li>
                            <li className="flex gap-2"><div className="w-1.5 h-1.5 mt-1.5 bg-indigo-500 rounded-full"></div>Один сложный предмет в день</li>
                            <li className="flex gap-2"><div className="w-1.5 h-1.5 mt-1.5 bg-indigo-500 rounded-full"></div>Контрольные работы в Вт/Ср</li>
                        </ul>
                    </div>
                </div>
            )}
            {reportTab === 'rating' && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <h3 className="font-bold text-lg text-emerald-600 mb-4 flex items-center gap-2"><Icon name="TrendingUp" size={20}/> Герои замен (Топ 5)</h3>
                        <BarChart items={ratings.heroes.map(h => ({ label: h.name, value: h.count }))} max={Math.max(...ratings.heroes.map(h=>h.count), 1)} barClassName="bg-emerald-500"/>
                    </div>
                    <div className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <h3 className="font-bold text-lg text-red-500 mb-4 flex items-center gap-2"><Icon name="Activity" size={20}/> Пропуски (Топ 5)</h3>
                        <BarChart items={ratings.absentees.map(h => ({ label: h.name, value: h.count }))} max={Math.max(...ratings.absentees.map(h=>h.count), 1)} barClassName="bg-red-500"/>
                    </div>
                </div>
            )}
        </div>
    );
};
</file>

<file path="src/pages/Schedule.tsx">
import { useState, useMemo, useEffect } from 'react';
import { useStaticData, useScheduleData } from '../context/DataContext'; 
import { Icon } from '../components/Icons';
import { Modal, SearchableSelect, ContextMenu } from '../components/UI';
import { Shift, DayOfWeek, DAYS, SHIFT_PERIODS } from '../types';
import useMedia from 'use-media';


export const SchedulePage = ({ readOnly = false, semester = 1 }: { readOnly?: boolean, semester?: 1 | 2 }) => {
    const { subjects, teachers, classes, rooms } = useStaticData();
    const { schedule1, schedule2, saveSemesterSchedule, canUndo, canRedo, undo, redo } = useScheduleData();
    
    // Выбираем нужный массив данных в зависимости от пропса semester
    const schedule = semester === 2 ? schedule2 : schedule1;

    // Вспомогательная функция для сохранения, которая знает о текущем семестре
    const saveCurrentSchedule = async (newScheduleData: any[]) => {
        await saveSemesterSchedule(semester, newScheduleData);
    };
    
    const [selectedShift, setSelectedShift] = useState(Shift.First);
    const [selectedDay, setSelectedDay] = useState<DayOfWeek>(DayOfWeek.Monday);
    const [isEditorOpen, setIsEditorOpen] = useState(false);
    const [tempItem, setTempItem] = useState<any>({});
    const [viewMode, setViewMode] = useState<'class'|'teacher'|'subject'|'week'>('class');
    const [filterId, setFilterId] = useState('');
    const [filterRoom, setFilterRoom] = useState('');
    const [filterDirection, setFilterDirection] = useState('');
    const [isPrintModalOpen, setIsPrintModalOpen] = useState(false);
    const [contextMenu, setContextMenu] = useState({ visible: false, x: 0, y: 0, item: null as any, cell: null as any });
    const [clipboard, setClipboard] = useState<any>(null);
    
    const [validationWarnings, setValidationWarnings] = useState<string[]>([]);
    
    const [draggedItem, setDraggedItem] = useState<any>(null);
    const [dragOverCell, setDragOverCell] = useState<string|null>(null);

    const isMobile = useMedia({ maxWidth: 767 });
    const [mobileListView, setMobileListView] = useState(true); 

    const [isMassOperationsModalOpen, setIsMassOperationsModalOpen] = useState(false);
    const [massOpConfirm, setMassOpConfirm] = useState({ isOpen: false, type: '', day: '', classId: '' });
    
    // State for Mass Ops Modal Selections
    const [massOpSelectedDay, setMassOpSelectedDay] = useState<string>(DayOfWeek.Monday);
    const [massOpSelectedClass, setMassOpSelectedClass] = useState<string>('');

    const currentPeriods = SHIFT_PERIODS[selectedShift];
    
    const getRows = () => {
        if (viewMode === 'week') return SHIFT_PERIODS[selectedShift].map(p => ({ id: p.toString(), name: `${p} урок` }));
        if (viewMode === 'class') return filterId ? classes.filter(c => c.id === filterId && c.shift === selectedShift) : classes.filter(c => c.shift === selectedShift);
        if (viewMode === 'teacher') return filterId ? teachers.filter(t => t.id === filterId) : teachers;
        if (viewMode === 'subject') return filterId ? subjects.filter(s => s.id === filterId) : subjects;
        return [];
    };

    const getScheduleItems = (rowId: string, colKey: any) => {
        let items: any[] = [];
        if (viewMode === 'week') {
             const period = parseInt(rowId);
             const day = colKey;
             items = schedule.filter(s => s.shift === selectedShift && s.period === period && s.day === day);
             if (filterId) items = items.filter(s => s.classId === filterId);
        } else {
            const period = colKey;
            if (viewMode === 'class') items = schedule.filter(s => s.classId === rowId && s.period === period && s.day === selectedDay && s.shift === selectedShift);
            if (viewMode === 'teacher') items = schedule.filter(s => s.teacherId === rowId && s.period === period && s.day === selectedDay && s.shift === selectedShift);
            if (viewMode === 'subject') items = schedule.filter(s => s.subjectId === rowId && s.period === period && s.day === selectedDay && s.shift === selectedShift);
        }

        if (filterRoom) {
            items = items.filter(s => {
                if (!s.roomId) return false;
                const room = rooms.find(r => r.id === s.roomId);
                const roomName = room ? room.name : s.roomId;
                return roomName!.toLowerCase().includes(filterRoom.toLowerCase());
            });
        }
        if (filterDirection) items = items.filter(s => s.direction?.toLowerCase().includes(filterDirection.toLowerCase()));
        
        return items;
    };

    const checkConflicts = (item: any) => {
        const conflicts = [];
        const others = schedule.filter(s => s.id !== item.id && s.day === item.day && s.period === item.period && s.shift === item.shift);
        
        const teacherBusy = others.find(s => s.teacherId === item.teacherId);
        if (teacherBusy) conflicts.push('teacher');

        const classBusy = others.find(s => {
            if (s.classId !== item.classId) return false;
            if (s.direction && item.direction && s.direction !== item.direction) return false;
            return true; 
        });
        if (classBusy) conflicts.push('class');

        if (item.roomId) {
            const roomBusy = others.find(s => s.roomId === item.roomId);
            if (roomBusy) conflicts.push('room');
        }

        return conflicts;
    };

    const validateRoom = (classId: string, subjectId: string, roomId: string) => {
        const warnings = [];
        const cls = classes.find(c => c.id === classId);
        const subj = subjects.find(s => s.id === subjectId);
        const room = rooms.find(r => r.id === roomId);

        if (!room) return warnings;

        if (cls && room.capacity < cls.studentsCount) {
            warnings.push(`⚠️ Мало мест! В классе ${cls.studentsCount} уч., а в кабинете только ${room.capacity}.`);
        }

        if (subj && subj.requiredRoomType && subj.requiredRoomType !== 'Обычный' && room.type !== subj.requiredRoomType) {
            warnings.push(`🚫 Не тот тип! Предмет требует "${subj.requiredRoomType}", а кабинет "${room.type}".`);
        }

        return warnings;
    };

    const updateValidation = (item: any) => {
        const warns = validateRoom(item.classId, item.subjectId, item.roomId);
        setValidationWarnings(warns);
    }

    const handleEditItem = (item: any) => { 
        if(readOnly) return; 
        setTempItem(item); 
        updateValidation(item);
        setIsEditorOpen(true); 
    };
    const handleAddItem = (rowId: string, period: any, day: any = selectedDay) => {
        if(readOnly) return;
        const base = { period, day, shift: selectedShift, id: Math.random().toString(36).substr(2, 9) } as any;
        if (viewMode === 'class') base.classId = rowId;
        if (viewMode === 'teacher') base.teacherId = rowId;
        if (viewMode === 'subject') base.subjectId = rowId;
        if (viewMode === 'week') { 
            base.period = parseInt(rowId); 
            base.day = day;
            if(filterId && classes.find(c => c.id === filterId)) base.classId = filterId; 
        }
        setTempItem(base); 
        setValidationWarnings([]);
        setIsEditorOpen(true); 
    };
    const handleSaveItem = async () => {
        if (!tempItem.subjectId || !tempItem.teacherId || !tempItem.classId) return;
        let newSchedule = [...schedule];
        const idx = newSchedule.findIndex(s => s.id === tempItem.id);
        if (idx >= 0) newSchedule[idx] = tempItem; else newSchedule.push(tempItem);
        await saveCurrentSchedule(newSchedule);
        setIsEditorOpen(false);
    };
    const handleDeleteItem = async (id?: string) => {
        const newSchedule = schedule.filter(s => s.id !== (id || tempItem.id));
        await saveCurrentSchedule(newSchedule);
        setIsEditorOpen(false);
    };

    const handleContextMenu = (e: any, item: any, cellInfo: any) => {
        if(readOnly) return;
        e.preventDefault();
        e.stopPropagation(); 
        setContextMenu({ visible: true, x: e.clientX, y: e.clientY, item, cell: cellInfo });
    };

    const handleDragStart = (e: any, item: any) => {
        if(readOnly) return;
        setDraggedItem(item);
        e.dataTransfer.effectAllowed = "move";
        const el = e.target;
        setTimeout(() => el.classList.add('dragging'), 0);
    };

    const handleDragEnd = (e: any) => {
        e.target.classList.remove('dragging');
        setDraggedItem(null);
        setDragOverCell(null);
    };

    const handleDragOver = (e: any, cellInfo: any) => {
        e.preventDefault();
        if(readOnly) return;
        setDragOverCell(`${cellInfo.rowId}-${cellInfo.colKey}`); 
    };

    const handleDrop = async (e: any, cellInfo: any) => {
        e.preventDefault();
        if (!draggedItem || readOnly) return;

        const newItem = { ...draggedItem };
        
        if (viewMode === 'week') {
            newItem.period = parseInt(cellInfo.rowId);
            newItem.day = cellInfo.colKey;
        } else {
            newItem.period = cellInfo.colKey;
            newItem.day = selectedDay;
            if (viewMode === 'class') newItem.classId = cellInfo.rowId;
            if (viewMode === 'teacher') newItem.teacherId = cellInfo.rowId; 
            if (viewMode === 'subject') newItem.subjectId = cellInfo.rowId;
        }

        let newSchedule = schedule.map(s => s.id === newItem.id ? newItem : s);
        await saveCurrentSchedule(newSchedule);
        setDraggedItem(null);
        setDragOverCell(null);
    };

    const contextActions = [];
    if (contextMenu.item) {
        contextActions.push(
            { label: 'Копировать', icon: 'Copy', onClick: () => setClipboard(contextMenu.item) },
            { label: 'Удалить', icon: 'Trash2', color: 'text-red-600', onClick: () => handleDeleteItem(contextMenu.item.id) }
        );
    } else if (contextMenu.cell) {
        if (clipboard) {
            contextActions.push({ label: 'Вставить', icon: 'Clipboard', onClick: async () => {
                 const newItem = { ...clipboard, id: Math.random().toString(36).substr(2, 9), day: selectedDay, shift: selectedShift, period: contextMenu.cell.colKey }; 
                 if(viewMode === 'week') { newItem.day = contextMenu.cell.colKey; newItem.period = parseInt(contextMenu.cell.rowId); }
                 if(viewMode === 'class') newItem.classId = contextMenu.cell.rowId;
                 else if (viewMode === 'teacher') newItem.teacherId = contextMenu.cell.rowId;
                 else if (viewMode === 'subject') newItem.subjectId = contextMenu.cell.rowId;
                 
                 let newSchedule = [...schedule, newItem];
                 await saveCurrentSchedule(newSchedule);
                 setClipboard(null);
            }});
        }
        contextActions.push({ label: 'Добавить урок', icon: 'Plus', onClick: () => handleAddItem(contextMenu.cell.rowId, contextMenu.cell.colKey, viewMode === 'week' ? contextMenu.cell.colKey : selectedDay) });
    }

    const recommendedTeachers = tempItem.subjectId ? teachers.filter(t => t.subjectIds.includes(tempItem.subjectId)) : [];
    const otherTeachers = tempItem.subjectId ? teachers.filter(t => !t.subjectIds.includes(tempItem.subjectId)) : teachers;

    const printTitle = useMemo(() => {
        const semesterSuffix = semester === 2 ? ' (2-е полугодие)' : '';
        if (filterId) { 
            if (viewMode === 'teacher') return teachers.find(t=>t.id===filterId)?.name + semesterSuffix; 
            if (viewMode === 'class') return classes.find(c=>c.id===filterId)?.name + semesterSuffix; 
            if (viewMode === 'subject') return subjects.find(s=>s.id===filterId)?.name + semesterSuffix;
            if (viewMode === 'week') return classes.find(c=>c.id===filterId)?.name + semesterSuffix;
        }
        return `Расписание на ${selectedDay}` + semesterSuffix;
    }, [filterId, viewMode, teachers, classes, subjects, selectedDay, semester]);
    
    // --- PRINT LOGIC START ---
    const isWeeklyPrint = !!filterId;

    const printCols = useMemo(() => {
        if (isWeeklyPrint) return DAYS; 
        return currentPeriods; 
    }, [isWeeklyPrint, currentPeriods]);

    const printRows = useMemo(() => {
        if (isWeeklyPrint) return SHIFT_PERIODS[selectedShift].map(p => ({ id: p.toString(), name: `${p} урок` })); 
        return getRows(); 
    }, [isWeeklyPrint, selectedShift, getRows]);

    const getPrintItems = (rowId: string, colKey: any) => {
        if (isWeeklyPrint) {
            const period = parseInt(rowId);
            const day = colKey;
            let items = schedule.filter(s => s.shift === selectedShift && s.period === period && s.day === day);
            
            if (viewMode === 'class' || viewMode === 'week') items = items.filter(s => s.classId === filterId);
            else if (viewMode === 'teacher') items = items.filter(s => s.teacherId === filterId);
            else if (viewMode === 'subject') items = items.filter(s => s.subjectId === filterId);
            
            return items;
        } else {
            return getScheduleItems(rowId, colKey);
        }
    };
    // --- PRINT LOGIC END ---


    const rows = getRows();
    const cols = viewMode === 'week' ? DAYS : currentPeriods;

    const handleMassClear = (type: string, day?: string, classId?: string) => {
        setMassOpConfirm({ isOpen: true, type, day: day || '', classId: classId || '' });
    };

    const confirmMassClear = async () => {
        let newSchedule = [...schedule];
        if (massOpConfirm.type === 'clearAll') {
            newSchedule = [];
        } else if (massOpConfirm.type === 'clearDay' && massOpConfirm.day) {
            newSchedule = newSchedule.filter(item => item.day !== massOpConfirm.day);
        } else if (massOpConfirm.type === 'clearClass' && massOpConfirm.classId) {
            newSchedule = newSchedule.filter(item => item.classId !== massOpConfirm.classId);
        }
        await saveCurrentSchedule(newSchedule);
        setMassOpConfirm({ isOpen: false, type: '', day: '', classId: '' });
        setIsMassOperationsModalOpen(false); 
    };

    const renderScheduleItemsContent = (items: any[], colKey: any, rowId: string) => {
        if (readOnly && items.length === 0) return null; 

        return (
            <div className="h-full flex flex-col gap-1">
                {items.map((item: any) => {
                    const subj = subjects.find(s => s.id === item.subjectId);
                    const teacher = teachers.find(t => t.id === item.teacherId);
                    const cls = classes.find(c => c.id === item.classId);
                    const conflicts = checkConflicts(item);
                    const room = rooms.find(r => r.id === item.roomId);
                    const roomName = room ? room.name : item.roomId;

                    return (
                        <div 
                            key={item.id} 
                            draggable={!readOnly}
                            onDragStart={!readOnly ? (e) => handleDragStart(e, item) : undefined}
                            onDragEnd={!readOnly ? handleDragEnd : undefined}
                            onClick={!readOnly ? () => handleEditItem(item) : undefined} 
                            onContextMenu={!readOnly ? (e) => handleContextMenu(e, item, null) : undefined} 
                            className={`rounded-lg p-2 text-xs shadow-sm ${!readOnly ? 'hover:shadow-md cursor-grab active:cursor-grabbing' : ''} border flex flex-col gap-0.5 flex-1 relative group transition-transform ${conflicts.length > 0 ? 'border-red-300 bg-red-50 dark:bg-red-900/20 ring-1 ring-red-200' : 'border-slate-100 dark:border-slate-600'}`} 
                            style={conflicts.length === 0 && subj?.color ? { backgroundColor: `${subj.color}40` } : {}}
                        >
                            <div className="flex justify-between items-center gap-1">
                                <span className="font-bold text-slate-800 dark:text-slate-200 line-clamp-1">{viewMode === 'subject' || viewMode === 'week' ? cls?.name : subj?.name}</span>
                                {item.direction && <span className="text-[9px] px-1 rounded bg-white/80 dark:bg-black/30 font-bold text-slate-600 dark:text-slate-300">{item.direction}</span>}
                            </div>
                            {viewMode === 'week' && <div className="font-bold text-slate-800 dark:text-slate-200 line-clamp-1">{subj?.name}</div>}
                            <div className="flex justify-between items-center mt-auto">
                                <div className="text-slate-600 dark:text-slate-400 text-[10px] flex items-center gap-1 leading-tight overflow-hidden" title={teacher?.name}>
                                    <Icon name={viewMode === 'teacher' ? 'GraduationCap' : 'User'} size={10} className="shrink-0" /> 
                                    <span className="truncate">
                                        {viewMode === 'teacher' ? cls?.name : teacher?.name}
                                    </span>
                                </div>
                                {roomName && <div className="text-[9px] font-mono text-slate-400 bg-white/50 dark:bg-black/20 rounded px-1 flex items-center gap-0.5 shrink-0" title={room ? `Вмест: ${room.capacity}, Тип: ${room.type}` : ''}>{roomName}</div>}
                            </div>
                            {conflicts.length > 0 && <div className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] font-bold" title={`Конфликт: ${conflicts.join(', ')}`}>!</div>}
                        </div>
                    )
                })}
                {!readOnly && items.length < 3 && <button onClick={() => handleAddItem(rowId, colKey, viewMode === 'week' ? colKey : selectedDay)} className="w-full rounded-lg border-2 border-dashed border-slate-200 dark:border-slate-700 flex items-center justify-center text-slate-300 dark:text-slate-600 hover:border-indigo-300 hover:text-indigo-400 transition-colors mt-auto h-6"><Icon name="Plus" size={16} /></button>}
            </div>
        );
    };

    const renderMobileListView = () => {
        if (!filterId) {
            return (
                <div className="p-8 text-center text-slate-400 dark:text-slate-500">
                    Выберите класс, учителя или предмет для просмотра в списке.
                </div>
            );
        }

        const lessonsForDay = schedule.filter(s => 
            s.day === selectedDay && 
            s.shift === selectedShift && 
            (viewMode === 'class' && s.classId === filterId ||
             viewMode === 'teacher' && s.teacherId === filterId ||
             viewMode === 'subject' && s.subjectId === filterId)
        ).sort((a,b) => a.period - b.period);

        if (lessonsForDay.length === 0) {
            return (
                <div className="p-8 text-center text-slate-400 dark:text-slate-500">
                    Нет уроков на {selectedDay} в {selectedShift}.
                </div>
            );
        }

        return (
            <div className="p-4 space-y-4">
                {lessonsForDay.map(item => {
                    const subj = subjects.find(s => s.id === item.subjectId);
                    const teacher = teachers.find(t => t.id === item.teacherId);
                    const cls = classes.find(c => c.id === item.classId);
                    const room = rooms.find(r => r.id === item.roomId);
                    const roomName = room ? room.name : item.roomId;
                    const conflicts = checkConflicts(item);

                    return (
                        <div 
                            key={item.id} 
                            onClick={!readOnly ? () => handleEditItem(item) : undefined} 
                            className={`rounded-xl p-4 shadow-sm border ${conflicts.length > 0 ? 'border-red-300 bg-red-50 dark:bg-red-900/20 ring-1 ring-red-200' : 'border-slate-100 dark:border-slate-600 bg-white dark:bg-dark-800'} transition-colors ${!readOnly ? 'cursor-pointer' : ''}`}
                        >
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-sm font-bold text-slate-800 dark:text-slate-100">{item.period} урок</span>
                                {conflicts.length > 0 && <span className="bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold" title={`Конфликт: ${conflicts.join(', ')}`}>!</span>}
                            </div>
                            <div className="text-lg font-black text-indigo-600 dark:text-indigo-400 mb-1">{subj?.name} {item.direction && `(${item.direction})`}</div>
                            <div className="text-sm text-slate-700 dark:text-slate-300">{cls?.name} • {teacher?.name}</div>
                            {roomName && <div className="text-xs text-slate-500 dark:text-slate-400 mt-1">Кабинет: {roomName}</div>}
                        </div>
                    );
                })}
            </div>
        );
    };


    return (
        <div className="h-full flex flex-col">
            <div className="flex items-center gap-2 mb-4 px-4 pt-2">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white">
                    {semester === 1 ? 'Расписание (1-е полугодие)' : 'Расписание (2-е полугодие)'}
                </h2>
            </div>
            
            {contextMenu.visible && <ContextMenu x={contextMenu.x} y={contextMenu.y} onClose={()=>setContextMenu({...contextMenu, visible:false})} actions={contextActions} />}
            <div className="bg-white dark:bg-dark-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 mb-6 flex flex-col xl:flex-row gap-4 items-start xl:items-center justify-between no-print">
                 <div className="flex gap-4 items-center flex-wrap">
                    <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl">
                        <button onClick={() => setSelectedShift(Shift.First)} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${selectedShift === Shift.First ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>1 смена</button>
                        <button onClick={() => setSelectedShift(Shift.Second)} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${selectedShift === Shift.Second ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>2 смена</button>
                    </div>
                    {viewMode !== 'week' && (
                        <div className="flex overflow-x-auto pb-1 gap-1 max-w-[40vw] hide-scrollbar">
                            {DAYS.map(day => <button key={day} onClick={() => setSelectedDay(day)} className={`whitespace-nowrap px-4 py-2 rounded-xl text-sm font-bold transition-all ${selectedDay === day ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700'}`}>{day}</button>)}
                        </div>
                    )}
                     {!readOnly && (
                        <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl">
                            <button onClick={undo} disabled={!canUndo} className="p-2 text-slate-500 disabled:opacity-30 hover:bg-white dark:hover:bg-slate-600 rounded-lg transition"><Icon name="RotateCcw" size={18}/></button>
                            <button onClick={redo} disabled={!canRedo} className="p-2 text-slate-500 disabled:opacity-30 hover:bg-white dark:hover:bg-slate-600 rounded-lg transition"><Icon name="RotateCw" size={18}/></button>
                        </div>
                    )}
                </div>
                <div className="flex flex-wrap items-center gap-3 w-full xl:w-auto">
                     <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                         <button onClick={()=>{setViewMode('class'); setFilterId('')}} className={`p-2 rounded-md ${viewMode==='class'?'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white':'text-slate-400'}`} title="По классам"><Icon name="GraduationCap" size={18}/></button>
                         <button onClick={()=>{setViewMode('teacher'); setFilterId('')}} className={`p-2 rounded-md ${viewMode==='teacher'?'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white':'text-slate-400'}`} title="По учителям"><Icon name="Users" size={18}/></button>
                         <button onClick={()=>{setViewMode('subject'); setFilterId('')}} className={`p-2 rounded-md ${viewMode==='subject'?'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white':'text-slate-400'}`} title="По предметам"><Icon name="BookOpen" size={18}/></button>
                         <button onClick={()=>{setViewMode('week'); setFilterId(classes[0]?.id || '')}} className={`p-2 rounded-md ${viewMode==='week'?'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white':'text-slate-400'}`} title="Неделя"><Icon name="Calendar" size={18}/></button>
                     </div>
                     
                     <div className="flex items-center gap-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-1.5 pl-3 flex-1">
                        <Icon name="Filter" size={16} className="text-slate-400" />
                        <select value={filterId} onChange={(e) => setFilterId(e.target.value)} className="bg-transparent text-sm font-bold text-slate-700 dark:text-slate-200 outline-none w-full xl:w-32">
                            <option value="">Все {viewMode === 'class' ? 'классы' : viewMode === 'teacher' ? 'учителя' : viewMode === 'week' ? 'классы (неделя)' : 'предметы'}</option>
                            {(viewMode === 'class' || viewMode === 'week') && classes.filter(c=>c.shift===selectedShift).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                            {viewMode === 'teacher' && teachers.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                            {viewMode === 'subject' && subjects.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                        </select>
                    </div>
                    <input placeholder="Каб..." value={filterRoom} onChange={e=>setFilterRoom(e.target.value)} className="w-20 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-2 text-xs font-bold" />
                    <input placeholder="Проф..." value={filterDirection} onChange={e=>setFilterDirection(e.target.value)} className="w-20 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-2 text-xs font-bold" />

                    {!readOnly && (
                        <button onClick={() => setIsMassOperationsModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-bold shadow-lg shadow-red-200 dark:shadow-none transition-all">
                            <Icon name="List" size={16}/> Масс. опер.
                        </button>
                    )}

                    {(filterId || viewMode === 'week') && (
                        <button onClick={() => setIsPrintModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold shadow-lg shadow-indigo-200 dark:shadow-none transition-all">
                            <Icon name="Printer" size={16}/>
                        </button>
                    )}
                </div>
            </div>
            
            {isMobile && !readOnly && filterId && (
                <div className="flex justify-center mb-4 no-print">
                    <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl">
                        <button onClick={() => setMobileListView(false)} className={`flex-1 py-1 px-3 text-xs font-bold rounded-md ${!mobileListView ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`} title="Табличный вид">
                            <Icon name="Columns" size={16}/>
                        </button>
                        <button onClick={() => setMobileListView(true)} className={`flex-1 py-1 px-3 text-xs font-bold rounded-md ${mobileListView ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`} title="Списочный вид">
                            <Icon name="Rows" size={16}/>
                        </button>
                    </div>
                </div>
            )}

            <div className="flex-1 bg-white dark:bg-dark-800 rounded-2xl shadow-xl shadow-slate-200/50 dark:shadow-none border border-slate-100 dark:border-slate-700 overflow-hidden flex flex-col transition-colors duration-300 no-print">
                <div className="overflow-auto flex-1 custom-scrollbar">
                    {isMobile && mobileListView && !readOnly && filterId ? renderMobileListView() : (
                        <table className="w-full border-collapse min-w-[1000px]">
                            <thead className="bg-slate-50 dark:bg-slate-700 sticky top-0 z-20">
                                <tr>
                                    <th className="p-4 border-b border-r border-slate-100 dark:border-slate-600 text-left text-xs font-extrabold text-slate-400 uppercase w-40 sticky left-0 bg-slate-50 dark:bg-slate-700 z-30">
                                        {viewMode === 'week' ? 'Урок' : viewMode === 'class' ? 'Класс' : viewMode === 'teacher' ? 'Учитель' : 'Предмет'}
                                    </th>
                                    {cols.map(col => <th key={col} className="p-4 border-b border-slate-100 dark:border-slate-600 text-center text-xs font-extrabold text-slate-400 uppercase min-w-[160px]">{viewMode === 'week' ? col : `${col} урок`}</th>)}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-50 dark:divide-slate-700">
                                {rows.length > 0 ? rows.map(row => (
                                    <tr key={row.id}>
                                        <td className="p-4 border-r border-slate-100 dark:border-slate-600 font-black text-lg text-slate-700 dark:text-slate-200 sticky left-0 bg-white dark:bg-dark-800 z-10 text-left">{row.name}</td>
                                        {cols.map(colKey => {
                                            const items = getScheduleItems(row.id, colKey);
                                            const cellId = `${row.id}-${colKey}`;
                                            return (
                                                <td 
                                                    key={colKey} 
                                                    className={`p-2 border-r border-slate-50 dark:border-slate-700 h-28 align-top transition-colors ${dragOverCell === cellId ? 'drag-over' : 'hover:bg-slate-50 dark:hover:bg-slate-700/50'}`}
                                                    onContextMenu={!readOnly ? (e) => handleContextMenu(e, null, { rowId: row.id, colKey }) : undefined}
                                                    onDragOver={!readOnly ? (e) => handleDragOver(e, { rowId: row.id, colKey }) : undefined}
                                                    onDrop={!readOnly ? (e) => handleDrop(e, { rowId: row.id, colKey }) : undefined}
                                                >
                                                    {renderScheduleItemsContent(items, colKey, row.id)}
                                                </td>
                                            );
                                        })}
                                    </tr>
                                )) : <tr><td colSpan={8} className="p-8 text-center text-slate-400 dark:text-slate-500">Нет данных для отображения</td></tr>}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>

            <Modal isOpen={isEditorOpen} onClose={() => setIsEditorOpen(false)} title={tempItem.id ? 'Редактирование урока' : 'Добавить урок'}>
                <div className="space-y-4">
                    {/* Top Info Bar */}
                    <div className="bg-slate-50 dark:bg-slate-700/50 p-3 rounded-xl flex items-center gap-4 text-sm font-bold text-slate-600 dark:text-slate-300">
                        <span>День: {tempItem.day}</span>
                        <span>Урок: {tempItem.period}</span>
                        <span>Смена: {tempItem.shift === Shift.First ? '1 смена' : '2 смена'}</span>
                    </div>

                    {validationWarnings.length > 0 && (
                        <div className="bg-orange-50 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 p-3 rounded-lg text-sm border border-orange-100 dark:border-orange-900">
                            {validationWarnings.map((w, i) => <div key={i} className="flex items-center gap-2"><Icon name="AlertTriangle" size={14}/>{w}</div>)}
                        </div>
                    )}
                    
                    <div>
                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">КЛАСС</label>
                        <SearchableSelect 
                            options={classes.filter(c => c.shift === selectedShift).map(c => ({ value: c.id, label: c.name }))} 
                            value={tempItem.classId} 
                            onChange={(val: any) => { setTempItem({...tempItem, classId: val}); updateValidation({...tempItem, classId: val}); }} 
                            placeholder="Выберите класс" 
                        />
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">ПРЕДМЕТ</label>
                        <SearchableSelect 
                            options={subjects.map(s => ({ value: s.id, label: s.name }))} 
                            value={tempItem.subjectId} 
                            onChange={(val: any) => { setTempItem({...tempItem, subjectId: val}); updateValidation({...tempItem, subjectId: val}); }} 
                            placeholder="Выберите предмет" 
                        />
                    </div>
                    
                    <div>
                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">УЧИТЕЛЬ</label>
                        <SearchableSelect 
                            options={[{ value: 'recommend', label: 'Рекомендуемые', options: recommendedTeachers.map(t => ({ value: t.id, label: t.name })) }, { value: 'others', label: 'Остальные', options: otherTeachers.map(t => ({ value: t.id, label: t.name })) }]} 
                            value={tempItem.teacherId} 
                            onChange={(val: any) => setTempItem({...tempItem, teacherId: val})} 
                            placeholder="Выберите учителя" 
                            groupBy 
                        />
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">ГРУППА / НАПРАВЛЕНИЕ</label>
                        <input className="w-full border border-slate-200 dark:border-slate-600 p-3 rounded-xl text-sm outline-none bg-white dark:bg-slate-700 dark:text-white focus:border-indigo-500" placeholder="Например: 1 гр. или Профиль" value={tempItem.direction || ''} onChange={e => setTempItem({...tempItem, direction: e.target.value})} />
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">КАБИНЕТ</label>
                        <select className="w-full border border-slate-200 dark:border-slate-600 p-3 rounded-xl text-sm outline-none bg-white dark:bg-slate-700 dark:text-white focus:border-indigo-500" value={tempItem.roomId || ''} onChange={e => { setTempItem({...tempItem, roomId: e.target.value}); updateValidation({...tempItem, roomId: e.target.value}); }}>
                            <option value="">Без кабинета</option>
                            {rooms.map(r => <option key={r.id} value={r.id}>{r.name} ({r.capacity} мест)</option>)}
                        </select>
                    </div>

                    <div className="flex justify-end gap-2 mt-6">
                        {tempItem.id && <button onClick={() => handleDeleteItem()} className="px-4 py-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg font-bold text-sm">Удалить</button>}
                        <button onClick={handleSaveItem} className="px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition">Сохранить</button>
                    </div>
                </div>
            </Modal>
            
            <Modal isOpen={isMassOperationsModalOpen} onClose={() => setIsMassOperationsModalOpen(false)} title="Массовые операции с расписанием">
                <div className="space-y-6">
                    <p className="text-sm text-slate-500 dark:text-slate-400">
                        Внимание: Эти операции необратимы без использования функции "Отменить" сразу после действия.
                    </p>

                    <div>
                        <h4 className="font-bold text-slate-800 dark:text-white mb-1">Очистить всё расписание</h4>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mb-3">Удаляет все уроки из расписания (все дни, все смены, все классы).</p>
                        <button onClick={() => handleMassClear('clearAll')} className="px-4 py-2 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition text-sm">
                            Очистить полностью
                        </button>
                    </div>

                    <div>
                        <h4 className="font-bold text-slate-800 dark:text-white mb-1">Очистить расписание на день</h4>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mb-3">Удаляет все уроки для выбранного дня недели.</p>
                        <div className="flex gap-2">
                            <select 
                                value={massOpSelectedDay} 
                                onChange={(e) => setMassOpSelectedDay(e.target.value)} 
                                className="border border-slate-200 dark:border-slate-600 rounded-xl p-2 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none w-full"
                            >
                                {DAYS.map(day => <option key={day} value={day}>{day}</option>)}
                            </select>
                        </div>
                        <button onClick={() => handleMassClear('clearDay', massOpSelectedDay)} className="mt-2 px-4 py-2 bg-amber-600 text-white rounded-xl font-bold hover:bg-amber-700 transition text-sm w-full sm:w-auto">
                            Очистить {massOpSelectedDay}
                        </button>
                    </div>

                    <div>
                        <h4 className="font-bold text-slate-800 dark:text-white mb-1">Очистить расписание для класса</h4>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mb-3">Удаляет все уроки для выбранного класса.</p>
                        <div className="flex gap-2">
                            <select 
                                value={massOpSelectedClass} 
                                onChange={(e) => setMassOpSelectedClass(e.target.value)} 
                                className="border border-slate-200 dark:border-slate-600 rounded-xl p-2 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none w-full"
                            >
                                <option value="" disabled>Выберите класс</option>
                                {classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                            </select>
                        </div>
                        <button 
                            onClick={() => { if(massOpSelectedClass) handleMassClear('clearClass', undefined, massOpSelectedClass); }} 
                            disabled={!massOpSelectedClass}
                            className="mt-2 px-4 py-2 bg-teal-600 text-white rounded-xl font-bold hover:bg-teal-700 transition text-sm w-full sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Очистить для класса
                        </button>
                    </div>
                </div>
            </Modal>

            <Modal isOpen={massOpConfirm.isOpen} onClose={() => setMassOpConfirm({ ...massOpConfirm, isOpen: false })} title="Подтверждение">
                <p className="mb-6 text-slate-600 dark:text-slate-300">Вы уверены? Это действие нельзя будет отменить через историю изменений.</p>
                <div className="flex justify-end gap-3">
                    <button onClick={() => setMassOpConfirm({ ...massOpConfirm, isOpen: false })} className="px-4 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg font-bold text-slate-600 dark:text-slate-300">Отмена</button>
                    <button onClick={confirmMassClear} className="px-4 py-2 bg-red-600 text-white rounded-lg font-bold">Подтвердить</button>
                </div>
            </Modal>

            {/* Print Overlay */}
            {isPrintModalOpen && (
                <div className="fixed inset-0 z-[100] bg-white flex flex-col">
                    <div className="p-4 border-b flex justify-between items-center bg-slate-50 no-print">
                         <h2 className="font-bold text-lg text-slate-800">Печать расписания</h2>
                         <div className="flex gap-2">
                             <button onClick={() => window.print()} className="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold flex items-center gap-2 hover:bg-indigo-700"><Icon name="Printer" size={16}/> Печать</button>
                             <button onClick={() => setIsPrintModalOpen(false)} className="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-300">Закрыть</button>
                         </div>
                    </div>
                    <div className="flex-1 overflow-auto p-8 custom-scrollbar">
                         <div className="max-w-[1100px] mx-auto">
                             <div className="text-center mb-6">
                                 <h1 className="text-2xl font-black text-slate-800 uppercase">{printTitle}</h1>
                                 <p className="text-slate-500 font-bold">{new Date().toLocaleDateString('ru-RU', {day:'numeric', month:'long', year:'numeric'})}</p>
                             </div>
                             
                             <table className="w-full border-collapse border border-slate-300 text-xs">
                                 <thead>
                                     <tr>
                                         <th className="border border-slate-300 p-2 bg-slate-100 w-24 font-bold text-slate-700">
                                            {isWeeklyPrint ? 'Урок' : (viewMode === 'week' ? 'Урок' : viewMode === 'class' ? 'Класс' : viewMode === 'teacher' ? 'Учитель' : 'Предмет')}
                                         </th>
                                         {printCols.map(c => <th key={c} className="border border-slate-300 p-2 bg-slate-100 text-center font-bold text-slate-700">{isWeeklyPrint ? c : (viewMode === 'week' ? c : `${c} урок`)}</th>)}
                                     </tr>
                                 </thead>
                                 <tbody>
                                     {printRows.map(row => (
                                         <tr key={row.id}>
                                             <td className="border border-slate-300 p-2 font-bold bg-slate-50 text-slate-800">{row.name}</td>
                                             {printCols.map(colKey => {
                                                 const items = getPrintItems(row.id, colKey);
                                                 return (
                                                     <td key={colKey} className="border border-slate-300 p-1 align-top h-20 bg-white">
                                                         {items.map(item => {
                                                             const subj = subjects.find(s => s.id === item.subjectId);
                                                             const teach = teachers.find(t => t.id === item.teacherId);
                                                             const cls = classes.find(c => c.id === item.classId);
                                                             const room = rooms.find(r => r.id === item.roomId);
                                                             const roomName = room ? room.name : item.roomId;
                                                             
                                                             const isTeacherView = viewMode === 'teacher';
                                                             const isWeeklyTeacher = isWeeklyPrint && isTeacherView;
                                                             const isSubjectOrWeek = viewMode === 'subject' || viewMode === 'week';

                                                             const mainText = (isSubjectOrWeek || isWeeklyTeacher) ? cls?.name : subj?.name;
                                                             const subText = isTeacherView ? cls?.name : teach?.name;

                                                             return (
                                                                 <div key={item.id} className="mb-1">
                                                                     <div className="font-bold text-slate-900 text-[11px] leading-tight">
                                                                        {mainText}
                                                                        {item.direction && ` (${item.direction})`}
                                                                     </div>
                                                                     <div className="text-[9px] text-slate-600 flex justify-between items-center mt-0.5">
                                                                         <span>
                                                                             {subText}
                                                                         </span>
                                                                         {roomName && <span className="border px-1 rounded bg-slate-50 border-slate-200">{roomName}</span>}
                                                                     </div>
                                                                 </div>
                                                             );
                                                         })}
                                                     </td>
                                                 );
                                             })}
                                         </tr>
                                     ))}
                                 </tbody>
                             </table>
                         </div>
                    </div>
                </div>
            )}
        </div>
    );
};
</file>

<file path="src/pages/Substitutions.tsx">
import { useState, useMemo, useEffect, useCallback } from 'react';
import { useLocation } from 'react-router-dom';
import { useStaticData, useScheduleData } from '../context/DataContext'; 
import { Icon } from '../components/Icons';
import { Modal } from '../components/UI';
import { DAYS, Shift } from '../types';

export const SubstitutionsPage = () => {
    const { subjects, teachers, classes, rooms, settings, saveStaticData } = useStaticData(); 
    // Получаем оба расписания, чтобы выбирать нужное в зависимости от даты
    const { schedule1, schedule2, substitutions, saveScheduleData } = useScheduleData();

    const location = useLocation();
    const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [currentSubParams, setCurrentSubParams] = useState<any>(null);
    const [absenceModalOpen, setAbsenceModalOpen] = useState(false);
    const [manualSearchModalOpen, setManualSearchModalOpen] = useState(false);
    
    const [selectedTeacherId, setSelectedTeacherId] = useState<string|null>(null);
    const [absenceReason, setAbsenceReason] = useState('Болезнь');
    const [showHistory, setShowHistory] = useState(false);
    const [historySearch, setHistorySearch] = useState('');
    const [teacherSearch, setTeacherSearch] = useState('');
    const [teacherShiftFilter, setTeacherShiftFilter] = useState('all');
    const [candidateSearch, setCandidateSearch] = useState('');
    const [manualLessonSearch, setManualLessonSearch] = useState('');

    const [selectedRoomId, setSelectedRoomId] = useState<string>('');
    const [lessonAbsenceReason, setLessonAbsenceReason] = useState<string>('');

    // Определяем актуальное расписание на основе выбранной даты
    const activeSchedule = useMemo(() => {
        const month = new Date(selectedDate).getMonth();
        // Январь(0) - Май(4) = 2 полугодие. Остальное (включая лето по дефолту) = 1 полугодие
        const isSecondSemester = month >= 0 && month <= 4;
        return isSecondSemester ? schedule2 : schedule1;
    }, [selectedDate, schedule1, schedule2]);

    useEffect(() => {
        if(location.state?.subParams) {
            setCurrentSubParams(location.state.subParams);
            setSelectedRoomId(''); 
            setLessonAbsenceReason(''); 
            setIsModalOpen(true);
            window.history.replaceState({}, document.title);
        }
    }, [location.state]);

    const selectedDayOfWeek = useMemo(() => { 
        const idx = new Date(selectedDate).getDay(); 
        if (idx === 0 || idx === 6) return null;
        return DAYS[idx - 1]; 
    }, [selectedDate]);

    const filteredTeachersList = useMemo(() => {
        return teachers.filter(t => {
            const matchesSearch = t.name.toLowerCase().includes(teacherSearch.toLowerCase());
            const matchesShift = teacherShiftFilter === 'all' ? true : t.shifts.includes(teacherShiftFilter);
            return matchesSearch && matchesShift;
        });
    }, [teachers, teacherSearch, teacherShiftFilter]);

    const absentTeachers = useMemo(() => teachers.filter(t => t.unavailableDates.includes(selectedDate)), [teachers, selectedDate]);
    
    const affectedLessons = useMemo(() => { 
        if (!selectedDayOfWeek) return []; 
        
        const absentIds = absentTeachers.map(t => t.id); 
        // Используем activeSchedule вместо schedule
        const lessonsOfAbsent = activeSchedule.filter(s => s.day === selectedDayOfWeek && absentIds.includes(s.teacherId));

        const subsOnDate = substitutions.filter(s => s.date === selectedDate);
        const subScheduleIds = subsOnDate.map(s => s.scheduleItemId);
        const lessonsWithSubs = activeSchedule.filter(s => subScheduleIds.includes(s.id));

        const merged = [...lessonsOfAbsent];
        lessonsWithSubs.forEach(l => {
            if (!merged.find(m => m.id === l.id)) merged.push(l);
        });

        return merged.sort((a, b) => a.period - b.period); 
    }, [activeSchedule, selectedDayOfWeek, absentTeachers, substitutions, selectedDate]);

    const openAbsenceModal = (id: string) => { 
        const teacher = teachers.find(t => t.id === id);
        setSelectedTeacherId(id); 
        setAbsenceReason(teacher?.absenceReasons?.[selectedDate] || 'Болезнь'); 
        setAbsenceModalOpen(true); 
    };
    
    const confirmAbsence = useCallback(async () => { 
        let updatedTeachers = [...teachers]; 
        const tIndex = updatedTeachers.findIndex(x => x.id === selectedTeacherId);
        if (tIndex === -1) return;

        const teacher = { ...updatedTeachers[tIndex] };
        if (!teacher.unavailableDates.includes(selectedDate)) { 
            teacher.unavailableDates = [...teacher.unavailableDates, selectedDate]; 
        }
        if(!teacher.absenceReasons) teacher.absenceReasons = {}; 
        teacher.absenceReasons[selectedDate] = absenceReason; 

        updatedTeachers[tIndex] = teacher;
        await saveStaticData({ teachers: updatedTeachers }); 
        setAbsenceModalOpen(false); 
    }, [teachers, selectedTeacherId, selectedDate, absenceReason, saveStaticData]);

    const removeAbsence = useCallback(async (id: string) => { 
        let updatedTeachers = [...teachers]; 
        const tIndex = updatedTeachers.findIndex(x => x.id === id);
        if (tIndex === -1) return;

        const teacher = { ...updatedTeachers[tIndex] };
        teacher.unavailableDates = teacher.unavailableDates.filter((d: string) => d !== selectedDate); 
        if(teacher.absenceReasons) delete teacher.absenceReasons[selectedDate]; 
        updatedTeachers[tIndex] = teacher;
        await saveStaticData({ teachers: updatedTeachers }); 
    }, [teachers, selectedDate, saveStaticData]);
    
    const assignSubstitution = useCallback(async (replacementId: string, isMerger: boolean = false) => { 
        if (!currentSubParams) {
            alert("Ошибка: Невозможно назначить замену. Параметры урока не определены. Пожалуйста, попробуйте еще раз.");
            return;
        }

        const newSubs = [...substitutions];

        // Используем activeSchedule для поиска урока
        const item = activeSchedule.find(s => s.id === currentSubParams.scheduleItemId);
        if (!item) {
            alert("Ошибка: Урок не найден в расписании. Возможно, он был удален или вы переключили полугодие.");
            return;
        }
        
        const existingSubIndex = newSubs.findIndex(s => s.scheduleItemId === currentSubParams.scheduleItemId && s.date === selectedDate);
        const subData = { 
            id: existingSubIndex >= 0 ? newSubs[existingSubIndex].id : Math.random().toString(36).substr(2, 9), 
            date: selectedDate, 
            scheduleItemId: currentSubParams.scheduleItemId, 
            originalTeacherId: item.teacherId, 
            replacementTeacherId: replacementId,
            replacementRoomId: selectedRoomId || undefined, 
            isMerger: isMerger,
            lessonAbsenceReason: (replacementId !== 'conducted' && replacementId !== 'cancelled' && lessonAbsenceReason)
                ? lessonAbsenceReason
                : undefined
        }; 
        
        if (existingSubIndex >= 0) newSubs[existingSubIndex] = subData; else newSubs.push(subData); 
        
        await saveScheduleData({ substitutions: newSubs }); 
        
        setIsModalOpen(false); 
        setCandidateSearch('');
        setSelectedRoomId('');
        setLessonAbsenceReason(''); 
        setCurrentSubParams(null);
    }, [currentSubParams, selectedDate, selectedRoomId, activeSchedule, substitutions, teachers, lessonAbsenceReason, saveScheduleData]);
    
    const removeSubstitution = useCallback(async (id: string) => { 
        const newSubs = substitutions.filter(s => !(s.scheduleItemId === id && s.date === selectedDate)); 
        await saveScheduleData({ substitutions: newSubs }); 
    }, [substitutions, selectedDate, saveScheduleData]);
    
    const copyForMessenger = useCallback(() => {
        let text = `*Замены на ${new Date(selectedDate).toLocaleDateString('ru-RU')}*\n`;
        
        const hasAnyActiveSubs = substitutions.some(s => s.date === selectedDate && s.replacementTeacherId !== 'conducted');

        const processShift = (shiftName: string, shiftEnum: Shift) => {
            const lessons = affectedLessons.filter(l => l.shift === shiftEnum);
            
            const lessonsWithSubs = lessons.filter(l => {
                const sub = substitutions.find(s => s.scheduleItemId === l.id && s.date === selectedDate);
                return sub && sub.replacementTeacherId !== 'conducted';
            });

            if (lessonsWithSubs.length > 0) {
                text += `\n🔹 *${shiftName.toUpperCase()}*\n`;
                lessonsWithSubs.forEach(l => {
                    const sub = substitutions.find(s => s.scheduleItemId === l.id && s.date === selectedDate);
                    const cls = classes.find(c => c.id === l.classId);
                    const subj = subjects.find(s => s.id === l.subjectId);
                    const rep = sub ? teachers.find(t => t.id === sub.replacementTeacherId) : null;
                    const orig = teachers.find(t => t.id === l.teacherId);
                    const origRoom = rooms.find(r => r.id === l.roomId)?.name || l.roomId || '?';
                    
                    const dayAbsenceReason = orig?.absenceReasons?.[selectedDate];
                    const lessonSpecificReason = sub?.lessonAbsenceReason;
                    
                    const effectiveDayAbsenceDisplay = (dayAbsenceReason === 'Без записи') ? dayAbsenceReason : null;
                    const effectiveLessonSpecificDisplay = (lessonSpecificReason === 'Без записи') ? lessonSpecificReason : null;

                    const effectiveReasonDisplay = effectiveLessonSpecificDisplay || effectiveDayAbsenceDisplay;

                    const origName = orig?.name + (effectiveReasonDisplay ? ` (${effectiveReasonDisplay})` : '');
                    
                    const newRoom = sub?.replacementRoomId ? rooms.find(r => r.id === sub.replacementRoomId)?.name || sub.replacementRoomId : null;

                    if (sub) {
                        if (sub.replacementTeacherId === 'cancelled') {
                            text += `❗ ${cls?.name} (${l.period} ур): ${subj?.name} (${origName}) -> УРОК СНЯТ\n`;
                        } else {
                            if (sub.replacementTeacherId === sub.originalTeacherId && newRoom) {
                                text += `🚪 ${cls?.name} (${l.period} ур): ${subj?.name} (${orig?.name}) -> Кабинет ${origRoom} → ${newRoom}\n`;
                            } else {
                                let line = `✅ ${cls?.name} (${l.period} ур): ${subj?.name} -> ${rep?.name} ${sub.isMerger ? '(ОБЪЕДИНЕНИЕ) ' : ''}(вместо ${origName})`;
                                if (newRoom) line += ` в каб. ${newRoom}`;
                                text += line + '\n';
                            }
                        }
                    }
                });
            }
        };

        if(!hasAnyActiveSubs) {
            text += "\nЗамен нет.";
        } else {
            processShift(Shift.First, Shift.First);
            processShift(Shift.Second, Shift.Second);
        }

        navigator.clipboard.writeText(text);
        alert("Текст скопирован с разделением по сменам!");
    }, [selectedDate, substitutions, affectedLessons, classes, subjects, teachers, rooms]);

    const generateICal = useCallback(() => {
        let icalContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Gymnasium//Manager//RU\n";
        const subs = substitutions.filter(s => s.date === selectedDate);
        subs.forEach(sub => {
            // Используем activeSchedule
            const item = activeSchedule.find(s => s.id === sub.scheduleItemId);
            if(!item) return;
            let repName = "Unknown";
            if(sub.replacementTeacherId === 'cancelled') repName = "УРОК СНЯТ";
            else if(sub.replacementTeacherId === 'conducted') repName = "Урок проведен";
            else {
                const t = teachers.find(t => t.id === sub.replacementTeacherId);
                if(t) repName = t.name;
            }

            const subj = subjects.find(s => s.id === item.subjectId);
            const cls = classes.find(c => c.id === item.classId);
            const dateStr = sub.date.replace(/-/g, '');
            
            const origTeacher = teachers.find(t => t.id === sub.originalTeacherId);
            const dayAbsenceReason = origTeacher?.absenceReasons?.[selectedDate];
            const lessonSpecificReason = sub.lessonAbsenceReason;

            const effectiveDayAbsenceDisplay = (dayAbsenceReason === 'Без записи') ? dayAbsenceReason : null;
            const effectiveLessonSpecificDisplay = (lessonSpecificReason === 'Без записи') ? lessonSpecificReason : null;
            const effectiveReasonDisplay = effectiveLessonSpecificDisplay || effectiveDayAbsenceDisplay;

            icalContent += `BEGIN:VEVENT\nDTSTART;VALUE=DATE:${dateStr}\nSUMMARY:Замена: ${cls?.name} - ${subj?.name}\nDESCRIPTION:Заменяет: ${repName}${sub.isMerger ? ' (ОБЪЕДИНЕНИЕ)' : ''}${effectiveReasonDisplay ? ` (Причина: ${effectiveReasonDisplay})` : ''}\nEND:VEVENT\n`;
        });
        icalContent += "END:VCALENDAR";
        const blob = new Blob([icalContent], { type: 'text/calendar' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url; link.download = 'substitutions.ics';
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }, [selectedDate, substitutions, activeSchedule, teachers, subjects, classes]);

    const sendToTelegram = useCallback(async () => {
        if (!settings?.telegramToken) {
            alert("Токен Telegram бота не настроен в разделе 'Администрация'.");
            return;
        }

        let fullMessage = `*Замены на ${new Date(selectedDate).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' })}*\n\n`;
        let hasActiveSubs = false;

        const teacherChatIdsToNotify = new Set<string>();

        const shiftsToProcess = [Shift.First, Shift.Second];
        for (const shiftEnum of shiftsToProcess) {
            const lessonsInShift = affectedLessons.filter(l => l.shift === shiftEnum);
            const activeSubstitutionsInShift = lessonsInShift.filter(l => 
                substitutions.some(s => s.scheduleItemId === l.id && s.date === selectedDate && s.replacementTeacherId !== 'conducted')
            );

            if (activeSubstitutionsInShift.length > 0) {
                hasActiveSubs = true;
                fullMessage += `🔹 *${shiftEnum.toUpperCase()}*\n`;

                activeSubstitutionsInShift.forEach(l => {
                    const sub = substitutions.find(s => s.scheduleItemId === l.id && s.date === selectedDate);
                    if (!sub) return;

                    const cls = classes.find(c => c.id === l.classId);
                    const subj = subjects.find(s => s.id === l.subjectId);
                    const originalTeacher = teachers.find(t => t.id === sub.originalTeacherId);
                    const replacementTeacher = teachers.find(t => t.id === sub.replacementTeacherId);

                    const dayAbsenceReason = originalTeacher?.absenceReasons?.[selectedDate];
                    const lessonSpecificReason = sub.lessonAbsenceReason;

                    const effectiveDayAbsenceDisplay = (dayAbsenceReason === 'Без записи') ? dayAbsenceReason : null;
                    const effectiveLessonSpecificDisplay = (lessonSpecificReason === 'Без записи') ? lessonSpecificReason : null;
                    const effectiveReasonDisplay = effectiveLessonSpecificDisplay || effectiveDayAbsenceDisplay;

                    const origTeacherNameWithReason = originalTeacher?.name + (effectiveReasonDisplay ? ` (${effectiveReasonDisplay})` : '');
                    
                    const oldRoomName = rooms.find(r => r.id === l.roomId)?.name || l.roomId || '—';
                    const newRoomName = sub.replacementRoomId ? (rooms.find(r => r.id === sub.replacementRoomId)?.name || sub.replacementRoomId) : oldRoomName;
                    
                    let lessonLine = `${l.period} урок (${cls?.name} ${subj?.name}${l.direction ? ` ${l.direction}` : ''}): `;
                    
                    if (sub.replacementTeacherId === 'cancelled') {
                        lessonLine += `*УРОК СНЯТ* (вместо ${origTeacherNameWithReason})`;
                    } else if (sub.replacementTeacherId === sub.originalTeacherId) { 
                        lessonLine += `Учитель: ${origTeacherNameWithReason}. Смена кабинета: ${oldRoomName} → ${newRoomName}`;
                    } else { 
                        lessonLine += `*${replacementTeacher?.name}* ${sub.isMerger ? '(ОБЪЕДИНЕНИЕ) ' : ''}(вместо *${origTeacherNameWithReason}*)`;
                        if (oldRoomName !== newRoomName) {
                            lessonLine += `. Кабинет: ${oldRoomName} → ${newRoomName}`;
                        } else if (newRoomName !== '—') {
                            lessonLine += `. Кабинет: ${newRoomName}`;
                        }
                    }

                    fullMessage += `${lessonLine}\n`;

                    if (originalTeacher?.telegramChatId) teacherChatIdsToNotify.add(originalTeacher.telegramChatId);
                    if (replacementTeacher?.telegramChatId) teacherChatIdsToNotify.add(replacementTeacher.telegramChatId);
                });
                fullMessage += '\n';
            }
        }

        if (!hasActiveSubs) {
            fullMessage += "Замен нет.\n";
        }

        absentTeachers.forEach(t => {
            const hasAnyValidSubForAbsentTeacher = substitutions.some(s => 
                s.date === selectedDate && 
                s.originalTeacherId === t.id && 
                s.replacementTeacherId !== 'cancelled' && 
                s.replacementTeacherId !== 'conducted'
            );
            
            const dayAbsenceReason = t.absenceReasons?.[selectedDate];
            const displayReason = (dayAbsenceReason === 'Без записи') ? dayAbsenceReason : 'отсутствует';

            if (t.telegramChatId && !hasAnyValidSubForAbsentTeacher && t.unavailableDates.includes(selectedDate)) {
                teacherChatIdsToNotify.add(t.telegramChatId);
                if (hasActiveSubs) {
                    fullMessage += `_Напоминание: Учитель ${t.name} ${displayReason}, его уроки сегодня без активной замены или отменены/проведены._\n`;
                } else {
                    fullMessage += `_Напоминание: Учитель ${t.name} ${displayReason}, его уроки сегодня без активной замены._\n`;
                }
            }
        });


        if (teacherChatIdsToNotify.size === 0) {
            alert("Не найдено учителей с Telegram Chat ID для отправки уведомлений.");
            return;
        }

        const botApiUrl = `https://api.telegram.org/bot${settings.telegramToken}/sendMessage`;

        try {
            const sendPromises = Array.from(teacherChatIdsToNotify).map(chatId =>
                fetch(botApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: fullMessage,
                        parse_mode: 'Markdown',
                    }),
                })
            );

            await Promise.all(sendPromises);
            alert(`Уведомления успешно отправлены ${teacherChatIdsToNotify.size} учителям!`);
        } catch (error) {
            console.error("Ошибка при отправке в Telegram:", error);
            alert("Ошибка при отправке уведомлений в Telegram. Проверьте токен бота и подключение.");
        }
    }, [selectedDate, affectedLessons, substitutions, classes, subjects, teachers, rooms, absentTeachers, settings?.telegramToken]);
    
    // activeSubstitutionsForSlot теперь использует activeSchedule
    const activeSubstitutionsForSlot = useMemo(() => {
        if (!currentSubParams) return new Set<string>();
        
        return new Set(substitutions
            .filter(s => s.date === selectedDate && s.replacementTeacherId !== 'conducted' && s.replacementTeacherId !== 'cancelled')
            .map(s => {
                // Ищем оригинальный урок в activeSchedule
                const item = activeSchedule.find(i => i.id === s.scheduleItemId);
                if (item && item.period === currentSubParams.period && item.shift === currentSubParams.shift) {
                    return s.replacementTeacherId;
                }
                return null;
            })
            .filter((id): id is string => !!id)
        );
    }, [substitutions, activeSchedule, selectedDate, currentSubParams]);

    const candidates = useMemo(() => { 
        if (!currentSubParams || !selectedDayOfWeek) return [];
        const targetMonth = selectedDate.substring(0, 7);
        return teachers
            .filter(t => t.name.toLowerCase().includes(candidateSearch.toLowerCase()))
            .map(t => { 
            const isAbsent = t.unavailableDates.includes(selectedDate); 
            // Используем activeSchedule для проверки занятости
            const isBusyRegular = activeSchedule.some(s => s.teacherId === t.id && s.day === selectedDayOfWeek && s.period === currentSubParams.period && s.shift === currentSubParams.shift); 
            const isBusySub = activeSubstitutionsForSlot.has(t.id);
            const isBusy = isBusyRegular || isBusySub;

            const isSpecialist = t.subjectIds.includes(currentSubParams.subjectId); 
            const subsCount = substitutions.filter(s => s.replacementTeacherId === t.id && s.date.startsWith(targetMonth)).length;
            let score = 0; 
            if (isAbsent) score -= 1000; 
            if (isBusy) score -= 100; 
            if (isSpecialist) score += 50; 
            return { teacher: t, isAbsent, isBusy, isSpecialist, score, subsCount }; 
        }).sort((a, b) => b.score - a.score); 
    }, [teachers, currentSubParams, selectedDate, candidateSearch, selectedDayOfWeek, activeSchedule, substitutions, activeSubstitutionsForSlot]);
    
    const modalContext = useMemo(() => {
        if(!currentSubParams) return null;
        const s = activeSchedule.find(i => i.id === currentSubParams.scheduleItemId);
        if(!s) return null;
        const c = classes.find(cls => cls.id === s.classId);
        const sub = subjects.find(subj => subj.id === s.subjectId);
        const t = teachers.find(tch => tch.id === s.teacherId);
        
        const isTeacherAbsent = t?.unavailableDates?.includes(selectedDate) || false;

        return { 
            className: c?.name, 
            subjectName: sub?.name, 
            teacherName: t?.name, 
            teacherId: t?.id,
            period: s.period,
            roomId: s.roomId,
            isTeacherAbsent
        };
    }, [currentSubParams, activeSchedule, classes, subjects, teachers, selectedDate]);

    const manualSearchResults = useMemo(() => {
        if (!selectedDayOfWeek || manualLessonSearch.length < 2) return [];
        
        const searchLower = manualLessonSearch.toLowerCase();
        const foundTeachers = teachers.filter(t => t.name.toLowerCase().includes(searchLower));
        const foundClasses = classes.filter(c => c.name.toLowerCase().includes(searchLower));
        
        const results: any[] = [];

        foundTeachers.forEach(t => {
            const lessons = activeSchedule.filter(s => s.teacherId === t.id && s.day === selectedDayOfWeek);
            lessons.forEach(l => {
                const c = classes.find(cls => cls.id === l.classId);
                const subj = subjects.find(s => s.id === l.subjectId);
                results.push({ ...l, entityName: t.name, subInfo: c?.name, subjectName: subj?.name });
            });
        });

        foundClasses.forEach(c => {
            const lessons = activeSchedule.filter(s => s.classId === c.id && s.day === selectedDayOfWeek);
            lessons.forEach(l => {
                if (results.find(r => r.id === l.id)) return;
                const t = teachers.find(tch => tch.id === l.teacherId);
                const subj = subjects.find(s => s.id === l.subjectId);
                results.push({ ...l, entityName: c.name, subInfo: t?.name, subjectName: subj?.name });
            });
        });

        return results.sort((a, b) => a.period - b.period);
    }, [manualLessonSearch, selectedDayOfWeek, teachers, classes, activeSchedule, subjects]);

    const notifyTeacherFunction = useCallback(async (replacementTeacher: any, lessonInfo: any, classInfo: any, subjectInfo: any, roomInfo: any, dateStr: string) => {
        const dateObj = new Date(dateStr);
        const formattedDate = dateObj.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
        const shiftText = lessonInfo.shift === Shift.First ? '1 смена' : '2 смена';
        const message = `🔔 *Уведомление о замене*\n${replacementTeacher.name}\n\n📅 Дата: ${formattedDate}\n🕒 Смена: ${shiftText}\n🏫 Класс: ${classInfo?.name}\n1️⃣ Урок: ${lessonInfo.period}\n📚 Предмет: ${subjectInfo?.name}\n🚪 Кабинет: ${roomInfo || 'по расписанию'}`;
        
        if (settings?.telegramToken && replacementTeacher.telegramChatId) {
            try {
                const response = await fetch(`https://api.telegram.org/bot${settings.telegramToken}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: replacementTeacher.telegramChatId, text: message, parse_mode: 'Markdown' })
                });
                const resData = await response.json();
                if (resData.ok) {
                    alert(`Сообщение отправлено в Telegram для ${replacementTeacher.name}!`);
                } else {
                    if (resData.description.includes("chat not found")) {
                        alert(`Ошибка Telegram: Чат не найден.\n\nПопросите учителя ${replacementTeacher.name} найти вашего бота и нажать кнопку "Запустить" (/start).`);
                    } else {
                        alert(`Ошибка Telegram: ${resData.description}`);
                    }
                }
            } catch (error) {
                alert('Ошибка отправки в Telegram (сеть/токен).');
                console.error(error);
            }
        } else {
            if (navigator.share) { navigator.share({ title: 'Замена', text: message }).catch(() => {}); } else { navigator.clipboard.writeText(message); alert(`Сообщение скопировано! (Telegram не настроен или нет Chat ID)`); }
        }
    }, [settings?.telegramToken]);

    const handleCandidateClick = (teacherId: string, isBusy: boolean) => {
        let isMerger = false;
        if (isBusy) {
            if (!window.confirm("Этот учитель занят в данное время. Вы хотите назначить ОБЪЕДИНЕНИЕ классов?")) {
                return;
            }
            isMerger = true;
        }
        assignSubstitution(teacherId, isMerger);
    };


    return (
        <div className="h-full flex flex-col md:flex-row gap-6">
            <div className="w-full md:w-80 flex flex-col gap-6">
                <div className="bg-white dark:bg-dark-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                    <label className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2 block">Дата замены</label>
                    <div className="relative"><Icon name="Calendar" className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18}/><input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="w-full pl-10 border border-slate-200 dark:border-slate-600 p-3 rounded-xl text-sm font-bold outline-none focus:border-indigo-500 bg-transparent dark:text-white"/></div>
                    <button onClick={() => setShowHistory(!showHistory)} className={`mt-3 w-full py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 border transition-all ${showHistory ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white dark:bg-slate-700 text-indigo-600 dark:text-white border-indigo-200 dark:border-slate-500'}`}><Icon name="History" size={16}/> {showHistory ? 'Скрыть историю' : 'История замен'}</button>
                </div>
                
                {showHistory ? (
                     <div className="bg-white dark:bg-dark-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex-1 overflow-hidden flex flex-col">
                        <h3 className="font-bold text-slate-800 dark:text-slate-100 mb-2">История</h3>
                        <input placeholder="Поиск по дате/учителю..." value={historySearch} onChange={e=>setHistorySearch(e.target.value)} className="mb-4 w-full bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-2 text-xs" />
                        <div className="flex-1 overflow-y-auto custom-scrollbar space-y-2">
                            {substitutions.filter(s => s.date.includes(historySearch) || teachers.find(t=>t.id===s.replacementTeacherId)?.name.toLowerCase().includes(historySearch.toLowerCase())).map(s => {
                                 const r = teachers.find(t=>t.id===s.replacementTeacherId);
                                 const room = rooms.find(rm => rm.id === s.replacementRoomId);
                                 return (
                                    <div key={s.id} className="p-2 border border-slate-100 dark:border-slate-700 rounded-lg text-xs">
                                        <div className="font-bold">{s.date}</div>
                                        <div>
                                            {r?.name || (s.replacementTeacherId === 'cancelled' ? 'Снят' : 'Проведен')}
                                            {s.isMerger && <span className="text-purple-600 font-bold ml-1">(Объед.)</span>}
                                        </div>
                                        {room && <div className="text-indigo-500">Каб. {room.name}</div>}
                                    </div>
                                 );
                            })}
                        </div>
                     </div>
                ) : (
                    <div className="bg-white dark:bg-dark-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex-1 overflow-hidden flex flex-col">
                        <h3 className="font-bold text-slate-800 dark:text-slate-100 mb-4 flex items-center gap-2"><Icon name="UserX" size={18} className="text-red-500"/> Отсутствующие</h3>
                        
                        <div className="mb-3 space-y-2">
                            <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                                <button onClick={() => setTeacherShiftFilter('all')} className={`flex-1 py-1 text-xs font-bold rounded-md ${teacherShiftFilter === 'all' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>Все</button>
                                <button onClick={() => setTeacherShiftFilter(Shift.First)} className={`flex-1 py-1 text-xs font-bold rounded-md ${teacherShiftFilter === Shift.First ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>1 см</button>
                                <button onClick={() => setTeacherShiftFilter(Shift.Second)} className={`flex-1 py-1 text-xs font-bold rounded-md ${teacherShiftFilter === Shift.Second ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>2 см</button>
                            </div>
                            <div className="relative">
                                <Icon name="Search" className="absolute left-3 top-2.5 text-slate-400" size={14}/>
                                <input placeholder="Найти учителя..." value={teacherSearch} onChange={e => setTeacherSearch(e.target.value)} className="w-full pl-8 pr-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-100 dark:border-slate-600 rounded-xl text-xs outline-none focus:ring-1 ring-indigo-500 dark:text-white"/>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto custom-scrollbar pr-1 space-y-2">
                            {filteredTeachersList.map(t => {
                                const isAbsent = t.unavailableDates.includes(selectedDate); 
                                const reason = t.absenceReasons ? t.absenceReasons[selectedDate] : '';
                                return (
                                <div key={t.id} className={`flex flex-col p-3 rounded-xl border transition-all ${isAbsent ? 'bg-red-50 dark:bg-red-900/20 border-red-100 dark:border-red-900' : 'bg-slate-50 dark:bg-slate-700/50 border-slate-100 dark:border-slate-600'}`}>
                                    <div className="flex items-center justify-between mb-1">
                                        <span className={`text-sm font-medium ${isAbsent ? 'text-red-700 dark:text-red-400' : 'text-slate-600 dark:text-slate-300'}`}>{t.name}</span>
                                        <button onClick={() => isAbsent ? removeAbsence(t.id) : openAbsenceModal(t.id)} className={`text-xs px-2 py-1 rounded-lg font-bold transition-colors ${isAbsent ? 'bg-white dark:bg-dark-800 text-red-600 dark:text-red-400 shadow-sm' : 'text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600'}`}>
                                            {isAbsent ? 'Вернуть' : 'Нет'}
                                        </button>
                                    </div>
                                    <div className="flex justify-between items-end">
                                        <div className="flex gap-1">{t.shifts.map(s => <span key={s} className="text-[9px] bg-white dark:bg-slate-600 px-1 rounded border border-slate-100 dark:border-slate-500 text-slate-400">{s === Shift.First ? '1' : '2'}</span>)}</div>
                                        {isAbsent && (
                                            <div className="flex items-center gap-1">
                                                {reason && <div className="text-[10px] text-red-500 dark:text-red-400 italic">{reason}</div>}
                                                <button onClick={() => openAbsenceModal(t.id)} className="w-6 h-6 flex items-center justify-center bg-white dark:bg-dark-800 text-red-600 dark:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-full shadow-sm border border-slate-200 dark:border-slate-600" title="Изменить причину">
                                                    <Icon name="Edit2" size={14}/>
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>)
                            })}
                            {filteredTeachersList.length === 0 && <div className="text-center text-xs text-slate-400 py-4">Не найдено</div>}
                        </div>
                    </div>
                )}
            </div>
            <div className="flex-1 bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col overflow-hidden">
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-xl font-bold text-slate-800 dark:text-slate-100">Требуют замены ({affectedLessons.length})</h2>
                    <div className="flex gap-2">
                        <button onClick={generateICal} className="flex items-center gap-2 px-3 py-2 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded-xl text-sm font-bold hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors"><Icon name="Calendar" size={16}/> iCal</button>
                        {affectedLessons.length > 0 && <button onClick={copyForMessenger} className="flex items-center gap-2 px-3 py-2 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-xl text-sm font-bold hover:bg-green-100 dark:hover:bg-green-900/50 transition-colors"><Icon name="Copy" size={16}/> Копировать</button>}
                        <button onClick={sendToTelegram} className="px-4 py-2 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 transition shadow-lg shadow-blue-200 dark:shadow-none flex items-center gap-2">
                            <Icon name="Send" size={16} /> Telegram
                        </button>
                        <button onClick={() => { 
                            setManualLessonSearch(''); 
                            setManualSearchModalOpen(true); 
                        }} className="flex items-center gap-2 px-3 py-2 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 rounded-xl text-sm font-bold hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition-colors">
                            <Icon name="Search" size={16}/> Ручной выбор
                        </button>
                    </div>
                </div>
                <div className="flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-4">
                    {affectedLessons.length === 0 ? <div className="h-full flex flex-col items-center justify-center text-slate-400"><Icon name="CheckCircle" size={48} className="mb-4 text-slate-200 dark:text-slate-700"/><p>Нет уроков, требующих замены на эту дату</p></div> : affectedLessons.map(l => {
                        const sub = substitutions.find(s => s.scheduleItemId === l.id && s.date === selectedDate);
                        const rep = sub && sub.replacementTeacherId !== 'cancelled' && sub.replacementTeacherId !== 'conducted' ? teachers.find(t => t.id === sub.replacementTeacherId) : null; 
                        const orig = teachers.find(t => t.id === l.teacherId);
                        const subj = subjects.find(s => s.id === l.subjectId); const cls = classes.find(c => c.id === l.classId);
                        const room = rooms.find(r => r.id === l.roomId);
                        const roomName = room ? room.name : l.roomId;
                        
                        const newRoomId = sub?.replacementRoomId;
                        const newRoomName = newRoomId ? (rooms.find(r => r.id === newRoomId)?.name || newRoomId) : null;
                        
                        let statusEl = null;
                        if (sub?.replacementTeacherId === 'conducted') {
                            statusEl = <div className="flex items-center gap-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-900 pl-4 pr-2 py-2 rounded-xl"><div className="text-blue-700 dark:text-blue-400 font-bold text-sm">Урок проведен</div><button onClick={() => removeSubstitution(l.id)} className="p-2 bg-white dark:bg-dark-800 rounded-lg text-blue-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors shadow-sm"><Icon name="X" size={16}/></button></div>;
                        } else if (sub?.replacementTeacherId === 'cancelled') {
                            statusEl = <div className="flex items-center gap-3 bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-900 pl-4 pr-2 py-2 rounded-xl"><div className="text-red-700 dark:text-red-400 font-bold text-sm">УРОК СНЯТ</div><button onClick={() => removeSubstitution(l.id)} className="p-2 bg-white dark:bg-dark-800 rounded-lg text-red-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors shadow-sm"><Icon name="X" size={16}/></button></div>;
                        } else if (rep || newRoomId) {
                            const isRoomChangeOnly = sub?.replacementTeacherId === sub?.originalTeacherId && newRoomId;
                            
                            statusEl = <div className="flex items-center gap-3 bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-900 pl-4 pr-2 py-2 rounded-xl">
                                <div>
                                    <div className="text-[10px] uppercase font-bold text-emerald-600 dark:text-emerald-400 tracking-wider">
                                        {isRoomChangeOnly ? 'Замена кабинета' : 'Замена назначена'}
                                    </div>
                                    <div className="font-bold text-emerald-900 dark:text-emerald-200 text-sm">
                                        {isRoomChangeOnly ? 'Учитель тот же' : rep?.name}
                                    </div>
                                    {sub.isMerger && (
                                        <div className="text-[10px] font-black text-purple-600 dark:text-purple-400 uppercase tracking-widest mt-0.5">ОБЪЕДИНЕНИЕ</div>
                                    )}
                                    {sub.lessonAbsenceReason && ( 
                                        <div className="text-[10px] text-red-500 dark:text-red-400 italic mt-0.5">Причина: {sub.lessonAbsenceReason}</div>
                                    )}
                                </div>
                                <div className="flex gap-1">
                                    <button onClick={() => notifyTeacherFunction(rep || orig, l, cls, subj, newRoomName || roomName, selectedDate)} className="p-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 shadow-sm transition-all" title="Отправить уведомление">
                                        <Icon name="Send" size={18}/>
                                    </button>
                                    <button onClick={() => removeSubstitution(l.id)} className="p-2 rounded-lg bg-white dark:bg-slate-800 text-red-500 border border-red-100 dark:border-red-900/30 hover:bg-red-50 dark:hover:bg-red-900/20 shadow-sm transition-all" title="Отменить замену"><Icon name="UserX" size={18}/></button>
                                </div>
                            </div>;
                        } else {
                            statusEl = <button onClick={() => { setCurrentSubParams({ scheduleItemId: l.id, subjectId: l.subjectId, period: l.period, shift: l.shift, classId: l.classId, teacherId: l.teacherId, roomId: l.roomId, day: l.day }); setIsModalOpen(true); }} className="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-3 rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 dark:shadow-none transition-all flex items-center justify-center gap-2 xl:w-auto w-full">Найти замену <Icon name="ArrowRight" size={16}/></button>;
                        }

                        const isTeacherPresent = !absentTeachers.find(t => t.id === l.teacherId);

                        return (<div key={l.id} className="p-4 rounded-xl border border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-700/30 flex flex-col xl:flex-row xl:items-center justify-between gap-4">
                            <div className="flex items-center gap-4">
                                <div className="w-12 h-12 bg-white dark:bg-dark-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-600 flex flex-col items-center justify-center text-indigo-600 dark:text-indigo-400"><span className="text-[10px] font-bold uppercase text-slate-400 leading-none">Урок</span><span className="text-xl font-black leading-none mt-1 dark:text-slate-200">{l.period}</span></div>
                                <div>
                                    <div className="flex items-center gap-2 mb-1"><span className="font-bold text-lg text-slate-800 dark:text-slate-100">{cls?.name}</span><div className="text-sm text-slate-500 dark:text-slate-400 flex items-center gap-2"><span className="text-xs font-bold text-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 px-1 rounded">{l.shift === Shift.First ? '1см' : '2см'}</span><span className="text-slate-400">|</span><span>{subj?.name}</span></div></div>
                                    <div className="text-sm text-slate-600 dark:text-slate-300 flex items-center gap-2">
                                        <span className={isTeacherPresent ? 'font-semibold' : 'line-through decoration-red-400 decoration-2'}>{orig?.name}</span>
                                        {roomName && <span className="text-xs bg-white dark:bg-slate-700 px-1.5 py-0.5 rounded border border-slate-200 dark:border-slate-600 flex items-center gap-1">{roomName} {newRoomName && <span className="text-indigo-600 font-bold">→ {newRoomName}</span>}</span>}
                                        {sub?.lessonAbsenceReason && ( // Always show lesson-specific reason
                                            <span className="text-xs bg-red-50 dark:bg-red-900/20 px-1.5 py-0.5 rounded border border-red-100 dark:border-red-900 text-red-500 dark:text-red-400 font-medium">({sub.lessonAbsenceReason})</span>
                                        )}
                                    </div>
                                </div>
                            </div>
                            {statusEl}
                        </div>)
                    })}
                </div>
            </div>
            
            {/* SUBSTITUTION MODAL */}
            <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="Выбор замены">
                {modalContext && (
                    <div className="bg-slate-50 dark:bg-slate-700/50 p-3 rounded-xl mb-4 text-sm border border-slate-100 dark:border-slate-600">
                        <div className="font-bold text-slate-700 dark:text-slate-200 mb-1">{modalContext.className} • {modalContext.period} урок</div>
                        <div className="flex justify-between text-slate-500 dark:text-slate-400">
                            <span>{modalContext.subjectName}</span>
                            <span className={modalContext.isTeacherAbsent ? 'line-through decoration-red-400' : 'font-semibold'}>{modalContext.teacherName}</span>
                        </div>
                    </div>
                )}
                
                <div className="mb-6">
                    <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Замена кабинета (Опционально)</label>
                    <select value={selectedRoomId} onChange={e => setSelectedRoomId(e.target.value)} className="w-full border border-slate-200 dark:border-slate-600 p-3 rounded-xl text-sm outline-none focus:border-indigo-500 dark:bg-slate-700 dark:text-white">
                        <option value="">Без изменения кабинета</option>
                        {rooms.map(r => (
                            <option key={r.id} value={r.id}>{r.name} ({r.capacity} мест)</option>
                        ))}
                    </select>
                </div>

                {/* NEW: Lesson-specific absence reason */}
                {modalContext && !modalContext.isTeacherAbsent && (
                    <div className="mb-6">
                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Причина отсутствия на уроке (Опционально)</label>
                        <select
                            value={lessonAbsenceReason}
                            onChange={e => setLessonAbsenceReason(e.target.value)}
                            className="w-full border border-slate-200 dark:border-slate-600 p-3 rounded-xl text-sm outline-none focus:border-indigo-500 dark:bg-slate-700 dark:text-white"
                        >
                            <option value="">Без причины</option>
                            <option>Болезнь</option>
                            <option>Курсы</option>
                            <option>Отгул</option>
                            <option>Семейные обстоятельства</option>
                            <option>Командировка</option>
                            <option>Без записи</option>
                        </select>
                    </div>
                )}

                <div className="grid grid-cols-2 gap-3 mb-4">
                    <button onClick={() => assignSubstitution('conducted')} className="p-3 rounded-xl bg-blue-50 text-blue-700 font-bold text-sm hover:bg-blue-100 transition">Урок проведён</button>
                    <button onClick={() => assignSubstitution('cancelled')} className="p-3 rounded-xl bg-red-50 text-red-700 font-bold text-sm hover:bg-red-100 transition">Снять урок</button>
                </div>
                
                {modalContext?.teacherId && !modalContext.isTeacherAbsent && (
                    <button onClick={() => assignSubstitution(modalContext.teacherId)} className="w-full p-3 mb-4 rounded-xl bg-emerald-50 text-emerald-700 font-bold text-sm hover:bg-emerald-100 transition border border-emerald-200">
                        Оставить текущего учителя (Только замена кабинета)
                    </button>
                )}

                <div className="relative mb-4">
                    <Icon name="Search" className="absolute left-3 top-2.5 text-slate-400" size={14}/>
                    <input autoFocus placeholder="Найти другого учителя..." value={candidateSearch} onChange={e => setCandidateSearch(e.target.value)} className="w-full pl-8 pr-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-sm outline-none focus:border-indigo-500 dark:text-white"/>
                </div>
                <div className="space-y-2 max-h-48 overflow-y-auto custom-scrollbar">
                    {candidates.map(({ teacher, isAbsent, isBusy, isSpecialist, subsCount }) => (
                        <button 
                            key={teacher.id} 
                            disabled={isAbsent} 
                            onClick={() => handleCandidateClick(teacher.id, isBusy)} 
                            title={isAbsent ? 'Учитель отсутствует' : isBusy ? 'Учитель занят' : ''} // Dynamic title for disabled state
                            className={`w-full p-3 rounded-xl border flex items-center justify-between transition-all text-left ${isAbsent ? 'bg-red-50 dark:bg-red-900/20 border-red-100 dark:border-red-900 opacity-60' : isBusy ? 'bg-orange-50 dark:bg-orange-900/20 border-orange-100 dark:border-orange-900 hover:shadow-md cursor-pointer' : 'bg-white dark:bg-dark-800 border-slate-100 dark:border-slate-700 hover:border-indigo-500 hover:shadow-md'}`}
                        >
                            <div className="flex items-center gap-3">
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${isSpecialist ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300'}`}>{isSpecialist ? <Icon name="Star" size={14} fill="currentColor"/> : teacher.name[0]}</div>
                                <div>
                                    <div className="font-bold text-sm text-slate-800 dark:text-slate-200">{teacher.name}</div>
                                    <div className="text-xs text-slate-500 dark:text-slate-400 mt-1 flex flex-wrap gap-2">
                                        {isSpecialist && <span className="text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/20 px-1.5 rounded">Профиль</span>}
                                        {isBusy && <span className="text-orange-600 dark:text-orange-400 bg-orange-50 dark:bg-orange-900/20 px-1.5 rounded font-bold">Занят</span>}
                                        {isAbsent && <span className="text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 px-1.5 rounded">Отсутствует</span>}
                                        <span className={`px-1.5 rounded font-medium ${subsCount > 5 ? 'text-amber-600 bg-amber-50 dark:bg-amber-900/20' : 'text-blue-600 bg-blue-50 dark:bg-blue-900/20'}`}>
                                            В этом мес: {subsCount}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            {!isAbsent && !isBusy && <div className="px-3 py-1 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded text-xs font-bold">Выбрать</div>}
                            {isBusy && !isAbsent && <div className="px-3 py-1 bg-orange-100 dark:bg-orange-800/30 text-orange-700 dark:text-orange-300 rounded text-xs font-bold">Объединить?</div>}
                        </button>
                    ))}
                    {candidates.length === 0 && <div className="text-center text-slate-400 text-xs py-4">Нет подходящих учителей</div>}
                </div>
            </Modal>

            {/* MANUAL SEARCH MODAL */}
            <Modal isOpen={manualSearchModalOpen} onClose={() => setManualSearchModalOpen(false)} title="Ручной поиск урока">
                <div className="mb-4">
                    <p className="text-sm text-slate-500 dark:text-slate-400 mb-2">Введите имя учителя или название класса, чтобы найти урок и поставить замену (кабинета или учителя).</p>
                    <div className="relative">
                        <Icon name="Search" className="absolute left-3 top-2.5 text-slate-400" size={14}/>
                        <input autoFocus placeholder="Например: 6А или Иванова..." value={manualLessonSearch} onChange={e => setManualLessonSearch(e.target.value)} className="w-full pl-8 pr-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-sm outline-none focus:border-indigo-500 dark:text-white"/>
                    </div>
                </div>
                <div className="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                    {manualSearchResults.map((item: any) => (
                        <button key={item.id} onClick={() => { setManualSearchModalOpen(false); setCurrentSubParams({ scheduleItemId: item.id, subjectId: item.subjectId, period: item.period, shift: item.shift, classId: item.classId, teacherId: item.teacherId, roomId: item.roomId, day: item.day }); setIsModalOpen(true); }} className="w-full p-3 rounded-xl border border-slate-100 dark:border-slate-700 hover:border-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors text-left group">
                            <div className="flex justify-between items-center mb-1">
                                <span className="font-bold text-slate-800 dark:text-slate-200">{item.entityName} <span className="font-normal text-slate-500">({item.subInfo})</span></span>
                                <span className="text-xs font-bold bg-slate-100 dark:bg-slate-600 px-2 py-0.5 rounded">{item.period} урок</span>
                            </div>
                            <div className="text-xs text-slate-500 dark:text-slate-400 flex gap-2">
                                <span>{item.subjectName}</span>
                                {item.roomId && <span className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 px-1 rounded">Каб. {rooms.find(r=>r.id===item.roomId)?.name || item.roomId}</span>}
                            </div>
                        </button>
                    ))}
                    {manualLessonSearch.length > 1 && manualSearchResults.length === 0 && <div className="text-center text-slate-400 text-xs py-4">Уроки не найдены на выбранную дату ({selectedDate})</div>}
                </div>
            </Modal>

            <Modal isOpen={absenceModalOpen} onClose={() => setAbsenceModalOpen(false)} title="Причина отсутствия"><div className="space-y-4"><select value={absenceReason} onChange={e => setAbsenceReason(e.target.value)} className="w-full border p-3 rounded-xl outline-none font-bold text-slate-700 dark:text-white dark:bg-slate-700 dark:border-slate-600"><option>Болезнь</option><option>Курсы</option><option>Отгул</option><option>Семейные обстоятельства</option><option>Командировка</option><option>Без записи</option><option>Другое</option></select><div className="flex justify-end"><button onClick={confirmAbsence} className="px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold">Подтвердить</button></div></div></Modal>
        </div>
    );
};
</file>

<file path="src/types.ts">
export enum Shift {
  First = '1 смена',
  Second = '2 смена'
}

export enum DayOfWeek {
  Monday = 'Пн',
  Tuesday = 'Вт',
  Wednesday = 'Ср',
  Thursday = 'Чт',
  Friday = 'Пт'
}

export interface Subject {
  id: string;
  name: string;
  color: string;
  difficulty: number;
  requiredRoomType: string;
}

export interface Teacher {
  id: string;
  name: string;
  subjectIds: string[];
  unavailableDates: string[]; // ISO Date strings
  absenceReasons?: Record<string, string>;
  shifts: string[]; // Shift values
  birthDate?: string;
  telegramChatId?: string;
}

export interface ClassEntity {
  id: string;
  name: string;
  shift: string; // Shift enum
  studentsCount: number;
}

export interface Room {
  id: string;
  name: string;
  capacity: number;
  type: string;
}

export interface ScheduleItem {
  id: string;
  classId: string;
  subjectId: string;
  teacherId: string;
  roomId?: string;
  day: string; // DayOfWeek
  period: number;
  shift: string; // Shift
  direction?: string; // Group or profile
}

export interface Substitution {
  id: string;
  date: string; // ISO Date
  scheduleItemId: string;
  originalTeacherId: string;
  replacementTeacherId: string; // 'conducted', 'cancelled', or teacherId. If purely room change, can be originalTeacherId
  replacementRoomId?: string; // New field for room substitution
  lessonAbsenceReason?: string; // NEW: Reason for lesson-specific absence
  isMerger?: boolean; // NEW: Flag for merged classes
}

export interface Bell {
  shift: string;
  period: number;
  start: string;
  end: string;
  day: string; // 'default' or DayOfWeek
}

export interface Settings {
  telegramToken: string;
  publicScheduleId?: string | null; // ID for publicly published schedule
  feedbackChatId?: string;
}

// Interfaces for split contexts
export interface StaticAppData {
  subjects: Subject[];
  teachers: Teacher[];
  classes: ClassEntity[];
  rooms: Room[];
  bellSchedule: Bell[];
  settings: Settings;
}

export interface ScheduleAndSubstitutionData {
  schedule: ScheduleItem[]; // АВТОМАТИЧЕСКИ ВЫБРАННОЕ ТЕКУЩЕЕ РАСПИСАНИЕ (зависит от месяца)
  schedule1: ScheduleItem[]; // Явное 1 полугодие
  schedule2: ScheduleItem[]; // Явное 2 полугодие
  substitutions: Substitution[];
  saveSemesterSchedule: (semester: 1 | 2, newData: ScheduleItem[]) => Promise<void>;
  saveScheduleData: (newData: Partial<ScheduleAndSubstitutionData>, addToHistory?: boolean) => Promise<void>; // Legacy support
}

export interface AppData extends StaticAppData {
    schedule: ScheduleItem[]; // 1 полугодие
    schedule2ndHalf: ScheduleItem[]; // 2 полугодие
    substitutions: Substitution[];
}

export const DAYS = [DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday, DayOfWeek.Friday];
export const SHIFT_PERIODS = { [Shift.First]: [1, 2, 3, 4, 5, 6, 7], [Shift.Second]: [0, 1, 2, 3, 4, 5, 6] };
export const ROOM_TYPES = ['Обычный', 'Спортзал', 'Химия/Биология', 'Физика', 'Информатика', 'Музыка', 'Технология', 'Актовый зал'];
</file>

<file path="vite.config.ts">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  base: '/zamenygymn/', 
})
</file>

<file path="src/App.tsx">
import React, { useState, useEffect } from 'react';
import { HashRouter, Routes, Route, Navigate, NavLink, Outlet, useSearchParams } from 'react-router-dom';
import { DataProvider, useStaticData, StaticDataProvider, ScheduleDataProvider } from './context/DataContext';
import { AuthProvider, useAuth } from './context/AuthContext';
import { Icon } from './components/Icons';
import { StatusWidget } from './components/UI';
import { DashboardPage } from './pages/Dashboard';
import { SchedulePage } from './pages/Schedule';
import { DirectoryPage } from './pages/Directory';
import { SubstitutionsPage } from './pages/Substitutions';
import { AdminPage } from './pages/Admin';
import { ExportPage } from './pages/Export'; 
import { ReportsPage } from './pages/Reports';
import { LoginPage } from './pages/Login';
import { dbService } from './services/db';
import { AppData } from './types'; 
import { INITIAL_DATA } from './constants'; 

const ProtectedRoute = ({ children, allowedRoles }: { children: React.ReactNode, allowedRoles?: string[] }) => {
    const { user, role, loading } = useAuth();

    if (loading) return <div className="h-screen flex items-center justify-center"><Icon name="Loader" className="animate-spin text-indigo-600" size={48} /></div>;

    if (!role) {
        return <Navigate to="/login" replace />;
    }

    if (allowedRoles && !allowedRoles.includes(role)) {
        // Если роль не разрешена, перенаправляем на домашнюю страницу для этой роли
        return <Navigate to={role === 'guest' ? '/schedule' : '/dashboard'} replace />;
    }

    return <>{children}</>;
};

// Компонент для перенаправления с корневого пути в зависимости от роли
const HomeRedirect = () => {
    const { role, loading } = useAuth();
    if (loading) return null;
    if (role === 'guest') return <Navigate to="/schedule" replace />;
    return <Navigate to="/dashboard" replace />;
};

const Layout = () => {
    const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
    const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light');
    const { isLoading } = useStaticData(); 
    const { logout, role, user } = useAuth();

    useEffect(() => {
        if (theme === 'dark') document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
        localStorage.setItem('theme', theme);
    }, [theme]);

    if (isLoading) return <div className="h-screen flex items-center justify-center bg-slate-50 dark:bg-dark-950"><Icon name="Loader" className="animate-spin text-indigo-600" size={48} /></div>;

    const menuItems = [
        // Dashboard: Только Админ и Учитель
        { to: '/dashboard', label: 'Рабочий стол', icon: 'Home', roles: ['admin', 'teacher'] },
        // Schedule: Все роли (1 полугодие)
        { to: '/schedule', label: 'Расписание 1 полугодие', icon: 'Calendar', roles: ['admin', 'teacher', 'guest'] },
        // Schedule 2: Все роли (2 полугодие)
        { to: '/schedule2', label: 'Расписание 2 полугодие', icon: 'Calendar', roles: ['admin', 'teacher', 'guest'] },
        // Substitutions (Назначение замен): Только Админ
        { to: '/substitutions', label: 'Замены', icon: 'Repeat', roles: ['admin'] }, 
        // Остальные: Только Админ
        { to: '/directory', label: 'Справочники', icon: 'BookOpen', roles: ['admin'] },
        { to: '/reports', label: 'Отчеты', icon: 'BarChart2', roles: ['admin'] }, 
        { to: '/export', label: 'Экспорт', icon: 'Download', roles: ['admin'] },
        { to: '/admin', label: 'Администрация', icon: 'Settings', roles: ['admin'] },
    ];

    const filteredMenu = menuItems.filter(item => item.roles.includes(role || ''));

    return (
        <div className="flex h-screen bg-slate-50 dark:bg-dark-950 overflow-hidden transition-colors duration-300">
            {isMobileMenuOpen && <div className="fixed inset-0 bg-black/20 backdrop-blur-sm z-40 lg:hidden" onClick={() => setIsMobileMenuOpen(false)} />}
            <aside className={`fixed lg:static inset-y-0 left-0 z-50 w-64 bg-white dark:bg-dark-800 border-r border-slate-200 dark:border-slate-700 transform transition-all duration-300 ease-in-out ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'} no-print`}>
                <div className="h-full flex flex-col">
                    <div className="p-6 flex items-center gap-3 border-b border-slate-100 dark:border-slate-700">
                        <div className="bg-indigo-600 p-2.5 rounded-xl text-white"><Icon name="GraduationCap" size={24} /></div>
                        <div><h1 className="text-lg font-black text-slate-800 dark:text-white">Гимназия №22</h1><p className="text-[10px] font-bold text-slate-400 uppercase">Управление V1.0</p></div>
                    </div>
                    
                    <div className="px-6 pt-4">
                        <div className="text-xs font-bold text-slate-400 uppercase mb-2">Меню</div>
                    </div>

                    <nav className="flex-1 p-4 space-y-1 pt-0">
                        {filteredMenu.map((item) => (
                            <NavLink key={item.to} to={item.to} onClick={() => setIsMobileMenuOpen(false)} className={({ isActive }) => `flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all ${isActive ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>
                                <Icon name={item.icon} size={20} />{item.label}
                            </NavLink>
                        ))}
                    </nav>
                    <StatusWidget />
                    <div className="p-4 border-t border-slate-100 dark:border-slate-700 space-y-2">
                         <div className="flex items-center justify-between">
                            <div className="text-xs font-bold text-slate-500 dark:text-slate-400 truncate max-w-[120px]">{user ? (user.email || 'Гость') : 'Гость'}</div>
                            <button onClick={logout} className="p-1.5 hover:bg-red-50 dark:hover:bg-red-900/20 text-slate-400 hover:text-red-500 rounded-lg transition-colors" title="Выйти"><Icon name="LogOut" size={16}/></button>
                        </div>
                        <button onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')} className="flex items-center gap-2 text-xs font-bold text-slate-500 dark:text-slate-400 w-full hover:text-indigo-600 transition-colors">
                            {theme === 'light' ? <><Icon name="Moon" size={16} /> Темная тема</> : <><Icon name="Sun" size={16} /> Светлая тема</>}
                        </button>
                    </div>
                </div>
            </aside>
            <main className="flex-1 flex flex-col min-w-0 bg-slate-50/50 dark:bg-dark-950">
                <header className="lg:hidden p-4 flex items-center gap-3 bg-white dark:bg-dark-800 border-b border-slate-200 dark:border-slate-700 no-print">
                    <button onClick={() => setIsMobileMenuOpen(true)}><Icon name="Menu" size={24} /></button>
                    <span className="font-bold">Меню</span>
                </header>
                <div className="flex-1 overflow-auto p-4 lg:p-8"><Outlet /></div>
            </main>
        </div>
    );
};

const PublicLayout = () => {
    const [publicData, setPublicData] = useState<AppData | null>(null);
    const [loadingPublic, setLoadingPublic] = useState(true);
    const [searchParams] = useSearchParams();
    const publicId = searchParams.get('id');

    useEffect(() => {
        if (publicId) {
            setLoadingPublic(true);
            dbService.getPublicData(publicId).then(data => {
                const mergedData: AppData = { 
                    ...INITIAL_DATA, 
                    ...data,
                    settings: { ...INITIAL_DATA.settings, ...data?.settings }
                };
                setPublicData(mergedData);
                setLoadingPublic(false);
            }).catch(e => {
                console.error("Failed to load public data:", e);
                setPublicData(null); 
                setLoadingPublic(false);
            });
        } else {
            setLoadingPublic(false);
            setPublicData(null); 
        }
    }, [publicId]);

    if (loadingPublic) {
        return (
            <div className="h-screen flex items-center justify-center bg-slate-50 dark:bg-dark-950">
                <Icon name="Loader" className="animate-spin text-indigo-600" size={48} />
            </div>
        );
    }

    if (!publicData) {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center text-center p-8">
                <Icon name="AlertTriangle" size={64} className="text-red-500 mb-4" />
                <h1 className="text-2xl font-bold text-slate-800 dark:text-white mb-2">Ошибка загрузки расписания</h1>
                <p className="text-slate-500 dark:text-slate-400">Публичное расписание не найдено или ссылка недействительна.</p>
            </div>
        );
    }

    return (
        <DataProvider initialData={publicData}>
            <StaticDataProvider>
                <ScheduleDataProvider>
                    <div className="min-h-screen bg-slate-50 dark:bg-dark-950 flex flex-col">
                        <header className="bg-white dark:bg-dark-800 border-b border-slate-200 dark:border-slate-700 px-6 py-4 flex items-center justify-between sticky top-0 z-50 no-print">
                            <div className="flex items-center gap-3">
                                <div className="bg-indigo-600 p-2 rounded-lg text-white"><Icon name="GraduationCap" size={24}/></div>
                                <div><h1 className="font-black text-slate-800 dark:text-white text-lg leading-none">Гимназия №22</h1><p className="text-xs font-bold text-slate-400 uppercase">Публичное расписание</p></div>
                            </div>
                        </header>
                        <main className="flex-1 p-4 lg:p-8 overflow-auto"><SchedulePage readOnly={true} /></main>
                    </div>
                </ScheduleDataProvider>
            </StaticDataProvider>
        </DataProvider>
    );
};

export default function App() {
    return (
        <AuthProvider>
            <DataProvider> 
                <StaticDataProvider>
                    <ScheduleDataProvider>
                        <HashRouter>
                            <Routes>
                                <Route path="/login" element={<LoginPage />} />
                                <Route path="/" element={<ProtectedRoute><Layout /></ProtectedRoute>}>
                                    <Route index element={<HomeRedirect />} />
                                    
                                    {/* Dashboard: Доступно Admin и Teacher */}
                                    <Route path="dashboard" element={
                                        <ProtectedRoute allowedRoles={['admin', 'teacher']}>
                                            <DashboardPage />
                                        </ProtectedRoute>
                                    } />
                                    
                                    {/* Schedule: Доступно всем. readOnly, если не админ (1 полугодие) */}
                                    <Route path="schedule" element={
                                        <SchedulePageWrapper semester={1} />
                                    } />

                                    {/* Schedule 2: Доступно всем (2 полугодие) */}
                                    <Route path="schedule2" element={
                                        <SchedulePageWrapper semester={2} />
                                    } />
                                    
                                    {/* Остальные страницы: Только Admin */}
                                    <Route path="substitutions" element={<ProtectedRoute allowedRoles={['admin']}><SubstitutionsPage /></ProtectedRoute>} />
                                    <Route path="directory" element={<ProtectedRoute allowedRoles={['admin']}><DirectoryPage /></ProtectedRoute>} />
                                    <Route path="admin" element={<ProtectedRoute allowedRoles={['admin']}><AdminPage /></ProtectedRoute>} />
                                    <Route path="reports" element={<ProtectedRoute allowedRoles={['admin']}><ReportsPage /></ProtectedRoute>} />
                                    <Route path="export" element={<ProtectedRoute allowedRoles={['admin']}><ExportPage /></ProtectedRoute>} />
                                </Route>
                                <Route path="/public" element={<PublicLayout />} />
                            </Routes>
                        </HashRouter>
                    </ScheduleDataProvider>
                </StaticDataProvider>
            </DataProvider>
        </AuthProvider>
    );
}

// Вспомогательный компонент для передачи пропса readOnly
const SchedulePageWrapper = ({ semester = 1 }: { semester?: 1 | 2 }) => {
    const { role } = useAuth();
    // Редактировать может только админ
    return <SchedulePage readOnly={role !== 'admin'} semester={semester} />;
};
</file>

<file path="src/pages/Export.tsx">
import { useState, useRef, useMemo } from 'react';
import { useStaticData, useScheduleData } from '../context/DataContext';
import { Icon } from '../components/Icons';
import { dbService } from '../services/db'; 
import { DAYS, Shift, SHIFT_PERIODS, AppData } from '../types';
import { INITIAL_DATA } from '../constants';
import html2canvas from 'html2canvas';

import { QRCodeSVG } from 'qrcode.react';
import { Modal } from '../components/UI';

export const ExportPage = () => {
    const { subjects, teachers, classes, rooms, settings, bellSchedule, saveStaticData } = useStaticData();
    const { schedule1, schedule2, substitutions, saveScheduleData } = useScheduleData();

    const fileInputRef = useRef<HTMLInputElement>(null);
    const printRef = useRef<HTMLDivElement>(null);
    const [exportDate, setExportDate] = useState(new Date().toISOString().split('T')[0]);
    
    // Выбор полугодия для ручного экспорта (по умолчанию текущее)
    const [exportSemester, setExportSemester] = useState<1 | 2>(() => {
        const month = new Date().getMonth();
        return (month >= 0 && month <= 4) ? 2 : 1;
    });

    const [isGenerating, setIsGenerating] = useState(false);
    const [isPublishModalOpen, setIsPublishModalOpen] = useState(false);
    const [publicScheduleUrl, setPublicScheduleUrl] = useState('');
    const [publicScheduleId, setPublicScheduleId] = useState('');

    const fullAppData: AppData = useMemo(() => ({
        subjects, teachers, classes, rooms, settings, bellSchedule,
        schedule: schedule1,
        schedule2ndHalf: schedule2,
        substitutions
    }), [subjects, teachers, classes, rooms, settings, bellSchedule, schedule1, schedule2, substitutions]);

    // Получаем расписание для экспорта (Excel, Матрица) на основе селектора
    const getScheduleForExport = () => exportSemester === 2 ? schedule2 : schedule1;

    // Получаем расписание для PNG (Замены) на основе выбранной даты
    const getScheduleForDate = (date: string) => {
        const month = new Date(date).getMonth();
        return (month >= 0 && month <= 4) ? schedule2 : schedule1;
    };

    const handleImport = (e: any) => { 
        const file = e.target.files?.[0]; 
        if (!file) return; 
        const reader = new FileReader(); 
        reader.onload = async (ev: any) => { 
            try { 
                const json = JSON.parse(ev.target.result); 
                if (json.teachers && (json.schedule || json.schedule2ndHalf)) { 
                    if(window.confirm("Это перезапишет текущую базу данных. Продолжить?")) { 
                        const mergedData = {
                            ...INITIAL_DATA,
                            ...json,
                            rooms: json.rooms || INITIAL_DATA.rooms,
                            classes: json.classes || [],
                            schedule: json.schedule || [],
                            schedule2ndHalf: json.schedule2ndHalf || [],
                            teachers: json.teachers || [],
                            subjects: json.subjects || [],
                            substitutions: json.substitutions || [],
                            settings: { ...INITIAL_DATA.settings, ...json.settings }
                        };
                        await saveStaticData(mergedData as any);
                        await saveScheduleData(mergedData as any);
                        alert("База успешно восстановлена!"); 
                    } 
                } else alert("Неверный формат файла."); 
            } catch (err) { alert("Ошибка чтения файла."); } 
        }; 
        reader.readAsText(file); 
    };
    
    const exportStyledExcel = () => {
        const currentSchedule = getScheduleForExport();
        
        let html = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
            <head><meta charset="UTF-8"><style>
                table { border-collapse: collapse; width: 100%; font-family: Arial, sans-serif; }
                td, th { border: 1px solid #999; padding: 5px; vertical-align: top; }
                .header { background-color: #f3f4f6; font-weight: bold; text-align: center; }
                .class-cell { font-size: 14px; font-weight: bold; text-align: center; vertical-align: middle; }
                .subject { font-weight: bold; font-size: 11px; }
                .meta { font-size: 10px; color: #555; }
            </style></head><body><table>
        `;

        DAYS.forEach(day => {
            html += `<tr><td colspan="8" style="background-color:#4f46e5; color:white; font-size:16px; font-weight:bold; text-align:center;">${day}</td></tr>`;
            [Shift.First, Shift.Second].forEach(shift => {
                const filteredClasses = classes.filter(c => c.shift === shift);
                if (filteredClasses.length === 0) return;
                
                html += `<tr><td colspan="8" style="background-color:#e0e7ff; font-weight:bold;">${shift}</td></tr>`;
                html += `<tr><th class="header">Класс</th>`;
                SHIFT_PERIODS[shift].forEach(p => html += `<th class="header">${p} урок</th>`);
                html += `</tr>`;

                filteredClasses.forEach(c => {
                    html += `<tr><td class="class-cell">${c.name}</td>`;
                    SHIFT_PERIODS[shift].forEach(p => {
                        const items = currentSchedule.filter(s => s.classId === c.id && s.day === day && s.shift === shift && s.period === p);
                        html += `<td style="height: 60px;">`;
                        items.forEach(item => {
                            const sub = subjects.find(s => s.id === item.subjectId);
                            const teach = teachers.find(t => t.id === item.teacherId);
                            const room = rooms.find(r => r.id === item.roomId);
                            const roomName = room ? room.name : item.roomId;
                            html += `<div style="background-color: ${sub?.color || '#fff'}; padding: 2px; margin-bottom: 2px; border: 1px solid #eee;">
                                <div class="subject">${sub?.name || ''} ${item.direction || ''}</div>
                                <div class="meta">${teach?.name || ''} ${roomName ? `(Каб. ${roomName})` : ''}</div>
                            </div>`;
                        });
                        html += `</td>`;
                    });
                    html += `</tr>`;
                });
            });
        });
        
        html += `</table></body></html>`;
        const blob = new Blob([html], { type: "application/vnd.ms-excel" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `Расписание_Гимназия22_${exportSemester}пол.xls`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    const exportMatrixExcel = () => {
        const currentSchedule = getScheduleForExport();
        let html = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
            <head><meta charset="UTF-8"><style>
                table { border-collapse: collapse; font-family: Arial, sans-serif; font-size: 12px; margin-bottom: 20px; }
                td, th { border: 1px solid #000; padding: 2px; vertical-align: middle; text-align: center; }
                .header { font-weight: bold; background-color: #f3f4f6; }
                .subject-cell { font-weight: bold; vertical-align: middle; background-color: #fff; }
                .teacher-cell { text-align: left; padding-left: 5px; }
                sub { font-size: 9px; vertical-align: sub; }
            </style></head><body>
        `;

        [Shift.First, Shift.Second].forEach(shift => {
            const periods = SHIFT_PERIODS[shift];
            
            html += `<table>`;
            html += `<tr>
                <th rowspan="3" class="header" style="border: 2px solid #000; width: 150px;">Учебный предмет</th>
                <th rowspan="3" class="header" style="border: 2px solid #000; width: 200px;">ФИО</th>
                <th colspan="${DAYS.length * periods.length}" class="header" style="border: 2px solid #000; font-size: 14px;">День недели</th>
            </tr>`;

            html += `<tr>`;
            DAYS.forEach(day => {
                html += `<th colspan="${periods.length}" class="header" style="border: 2px solid #000;">${day}</th>`;
            });
            html += `</tr>`;

            html += `<tr>`;
            DAYS.forEach(() => {
                periods.forEach(p => html += `<th class="header" style="border-bottom: 2px solid #000;">Урок</th>`);
            });
            html += `</tr>`;
            
            html += `<tr>
                <th class="header" style="border: 2px solid #000; background-color: #e0e7ff;">${shift}</th>
                <th class="header" style="border: 2px solid #000;"></th>
            `;
            DAYS.forEach(() => {
                periods.forEach(p => html += `<th class="header" style="width: 40px;">${p}</th>`);
            });
            html += `</tr>`;

            subjects.forEach(subject => {
                const filteredTeachers = teachers.filter(t => t.subjectIds.includes(subject.id));
                if (filteredTeachers.length === 0) return;

                const subjectColor = subject.color || '#ffffff';

                filteredTeachers.forEach((teacher, tIndex) => {
                    html += `<tr>`;
                    if (tIndex === 0) {
                        html += `<td rowspan="${filteredTeachers.length}" class="subject-cell" style="border: 2px solid #000; background-color: ${subjectColor};">${subject.name}</td>`;
                    }
                    html += `<td class="teacher-cell" style="border-right: 2px solid #000;">${teacher.name}</td>`;

                    DAYS.forEach(day => {
                        periods.forEach(p => {
                            const item = currentSchedule.find(s => 
                                s.teacherId === teacher.id && 
                                s.subjectId === subject.id && 
                                s.day === day && 
                                s.period === p &&
                                s.shift === shift
                            );

                            if (item) {
                                const cls = classes.find(c => c.id === item.classId);
                                const r = rooms.find(rm => rm.id === item.roomId);
                                const roomName = r ? r.name : item.roomId;
                                const room = roomName ? `<sub>${roomName}</sub>` : '';
                                const dir = item.direction ? ` <span style="font-size:9px">(${item.direction})</span>` : '';
                                const bgColor = subject.color || '#ffffff';
                                html += `<td style="border: 1px solid #000; font-weight: bold; background-color: ${bgColor};">${cls ? cls.name : ''}${dir}${room}</td>`;
                            } else {
                                html += `<td style="border: 1px solid #000;"></td>`;
                            }
                        });
                    });
                    html += `</tr>`;
                });
                html += `<tr><td colspan="${2 + DAYS.length * periods.length}" style="height: 2px; background-color: #000;"></td></tr>`;
            });
            html += `</table><br/><br/>`;
        });

        html += `</body></html>`;
        const blob = new Blob([html], { type: "application/vnd.ms-excel" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `Матрица_Расписания_${exportSemester}пол.xls`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    const copyForGoogleSheets = () => {
        const currentSchedule = getScheduleForExport();
        let tsv = "День\tСмена\tКласс\tУрок\tПредмет\tУчитель\tКабинет\tГруппа\n";
        DAYS.forEach(day => {
            [Shift.First, Shift.Second].forEach(shift => {
                const filteredClasses = classes.filter(c => c.shift === shift);
                filteredClasses.forEach(cls => {
                    SHIFT_PERIODS[shift].forEach(period => {
                        const items = currentSchedule.filter(s => s.classId === cls.id && s.day === day && s.shift === shift && s.period === period);
                        items.forEach(item => {
                            const sub = subjects.find(s => s.id === item.subjectId);
                            const teach = teachers.find(t => t.id === item.teacherId);
                            const r = rooms.find(rm => rm.id === item.roomId);
                            const roomName = r ? r.name : (item.roomId || '');
                            tsv += `${day}\t${shift}\t${cls.name}\t${period}\t${sub?.name || ''}\t${teach?.name || ''}\t${roomName}\t${item.direction || ''}\n`;
                        });
                    });
                });
            });
        });
        navigator.clipboard.writeText(tsv).then(() => {
            alert("Данные скопированы! Откройте Google Sheets и нажмите Ctrl+V (Cmd+V).");
        });
    };

    const handleDownloadPng = async () => { 
        if (!printRef.current) return; 
        setIsGenerating(true); 
        try { 
            const canvas = await html2canvas(printRef.current, { scale: 2, backgroundColor: '#ffffff', logging: false }); 
            const link = document.createElement('a'); 
            link.download = `Замены_${exportDate}.png`; 
            link.href = canvas.toDataURL('image/png'); 
            link.click(); 
        } catch (e) { console.error(e); alert("Ошибка при создании изображения"); } 
        setIsGenerating(false); 
    };

    const subsForDate = useMemo(() => substitutions.filter(s => s.date === exportDate), [substitutions, exportDate]);
    
    const renderTableForShift = (shift: string) => {
        const currentSchedule = getScheduleForDate(exportDate);

        const shiftSubs = subsForDate.filter(sub => {
            const s = currentSchedule.find(x => x.id === sub.scheduleItemId);
            return s && s.shift === shift;
        }).filter(sub => sub.replacementTeacherId !== 'conducted');
        
        if (shiftSubs.length === 0) return null;

        return (
            <div className="mb-8">
                <div className="text-xl font-bold bg-slate-100 text-slate-700 p-2 mb-2 uppercase tracking-wide border-l-4 border-indigo-500">{shift}</div>
                <table className="w-full text-left border-collapse">
                    <thead>
                        <tr className="border-b border-slate-200">
                            <th className="py-3 px-2 font-black text-slate-400 text-xs uppercase tracking-wider w-16 text-center">Урок</th>
                            <th className="py-3 px-2 font-black text-slate-400 text-xs uppercase tracking-wider w-24">Класс</th>
                            <th className="py-3 px-2 font-black text-slate-400 text-xs uppercase tracking-wider">Предмет</th>
                            <th className="py-3 px-2 font-black text-slate-400 text-xs uppercase tracking-wider w-1/4">Отсутствует</th>
                            <th className="py-3 px-2 font-black text-slate-400 text-xs uppercase tracking-wider w-1/4">Заменяет</th>
                            <th className="py-3 px-2 font-black text-slate-400 text-xs uppercase tracking-wider w-20 text-right">Каб.</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                        {shiftSubs.map(sub => { 
                            const s: any = currentSchedule.find(x => x.id === sub.scheduleItemId); 
                            if (!s) return null;
                            const cls = classes.find(c => c.id === s.classId); 
                            const subj = subjects.find(x => x.id === s.subjectId); 
                            const t1: any = teachers.find(t => t.id === sub.originalTeacherId); 
                            
                            const newRoomId = sub.replacementRoomId;
                            const oldRoomObj = s.roomId ? rooms.find(r => r.id === s.roomId) : null;
                            const oldRoomName = oldRoomObj ? oldRoomObj.name : (s.roomId || '—');
                            const newRoomObj = newRoomId ? rooms.find(r => r.id === newRoomId) : null;
                            const newRoomName = newRoomObj ? newRoomObj.name : (newRoomId || '—');
                            
                            const isCancelled = sub.replacementTeacherId === 'cancelled';
                            const t2 = isCancelled ? { name: 'УРОК СНЯТ' } : teachers.find(t => t.id === sub.replacementTeacherId); 
                            
                            const dayReason = t1?.absenceReasons?.[exportDate];
                            const lessonReason = sub.lessonAbsenceReason;
                            // Only display if the reason is explicitly 'Без записи'. 
                            // Prioritize lesson reason if it exists and is 'Без записи', otherwise fall back to day reason if 'Без записи'.
                            const displayReason = (lessonReason === 'Без записи') ? lessonReason : ((dayReason === 'Без записи') ? dayReason : '');
                            
                            const isRoomChangeOnly = sub.replacementTeacherId === sub.originalTeacherId && newRoomId;

                            return (
                                <tr key={sub.id}>
                                    <td className="py-3 px-2 text-center font-bold text-slate-800 text-lg">{s.period}</td>
                                    <td className="py-3 px-2 font-bold text-slate-700">{cls?.name}</td>
                                    <td className="py-3 px-2"><div className="font-semibold text-slate-800">{subj?.name}</div>{s.direction && <div className="text-[10px] text-slate-500 bg-slate-100 inline-block px-1 rounded mt-0.5">{s.direction}</div>}</td>
                                    <td className="py-3 px-2">
                                        {!isRoomChangeOnly && (
                                            <>
                                                {/* FIX: Use relative div with absolute line for reliable strikethrough in html2canvas */}
                                                <div className="relative inline-block text-red-400 text-sm font-medium">
                                                    {t1?.name}
                                                    {/* Adjusted top position to fix html2canvas rendering issue where line appears too high. top-[60%] pushes it down. */}
                                                    <div className="absolute left-0 top-[85%] w-full h-px bg-red-300"></div>
                                                </div>
                                                {displayReason && <span className="text-[10px] text-slate-500 block font-bold uppercase mt-0.5">{displayReason}</span>}
                                            </>
                                        )}
                                    </td>
                                    <td className={`py-3 px-2 font-bold text-sm ${isCancelled ? 'text-red-600 uppercase font-black' : 'text-emerald-700'}`}>
                                        {isRoomChangeOnly ? (
                                            <div className="flex flex-col">
                                                <span className="text-slate-800">{t1?.name}</span>
                                                <span className="text-[10px] text-indigo-600 font-bold uppercase tracking-wide mt-0.5">Смена кабинета</span>
                                            </div>
                                        ) : (
                                            <div className="flex flex-col">
                                                <span>{t2?.name}</span>
                                                {sub.isMerger && <span className="text-[9px] font-black text-purple-600 uppercase tracking-widest mt-0.5">ОБЪЕДИНЕНИЕ</span>}
                                            </div>
                                        )}
                                    </td>
                                    <td className={`py-3 px-2 text-right font-mono font-black ${newRoomId ? 'text-indigo-600' : 'text-slate-700'}`}>
                                        {newRoomId && newRoomId !== s.roomId ? (
                                            <div className="flex items-center justify-end gap-2 text-xl whitespace-nowrap">
                                                {/* Re-applying room change styles as requested in previous turns, ensuring font-black and text-xl */}
                                                <span className="text-slate-400 decoration-4 text-xl">{oldRoomName}</span>
                                                <span className="text-indigo-600 font-black text-2xl">&rarr;</span>
                                                <span className="text-indigo-600 font-black text-2xl">{newRoomName}</span>
                                            </div>
                                        ) : <span className="text-xl">{oldRoomName}</span>}
                                    </td>
                                </tr>
                            ) 
                        })}
                    </tbody>
                </table>
            </div>
        );
    };

    const handlePublishSchedule = async () => {
        const newPublicId = Math.random().toString(36).substr(2, 9);
        await dbService.setPublicData(newPublicId, fullAppData);
        
        await saveStaticData({ settings: { ...settings, publicScheduleId: newPublicId } });

        const publicUrl = `${window.location.origin}${window.location.pathname}#/public?id=${newPublicId}`;
        setPublicScheduleUrl(publicUrl);
        setPublicScheduleId(newPublicId);
        setIsPublishModalOpen(true);
    };

    const clearPublicSchedule = async () => {
        if (!settings.publicScheduleId || !window.confirm('Вы уверены, что хотите удалить публичное расписание? Оно станет недоступно по текущей ссылке.')) {
            return;
        }
        await dbService.deletePublicData(settings.publicScheduleId);
        await saveStaticData({ settings: { ...settings, publicScheduleId: null } });
        alert('Публичное расписание удалено.');
        setPublicScheduleUrl('');
        setPublicScheduleId('');
    };
    
    return (
        <div className="max-w-5xl mx-auto space-y-8 pb-20">
            <section className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                    <Icon name="Download" className="text-indigo-600 dark:text-indigo-400"/> Резервное копирование
                </h2>
                <div className="flex flex-wrap gap-4">
                    <button onClick={() => dbService.exportJson(fullAppData)} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 dark:shadow-none flex items-center gap-2">
                        <Icon name="Download" size={20}/> Скачать JSON
                    </button>
                    <div className="relative">
                        <input type="file" ref={fileInputRef} onChange={handleImport} accept=".json" className="hidden" />
                        <button onClick={() => fileInputRef.current?.click()} className="px-6 py-3 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 rounded-xl font-bold hover:bg-slate-50 dark:hover:bg-slate-600 transition flex items-center gap-2">
                            <Icon name="Upload" size={20}/> Загрузить JSON
                        </button>
                    </div>
                </div>
            </section>

            <section className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                <div className="flex flex-col sm:flex-row justify-between items-center gap-6 mb-6">
                    <div>
                        <h2 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <Icon name="Image" className="text-indigo-600 dark:text-indigo-400"/> Экспорт замен (PNG)
                        </h2>
                        <p className="text-slate-500 dark:text-slate-400 text-center">Общее расписание можно экспортировать через меню "Расписание" &rarr; "Печать" на самой странице расписания.</p>
                    </div>
                    <div className="flex gap-4 items-center">
                        <input type="date" value={exportDate} onChange={e => setExportDate(e.target.value)} className="border border-slate-200 dark:border-slate-600 p-2 rounded-lg font-bold outline-none focus:border-indigo-500 bg-transparent dark:text-white"/>
                        <button onClick={handleDownloadPng} disabled={isGenerating} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 dark:shadow-none flex items-center gap-2 disabled:opacity-50">
                            {isGenerating ? <><Icon name="Loader" size={20} className="animate-spin"/> Создание...</> : <><Icon name="Download" size={20}/> Скачать PNG</>}
                        </button>
                    </div>
                </div>
                <div className="overflow-auto bg-slate-100 dark:bg-slate-900 p-8 rounded-xl border border-slate-200 dark:border-slate-700 flex justify-center">
                    <div ref={printRef} className="bg-white p-8 min-w-[800px] max-w-[1000px] shadow-xl text-slate-900">
                        <div className="flex justify-between items-end border-b-2 border-slate-800 pb-4 mb-6">
                            <div>
                                <h1 className="text-3xl font-black uppercase tracking-tight mb-1 text-slate-800">Замена Учителей</h1>
                                <p className="text-sm font-bold text-slate-500 uppercase tracking-wider">Гимназия • Официальный документ</p>
                            </div>
                            <div className="text-right">
                                <div className="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">Дата</div>
                                <div className="text-xl font-bold text-slate-800">{new Date(exportDate).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' })}</div>
                            </div>
                        </div>
                        {subsForDate.length === 0 ? (
                            <div className="py-12 text-center border-2 border-dashed border-slate-200 rounded-xl bg-slate-50">
                                <p className="text-slate-400 font-medium italic">Замен на этот день нет</p>
                            </div>
                        ) : (
                            <>
                                {renderTableForShift(Shift.First)}
                                {renderTableForShift(Shift.Second)}
                            </>
                        )}
                        <div className="mt-8 pt-4 border-t border-slate-100 flex justify-between items-end text-[10px] text-slate-400">
                            <div>Сформировано автоматически</div>
                            <div className="flex flex-col items-end gap-2">
                                <div className="h-px w-32 bg-slate-300"></div>
                                <div>Подпись администрации</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                    <Icon name="FileSpreadsheet" className="text-emerald-600 dark:text-emerald-400"/> Экспорт данных
                </h2>
                <div className="flex flex-wrap gap-4 items-center">
                    <div className="flex items-center gap-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl p-1.5 pl-3">
                        <span className="text-xs font-bold text-slate-500 dark:text-slate-400">Полугодие:</span>
                        <select
                            value={exportSemester}
                            onChange={(e) => setExportSemester(Number(e.target.value) as 1 | 2)}
                            className="bg-transparent text-sm font-bold text-slate-700 dark:text-slate-200 outline-none cursor-pointer"
                        >
                            <option value={1}>1-е (Сен-Дек)</option>
                            <option value={2}>2-е (Янв-Май)</option>
                        </select>
                    </div>
                    <button onClick={exportStyledExcel} className="px-6 py-3 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 border border-emerald-100 dark:border-emerald-900 rounded-xl font-bold hover:bg-emerald-100 dark:hover:bg-emerald-900/50 transition flex items-center gap-2">
                        <Icon name="FileSpreadsheet" size={20}/> Скачать Excel (XLS)
                    </button>
                    <button onClick={exportMatrixExcel} className="px-6 py-3 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 border border-blue-100 dark:border-blue-900 rounded-xl font-bold hover:bg-blue-100 dark:hover:bg-blue-900/50 transition flex items-center gap-2">
                        <Icon name="Table" size={20}/> Скачать Матрицу (XLS)
                    </button>
                    <button onClick={copyForGoogleSheets} className="px-6 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition shadow-lg shadow-green-200 dark:shadow-none flex items-center gap-2">
                        <Icon name="Clipboard" size={20}/> Копировать для Google Sheets
                    </button>
                </div>
            </section>

            <section className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                    <Icon name="QrCode" className="text-purple-600 dark:text-purple-400"/> Публичное расписание
                </h2>
                <p className="text-sm text-slate-500 dark:text-slate-400 mb-4">
                    Опубликуйте актуальное расписание для учеников и родителей. Будет сгенерирована уникальная ссылка с QR-кодом.
                </p>
                {settings.publicScheduleId ? (
                    <div className="flex flex-col md:flex-row items-center gap-4">
                        <div className="flex-1">
                            <p className="text-sm font-bold text-slate-600 dark:text-slate-300 mb-2">
                                Расписание опубликовано! ID: <span className="font-mono bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded">{settings.publicScheduleId}</span>
                            </p>
                            <button onClick={() => setIsPublishModalOpen(true)} className="px-4 py-2 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition flex items-center gap-2">
                                <Icon name="Share2" size={16}/> Показать QR-код и ссылку
                            </button>
                            <button onClick={clearPublicSchedule} className="ml-3 px-4 py-2 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-400 border border-red-100 dark:border-red-900 rounded-xl font-bold hover:bg-red-100 dark:hover:bg-red-900/50 transition flex items-center gap-2">
                                <Icon name="Trash2" size={16}/> Отменить публикацию
                            </button>
                        </div>
                    </div>
                ) : (
                    <button onClick={handlePublishSchedule} disabled={isGenerating} className="px-6 py-3 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition shadow-lg shadow-purple-200 dark:shadow-none flex items-center gap-2 disabled:opacity-50">
                        <Icon name="Share2" size={20}/> Опубликовать расписание
                    </button>
                )}
            </section>

            <Modal isOpen={isPublishModalOpen} onClose={() => setIsPublishModalOpen(false)} title="Публичное расписание">
                <div className="flex flex-col items-center justify-center p-4 text-center space-y-4">
                    <p className="text-sm text-slate-600 dark:text-slate-300">
                        Отсканируйте QR-код или перейдите по ссылке, чтобы увидеть публичное расписание.
                    </p>
                    {publicScheduleUrl && (
                        <>
                            <QRCodeSVG value={publicScheduleUrl} size={256} level="H" includeMargin={true} className="p-2 bg-white border border-slate-200 rounded-lg shadow-md" />
                            <a href={publicScheduleUrl} target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:underline text-sm font-medium break-all">
                                {publicScheduleUrl}
                            </a>
                            <button onClick={() => navigator.clipboard.writeText(publicScheduleUrl)} className="px-4 py-2 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 rounded-xl text-sm font-bold hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition flex items-center gap-2">
                                <Icon name="Copy" size={16}/> Копировать ссылку
                            </button>
                        </>
                    )}
                </div>
            </Modal>
        </div>
    );
};
</file>

</files>
